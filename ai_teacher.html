<meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Teacher - Practice Zone</title>
    
    <!-- PWA Manifest & Service Worker (for cache) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script type="module">
        // --- Firebase/Canvas Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;

        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug'); 

                    // Authentication
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            userId = crypto.randomUUID();
                        }
                        window.app.db = db;
                        window.app.userId = userId;
                        window.app.initApp(); 
                    });

                } else {
                    console.error("Firebase config is missing. App will run in mock mode.");
                    window.app.initApp();
                }
            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                window.app.initApp();
            }
        };

        window.app = {
            db: null,
            userId: null,
            appId: appId,
            initFirebase: initFirebase,
            initApp: () => { console.log("App initialization started (Mock/Real)."); } 
        };

        initFirebase();
    </script>

    <!-- CUSTOM STYLES & THEMING (COPIED/ADAPTED FROM YOUR PWA FILES) -->
    <style>
        /* Import all available fonts for customization */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:wght@700&family=Roboto:wght@400;700&family=Merriweather:wght==400;700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&family=Source+Sans+3:wght@400;700&family=Noto+Sans+Telugu:wght@400;700&display=swap');
        
        /* --- CSS Variables for Theme Management --- */
        
        :root {
            --font-body: 'Inter', sans-serif;
            --font-title: 'Lora', serif;
            --input-border-radius: 1.5rem; 
            --input-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            --text-color-light: #111827; 
            --text-color-dark: #f3f4f6; 
        }
        
        /* Default: Indigo */
        :root, body[data-color="indigo"] {
            --color-primary: 79, 70, 229; --color-primary-hex: #4f46e5;
            --color-primary-light: 165, 180, 252; 
            --color-bg-light-start: #a78bfa; --color-bg-light-mid: #818cf8; --color-bg-light-end: #3b82f6;
            --color-bg-dark-start: #1f2937; --color-bg-dark-mid: #111827; --color-bg-dark-end: #0f172a;
        }
        /* Teal Theme */
        body[data-color="teal"] {
            --color-primary: 20, 184, 166; --color-primary-hex: #14b8a6;
            --color-primary-light: 94, 234, 212; 
            --color-bg-light-start: #2dd4bf; --color-bg-light-mid: #5eead4; --color-bg-light-end: #0d9488;
        }
        /* Rose Theme */
        body[data-color="rose"] {
            --color-primary: 225, 29, 72; --color-primary-hex: #e11d48;
            --color-primary-light: 251, 207, 232; 
            --color-bg-light-start: #fda4af; --color-bg-light-mid: #f43f5e; --color-bg-light-end: #e11d48;
        }
        /* Amber Theme */
        body[data-color="amber"] {
            --color-primary: 245, 158, 11; --color-primary-hex: #f59e0b;
            --color-primary-light: 253, 230, 138; 
            --color-bg-light-start: #fcd34d; --color-bg-light-mid: #f59e0b; --color-bg-light-end: #fbbf24;
        }
        /* Emerald Theme */
        body[data-color="emerald"] {
            --color-primary: 5, 150, 105; --color-primary-hex: #059669;
            --color-primary-light: 110, 231, 183; 
            --color-bg-light-start: #34d399; --color-bg-light-mid: #10b981; --color-bg-light-end: #059669;
        }
        
        /* --- Base Styles --- */
        body {
            font-family: var(--font-body);
            min-height: 100vh;
            color: var(--text-color-light); 
            background: linear-gradient(135deg, var(--color-bg-light-start), var(--color-bg-light-mid), var(--color-bg-light-end));
            padding-bottom: 4rem; 
        }
        
        .elegant-title {
            font-family: var(--font-title); 
            font-weight: 700;
            letter-spacing: 0.05em; 
            color: #1e293b;
        }

        /* Main Glass Card (COPIED) */
        .liquid-glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(var(--color-primary-light), 0.35));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: all 0.3s ease;
        }

        /* Frosted Option Card */
        .frosted-option {
            background: rgba(255, 255, 255, 0.5); /* Lighter background for better contrast */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease, transform 0.1s ease;
        }
        
        .text-primary { color: var(--color-primary-hex); }
        .border-primary { border-color: var(--color-primary-hex); }
        .bg-primary { background-color: var(--color-primary-hex); }
        .shadow-primary { box-shadow: 0 10px 15px -3px rgba(var(--color-primary), 0.2), 0 4px 6px -4px rgba(var(--color-primary), 0.1); }
        
        input[type="text"], textarea {
            font-family: var(--font-body);
            background-color: rgba(255, 255, 255, 0.5) !important;
            border: 1px solid rgba(156, 163, 175, 0.3);
            color: var(--text-color-light) !important;
            transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.3s ease;
            
            border-radius: var(--input-border-radius); 
            box-shadow: var(--input-shadow);
        }

        /* Nav Bar Styles */
        .nav-button {
            transition: all 0.3s ease;
            color: #4b5563; /* Gray 600 */
        }
        .nav-button.active {
            color: var(--color-primary-hex); 
            background-color: rgba(var(--color-primary-light), 0.2);
            /* bottom border highlight */
            box-shadow: 0 -3px 0 0 var(--color-primary-hex) inset;
        }

        /* Active View Style */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        
        /* Chat Specific Styles */
        .chat-container {
            border: 2px solid var(--color-primary-hex);
            border-radius: 1rem;
            height: 60vh; /* Reduced height for better mobile layout */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-box {
            flex-grow: 1;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.7);
        }
        .chat-user-message {
            background-color: rgba(var(--color-primary-light), 0.5); 
            align-self: flex-end;
            border-radius: 12px 12px 0 12px;
            max-width: 85%;
        }
        .chat-ai-message {
            background-color: #f3f4f6; /* Near white/light gray */
            align-self: flex-start;
            border-radius: 12px 12px 12px 0;
            max-width: 90%;
            border-left: 3px solid var(--color-primary-hex);
        }
        .ai-feedback {
            font-size: 0.9rem;
            font-style: italic;
            color: #10b981; /* Green 600 */
            border-top: 1px solid #d1d5db;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            display: block;
        }
        .telugu-tip {
             font-size: 0.75rem;
             color: #4f46e5; /* Indigo 600 */
             display: block;
             margin-top: 0.2rem;
             font-weight: 500;
        }
        
        /* Progress Bar Animation */
        #progress-bar-home {
            transition: width 0.5s ease-in-out; /* Added animation */
        }

        /* --- Liquid Glass Ripple Effect (COPIED) --- */
        .ripple-btn {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0); 
            z-index: 1;
        }

        .ripple-btn::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.4) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.6s, opacity 0.8s;
            border-radius: inherit; 
            z-index: -1;
        }

        .ripple-btn:active::after {
            transform: scale(0, 0);
            opacity: 1;
            transition: 0s;
        }

        /* --- Dark Mode Styles (COPIED) --- */
        .dark-mode {
            background: linear-gradient(135deg, var(--color-bg-dark-start), var(--color-bg-dark-mid), var(--color-bg-dark-end)); 
            color: var(--text-color-dark);
        }
        .dark-mode .liquid-glass-card {
            background: linear-gradient(135deg, rgba(55, 65, 81, 0.4), rgba(31, 41, 55, 0.5));
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); 
        }
        .dark-mode .elegant-title { color: #ffffff; }
        .dark-mode .frosted-option {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(107, 114, 128, 0.4);
        }
        
        .dark-mode input[type="text"], .dark-mode textarea {
            background-color: rgba(31, 41, 55, 0.6) !important;
            color: var(--text-color-dark) !important; 
            border-color: rgba(107, 114, 128, 0.4);
        }
        .dark-mode .chat-box {
             background-color: rgba(31, 41, 55, 0.9);
        }
        .dark-mode .chat-ai-message {
            background-color: #1f2937; 
            border-left: 3px solid var(--color-primary-hex);
        }
        .dark-mode .chat-user-message {
            background-color: rgba(var(--color-primary-light), 0.1); 
        }
        
        .dark-mode .nav-button { color: #d1d5db; }
        .dark-mode .nav-button.active {
            color: var(--color-primary-hex); 
            background-color: rgba(var(--color-primary-light), 0.1);
        }
        .dark-mode .ai-feedback { color: #34d399; }
        .dark-mode .telugu-tip { color: #a78bfa; }

        /* --- Custom Language Font --- */
        .telugu-text {
            font-family: 'Noto Sans Telugu', sans-serif;
        }
        /* Home page card enhancements */
        .home-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-radius: 1.5rem;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.7), rgba(var(--color-primary-light), 0.2));
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .dark-mode .home-card {
            background: linear-gradient(145deg, rgba(31, 41, 55, 0.8), rgba(55, 65, 81, 0.5));
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div id="app-container" class="w-full max-w-xl liquid-glass-card p-4 md:p-6 my-4">
        
        <!-- Header, Title, and Score -->
        <div class="flex justify-between items-center mb-4 border-b-2 pb-2 border-primary">
            <h1 class="text-2xl font-bold text-gray-900 dark-mode:text-gray-50 mb-0 elegant-title">
                AI English Teacher
            </h1>
            <div class="text-right">
                <span class="text-sm font-semibold text-gray-600 dark-mode:text-gray-400">స్కోర్: </span>
                <span id="userScore" class="text-xl font-bold text-primary">0</span>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="flex justify-around border-b border-gray-300 dark-mode:border-gray-700 mb-4">
            <button data-view="home" class="nav-button active p-3 flex-1 text-sm font-bold ripple-btn telugu-text">హోమ్</button>
            <button data-view="lessons" class="nav-button p-3 flex-1 text-sm font-bold ripple-btn telugu-text">పాఠాలు</button>
            <button data-view="quiz" class="nav-button p-3 flex-1 text-sm font-bold ripple-btn telugu-text">క్విజ్</button>
            <button data-view="practice" class="nav-button p-3 flex-1 text-sm font-bold ripple-btn telugu-text">ప్రాక్టీస్ (AI)</button>
        </div>

        <!-- --- VIEW: HOME (Word of the Day / Progress) --- -->
        <div id="view-home" class="view active space-y-4">
            <h2 class="text-2xl font-bold text-gray-800 dark-mode:text-gray-200 elegant-title mb-4 telugu-text">స్మార్ట్ హోమ్</h2>

            <!-- Word of the Day CARD -->
            <div class="home-card bg-indigo-100 dark-mode:bg-indigo-900/40">
                <div class="flex-grow">
                    <h3 class="text-lg font-bold text-primary mb-1 telugu-text">రోజు మాట (Word of the Day)</h3>
                    <p id="daily-word-en" class="text-3xl font-extrabold text-gray-900 dark-mode:text-white mb-1">Enthusiastic</p>
                    <p id="daily-word-te" class="text-sm telugu-text text-gray-700 dark-mode:text-gray-300">ఉత్సాహంగా</p>
                </div>
                <button onclick="window.speakDailyWord()" class="ripple-btn p-3 bg-primary text-white rounded-full shadow-lg shadow-primary/50 hover:opacity-90 transition duration-150" aria-label="Speak word">
                     <!-- Speaker icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11v2m-5-2v2m-2-2v2m-2-2v2m-4-2h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
            
            <!-- Progress Tracker CARD -->
            <div class="home-card bg-green-100 dark-mode:bg-green-900/40">
                 <div class="flex-grow">
                    <h3 class="text-lg font-bold text-gray-800 dark-mode:text-gray-200 telugu-text mb-2">నా పురోగతి</h3>
                    <p id="progress-level" class="text-xl font-extrabold text-primary telugu-text">స్థాయి: <span class="text-green-600 dark-mode:text-green-400">Beginner</span></p>
                    <div class="w-full h-3 bg-gray-300 dark-mode:bg-gray-600 rounded-full mt-2 overflow-hidden">
                        <div id="progress-bar-home" class="h-full rounded-full bg-primary" style="width: 25%;"></div>
                    </div>
                    <p id="progress-score" class="text-xs text-left mt-1 text-gray-600 dark-mode:text-gray-400">0 పాయింట్లు (25% to next level)</p>
                 </div>
                 <div class="text-4xl text-green-600 dark-mode:text-green-400 font-bold">
                    🥇
                 </div>
            </div>

            <!-- Quick Access Cards -->
            <div class="grid grid-cols-2 gap-4">
                 <div class="frosted-option p-4 rounded-xl shadow-md border-primary/20 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">🧠</span>
                    <h4 class="font-bold text-gray-800 dark-mode:text-gray-200 telugu-text">క్విజ్</h4>
                    <p class="text-xs text-gray-600 dark-mode:text-gray-400 telugu-text">పదజాలం టెస్ట్</p>
                    <!-- FIXED: Added onclick to the button for proper behavior -->
                    <button onclick="window.changeView('quiz')" class="ripple-btn mt-2 text-sm text-primary font-bold">Start</button>
                 </div>
                 <div class="frosted-option p-4 rounded-xl shadow-md border-primary/20 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">🎭</span>
                    <h4 class="font-bold text-gray-800 dark-mode:text-gray-200 telugu-text">రోల్-ప్లే</h4>
                    <p class="text-xs text-gray-600 dark-mode:text-gray-400 telugu-text">సంభాషణ ప్రాక్టీస్</p>
                    <!-- FIXED: Added onclick to the button for proper behavior -->
                    <button onclick="window.startRolePlay('restaurant')" class="ripple-btn mt-2 text-sm text-primary font-bold">Start</button>
                 </div>
            </div>

        </div>

        <!-- --- VIEW: LESSONS (Daily Lessons) --- -->
        <div id="view-lessons" class="view space-y-4">
            <h2 class="text-xl font-bold text-primary elegant-title telugu-text">దినసరి పాఠాలు</h2>
            <div class="text-sm text-gray-600 dark-mode:text-gray-400 p-2 telugu-text">
                <p>ప్రతి రోజు కొత్త పాఠాలు ఇక్కడ అప్‌డేట్ అవుతాయి.</p>
            </div>

            <div class="frosted-option p-4 rounded-xl space-y-3">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl text-green-500">📝</span>
                    <h3 class="text-lg font-bold text-gray-800 dark-mode:text-gray-200">పాఠం 1: ప్రాథమిక శుభాకాంక్షలు</h3>
                </div>
                <p class="text-sm text-gray-700 dark-mode:text-gray-300">"Hello," "How are you," మరియు "Thank you" లను ఇంగ్లీష్‌లో నేర్చుకోండి.</p>
                <button onclick="window.startLesson()" class="play-button ripple-btn bg-green-600 hover:bg-green-700 shadow-green-500/50 w-full py-2 text-white font-bold telugu-text">
                    పాఠం ప్రారంభించండి
                </button>
            </div>
             <div class="frosted-option p-4 rounded-xl space-y-3">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl text-yellow-500">🗓️</span>
                    <h3 class="text-lg font-bold text-gray-800 dark-mode:text-gray-200">పాఠం 2: వారపు రోజులు</h3>
                </div>
                <p class="text-sm text-gray-700 dark-mode:text-gray-300">వారపు రోజులు మరియు సాధారణ సమయ పదబంధాలను ప్రాక్టీస్ చేయండి.</p>
                <button onclick="window.startLesson()" class="play-button ripple-btn bg-yellow-600 hover:bg-yellow-700 shadow-yellow-500/50 w-full py-2 text-white font-bold telugu-text">
                    పాఠం ప్రారంభించండి
                </button>
            </div>
        </div>

        <!-- --- VIEW: QUIZ (Interactive Quiz / Translation Practice) --- -->
        <div id="view-quiz" class="view space-y-4">
            <h2 class="text-xl font-bold text-primary elegant-title telugu-text">ఇంటరాక్టివ్ క్విజ్ ఛాలెంజ్</h2>

            <!-- 1000 Question Interactive Quiz (MCQ) -->
            <div id="interactive-quiz-card" class="frosted-option p-4 rounded-xl shadow-md border-primary/20">
                <h3 class="text-lg font-bold text-gray-800 dark-mode:text-gray-200 mb-3 telugu-text">దినసరి క్విజ్</h3>
                
                <p id="quiz-counter" class="text-xs text-gray-500 dark-mode:text-gray-400 mb-2 text-right telugu-text">ప్రశ్న 1 / 1000</p>
                
                <!-- Question Display -->
                <p id="mcq-question" class="text-lg font-semibold text-gray-900 dark-mode:text-gray-100 mb-4">
                    <!-- Question injected here by JS -->
                </p>

                <!-- Options Container -->
                <div id="mcq-options-container" class="space-y-3 mb-4">
                    <!-- Options injected here by JS -->
                </div>

                <!-- Feedback and Actions -->
                <div id="quiz-feedback-area" class="space-y-2">
                    <button id="check-answer-btn" onclick="window.checkQuizAnswerMCQ()" class="play-button ripple-btn w-full py-2 bg-primary mt-2 disabled:opacity-50 text-white font-bold telugu-text">
                        జవాబును తనిఖీ చేయండి (Check Answer)
                    </button>
                    <div id="quiz-result-message" class="text-sm font-bold p-2 rounded-lg hidden telugu-text"></div>
                    
                    <div class="flex space-x-2 mt-2">
                        <button id="hint-btn" onclick="window.showHint()" class="ripple-btn flex-1 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-xl shadow-md disabled:opacity-50 font-bold telugu-text">
                            హింట్ (Hint)
                        </button>
                         <button id="explanation-btn" onclick="window.showExplanation()" class="ripple-btn flex-1 py-2 text-sm bg-orange-500 hover:bg-orange-600 text-white rounded-xl shadow-md disabled:opacity-50 font-bold telugu-text">
                            వివరణ (Explanation)
                        </button>
                        <button id="next-question-btn" onclick="window.loadNextQuestion()" class="ripple-btn flex-1 py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-xl shadow-md hidden disabled:opacity-50 font-bold telugu-text">
                            తరువాత ప్రశ్న
                        </button>
                    </div>
                     <p id="quiz-explanation-text" class="text-sm mt-3 p-3 bg-gray-200 dark-mode:bg-gray-700 rounded-xl hidden telugu-text"></p>
                </div>
            </div>

            <!-- Translation Practice (Retained) -->
            <div class="frosted-option p-4 rounded-xl shadow-md border-primary/20">
                <h3 class="text-lg font-bold text-gray-800 dark-mode:text-gray-200 mb-2 telugu-text">తెలుగు-ఇంగ్లీష్ అనువాదం</h3>
                <p class="text-base text-gray-700 dark-mode:text-gray-300 mb-3 telugu-text">నాకు కాఫీ తాగాలని ఉంది.</p>
                <button class="play-button ripple-btn w-full py-2 bg-teal-600 hover:bg-teal-700 shadow-teal-500/50 text-white font-bold telugu-text">
                    అనువాదం ప్రాక్టీస్ చేయండి
                </button>
            </div>
        </div>

        <!-- --- VIEW: PRACTICE (AI Chat / Role-Play) --- -->
        <div id="view-practice" class="view space-y-4">
            
            <h2 class="text-xl font-bold text-primary elegant-title telugu-text" id="aiCoachTitle">
                AI ఇంగ్లీష్ టీచర్
            </h2>
            
            <!-- Chat Display Box -->
            <div class="chat-container mb-4">
                <div id="chatBox" class="chat-box p-3 flex flex-col space-y-3">
                    <!-- Initial message will be injected here -->
                </div>
            </div>
            
            <!-- Chat Input and Send Button with Mic -->
            <div class="flex">
                <button id="micBtn" class="p-3 bg-rose-600 text-white font-bold hover:bg-rose-700 transition duration-150 shadow-md flex items-center justify-center rounded-l-xl disabled:opacity-50 ripple-btn" aria-label="Speak">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.45-3c0 3.12-2.53 5.75-5.5 5.95V20h-1v-2.05c-2.97-.2-5.5-2.83-5.5-5.95H5v-2h2c0 3.09 2.41 5.66 5.5 5.95V20h1v-2.05c3.09-.29 5.5-2.86 5.5-5.95h2v-2h-2z"/>
                    </svg>
                </button>
                <input type="text" id="chatInput" class="flex-grow p-3 border-y-2 border-r-0 border-l-0 border-gray-300 focus:ring-primary-hex focus:border-primary-hex" placeholder="Speak or Type your response...">
                <button id="sendChatBtn" class="p-3 bg-primary text-white font-bold rounded-r-xl hover:opacity-90 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50 ripple-btn" aria-label="Send">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </button>
            </div>
            <div id="aiLoading" class="mt-2 text-sm text-primary-hex hidden telugu-text">కోచ్ సమాధానం కోసం వేచి ఉంది...</div>

            <!-- Role-Play Section -->
            <div class="mt-4 pt-4 border-t border-gray-300 dark-mode:border-gray-700">
                <h3 class="text-lg font-bold text-gray-800 dark-mode:text-gray-200 telugu-text mb-2">రోల్-ప్లే సంభాషణ</h3>
                <p class="text-sm text-gray-600 dark-mode:text-gray-400 mb-3 telugu-text">ఒక రెస్టారెంట్‌లో ఆహారం ఆర్డర్ చేయడానికి ప్రాక్టీస్ చేయండి.</p>
                <!-- FIXED: Added onclick handler to startRolePlay -->
                <button onclick="window.startRolePlay('restaurant')" class="play-button ripple-btn w-full py-2 bg-amber-600 hover:bg-amber-700 shadow-amber-500/50 text-white font-bold telugu-text">
                    రోల్-ప్లే ప్రారంభించండి
                </button>
            </div>
        </div>

    </div>

    <!-- SETTINGS MODAL (COPIED from your game files for consistency) -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="liquid-glass-card w-full max-w-sm p-6 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark-mode:text-gray-100 border-b pb-2 border-primary telugu-text">యాప్ సెట్టింగ్స్</h2>

            <div class="bg-blue-100 dark-mode:bg-blue-900/40 border border-blue-400 text-blue-800 dark-mode:text-blue-200 text-sm p-3 rounded-xl mb-4 telugu-text">
                <p class="font-semibold">అన్ని సెట్టింగ్‌లు ఈ పరికరంలో ఆటోమేటిక్‌గా సేవ్ చేయబడతాయి.</p>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-3 telugu-text">రంగు యాక్సెంట్</h3>
                <div class="grid grid-cols-5 gap-2">
                    <button onclick="setThemeColor('indigo')" data-color-id="indigo" class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-indigo-600 hover:opacity-90 text-sm">Indigo</button>
                    <button onclick="setThemeColor('teal')" data-color-id="teal" class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-teal-600 hover:opacity-90 text-sm">Teal</button>
                    <button onclick="setThemeColor('rose')" data-color-id="rose" class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-rose-600 hover:opacity-90 text-sm">Rose</button>
                    <button onclick="setThemeColor('amber')" data-color-id="amber" class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-amber-600 hover:opacity-90 text-sm">Amber</button>
                    <button onclick="setThemeColor('emerald')" data-color-id="emerald" class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-emerald-600 hover:opacity-90 text-sm">Emerald</button>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2 telugu-text">థీమ్ మోడ్</h3>
                <div class="flex space-x-4">
                    <button onclick="setThemeMode('light')" data-mode-id="light" id="mode-light" class="ripple-btn flex-1 p-3 rounded-xl border-2 border-transparent text-gray-700 dark-mode:text-gray-300 hover:bg-opacity-80 transition duration-150">Light</button>
                    <button onclick="setThemeMode('dark')" data-mode-id="dark" id="mode-dark" class="ripple-btn flex-1 p-3 rounded-xl border-2 border-transparent text-gray-700 dark-mode:text-gray-300 hover:bg-opacity-80 transition duration-150">Dark</button>
                </div>
            </div>

             <!-- TTS/AI Chat Toggles (Specific to this app) -->
            <div class="mb-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2 telugu-text">AI చాట్ సెట్టింగ్స్</h3>
                <div class="flex flex-col space-y-2">
                    <label class="ripple-btn flex items-center space-x-3 cursor-pointer p-2 rounded-xl frosted-option hover:bg-opacity-80">
                        <input type="checkbox" id="toggle-ai-voice" onclick="toggleAiVoice()" 
                                class="form-checkbox h-5 w-5 rounded text-primary-hex border-gray-300 dark-mode:bg-gray-600 transition duration-150 focus:ring-primary-hex">
                        <span class="text-gray-700 dark-mode:text-gray-300 telugu-text">AI వాయిస్ ఫీడ్‌బ్యాక్ నిలిపివేయండి (TTS)</span>
                    </label>
                </div>
            </div>
            
             <div class="mb-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2 telugu-text">డిస్‌ప్లే & ఫీడ్‌బ్యాక్</h3>
                <div class="flex flex-col space-y-2">
                     <label class="ripple-btn flex items-center space-x-3 cursor-pointer p-2 rounded-xl frosted-option hover:bg-opacity-80">
                        <input type="checkbox" id="toggle-audio" onclick="toggleAudio()" 
                                class="form-checkbox h-5 w-5 rounded text-primary-hex border-gray-300 dark-mode:bg-gray-600 transition duration-150 focus:ring-primary-hex">
                        <span class="text-gray-700 dark-mode:text-gray-300 telugu-text">శబ్ద ప్రభావాలను నిలిపివేయండి</span>
                    </label>
                    <label class="ripple-btn flex items-center space-x-3 cursor-pointer p-2 rounded-xl frosted-option hover:bg-opacity-80">
                        <input type="checkbox" id="toggle-haptics" onclick="toggleHaptics()" 
                                class="form-checkbox h-5 w-5 rounded text-primary-hex border-gray-300 dark-mode:bg-gray-600 transition duration-150 focus:ring-primary-hex">
                        <span class="text-gray-700 dark-mode:text-gray-300 telugu-text">వైబ్రేషన్ నిలిపివేయండి</span>
                    </label>
                </div>
            </div>

            <button onclick="handleUiTapFeedback(); closeSettings()"
                    class="ripple-btn mt-8 w-full py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition duration-150 telugu-text">
                సెట్టింగ్స్ మూసివేయండి
            </button>
        </div>
    </div>


    <script>
        // --- Configuration Keys (Match your existing game files) ---
        const SETTINGS_KEY_VERB = 'quizSettings'; 
        const SETTINGS_KEY_VOCAB = 'vocabQuizSettings'; 
        const DARK_CLASS = 'dark-mode';

        // --- State and Variables ---
        let currentLang = 'te'; 
        let targetLang = 'english'; 
        let currentView = 'home';
        let userProgress = { score: 0, level: 1 };
        let chatHistory = [];
        let currentQuizIndex = 0; // Tracks the current question index
        let isAnswered = false; 
        
        // --- NEW STATE: Tracks the current context/system instruction key ---
        let currentSystemInstructionKey = 'tutor'; // 'tutor' or 'roleplay_restaurant'
        
        // --- Mock 1000 Question Data for Quiz ---
        const quizData = [];
        // Generate 1000 mock questions for demonstration
        const EnglishWords = ['Cat', 'Dog', 'House', 'Water', 'Tree', 'Book', 'Car', 'Sun', 'Moon', 'Star', 'Run', 'Eat', 'Sleep', 'Happy', 'Sad'];
        const TeluguWords = ['పిల్లి', 'కుక్క', 'ఇల్లు', 'నీరు', 'చెట్టు', 'పుస్తకం', 'కారు', 'సూర్యుడు', 'చంద్రుడు', 'నక్షత్రం', 'పరిగెత్తడం', 'తినడం', 'నిద్రపోవడం', 'సంతోషం', 'దుఃఖం'];
        const DistractorsTe = ['పక్షి', 'పని', 'ఆనందం', 'సంతోషం', 'మనుషులు', 'రైలు', 'బస్సు', 'భూమి', 'విద్య', 'ఆట', 'గాలి', 'సమయం', 'పాలు'];

        for (let i = 0; i < 1000; i++) {
            const index = i % EnglishWords.length;
            const word = EnglishWords[index];
            const correctTe = TeluguWords[index];
            
            let options_te = [correctTe];
            let options_en = [word];
            
            // Collect distractors
            let usedDistractors = [correctTe];
            while (options_te.length < 4) {
                 const randomIndex = Math.floor(Math.random() * DistractorsTe.length);
                 const distractorTe = DistractorsTe[randomIndex];
                 
                 // Get the English equivalent of the distractor word (approximation)
                 let distractorEn = EnglishWords[TeluguWords.indexOf(distractorTe)];
                 if (!distractorEn) {
                    // Fallback English word for Telugu distractors
                    distractorEn = "option"; 
                 }
                 
                 if (!usedDistractors.includes(distractorTe)) {
                     options_te.push(distractorTe);
                     options_en.push(distractorEn);
                     usedDistractors.push(distractorTe);
                 }
            }
            
            // Combine and shuffle options to maintain correspondence
            let combined = options_te.map((te, idx) => ({ te: te, en: options_en[idx] }));
            combined.sort(() => 0.5 - Math.random());

            quizData.push({
                id: i + 1,
                question_en: `What is the Telugu translation for the English word: '${word}'? (Q${i+1})`,
                answer_te: correctTe,
                options: combined.map(c => c.te), // Telugu options for display
                options_en: combined.map(c => c.en), // English options for talk-back
                hint_te: `ఇది సాధారణంగా ${word === 'Cat' ? 'ఇంట్లో పెంచుకునే పెంపుడు జంతువు.' : word === 'Water' ? 'మనం దాహం తీర్చుకోవడానికి ఉపయోగించేది.' : 'ఒక ప్రాథమిక నామవాచకం.'}`,
                explanation_te: `'${word}' కు తెలుగులో సరైన అనువాదం '${correctTe}'. ఇది ప్రాథమిక పదజాలంలో భాగం.`,
            });
        }
        
        // --- Utility Functions (Theme, Audio, Haptics) ---
        
        // Local Storage Functions (Adapted to check both keys)
        const getLocalStorageSetting = (key, defaultValue) => {
             try {
                let settings = {};
                let foundValue = undefined;

                const settingsStringVocab = localStorage.getItem(SETTINGS_KEY_VOCAB);
                const settingsStringVerb = localStorage.getItem(SETTINGS_KEY_VERB);

                if (settingsStringVocab) {
                    settings = JSON.parse(settingsStringVocab);
                    if (typeof settings[key] !== 'undefined') foundValue = settings[key];
                }

                if (typeof foundValue === 'undefined' && settingsStringVerb) {
                    settings = JSON.parse(settingsStringVerb);
                    if (typeof settings[key] !== 'undefined') foundValue = settings[key];
                }

                if (typeof foundValue === 'undefined' || foundValue === null) {
                    return defaultValue;
                }
                return foundValue;

            } catch (e) {
                console.error(`Error loading local setting key ${key}:`, e);
                return defaultValue;
            }
        };

        const saveLocalStorageSetting = (key, value) => {
             try {
                const keysToUpdate = [SETTINGS_KEY_VERB, SETTINGS_KEY_VOCAB];

                keysToUpdate.forEach(storageKey => {
                    const settingsString = localStorage.getItem(storageKey);
                    let settings = settingsString ? JSON.parse(settingsString) : {};
                    settings[key] = value;
                    localStorage.setItem(storageKey, JSON.stringify(settings));
                });
                
            } catch (e) {
                console.error(`Error saving local setting key ${key}:`, e);
            }
        }
        
        // Audio/Haptics Setup
        let correctSynth, incorrectSynth;
        const setupAudio = () => {
            // Use Tone.js only if it's available (better sound quality)
            if (typeof Tone !== 'undefined') {
                correctSynth = new Tone.MembraneSynth().toDestination();
                incorrectSynth = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination();
            }
        }
        
        const playCorrect = () => { 
            const disableSound = getLocalStorageSetting('disableSound', false);
            if (disableSound) return;
            if (correctSynth) { Tone.context.resume().then(() => { correctSynth.triggerAttackRelease("G5", "8n"); }); } 
        };
        const playIncorrect = () => { 
            const disableSound = getLocalStorageSetting('disableSound', false);
            if (disableSound) return;
            if (incorrectSynth) { Tone.context.resume().then(() => { incorrectSynth.triggerAttackRelease("16n"); }); }
        };
        const vibrateClick = () => { 
            const disableVibration = getLocalStorageSetting('disableVibration', false);
            if (!disableVibration && navigator.vibrate) { navigator.vibrate(30); } 
        };
        window.handleUiTapFeedback = function() {
            vibrateClick();
        }

        // TTS Speaker (Talk Back Function)
        const speakText = (text, lang) => {
            const disableVoice = getLocalStorageSetting('disableAiVoice', false);
            if (disableVoice || !('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang === 'english' ? 'en-US' : 'en-IN'; 
            
            const voices = window.speechSynthesis.getVoices();
            // Prioritize English voices, fallback to any available
            const selectedVoice = voices.find(v => v.lang.startsWith('en')) || voices[0]; 
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            window.speechSynthesis.speak(utterance);
        };
        
        // Theme Application Functions (Must be defined globally for the app)
        function applyInputStyles() {
             const style = getLocalStorageSetting('inputStyle', 'rounded');
            const root = document.documentElement.style;
            if (style === 'square') {
                root.setProperty('--input-border-radius', '0.5rem'); 
                root.setProperty('--input-shadow', '0 2px 4px rgba(0,0,0,0.1)');
            } else { 
                root.setProperty('--input-border-radius', '1.5rem'); 
                root.setProperty('--input-shadow', '0 4px 6px rgba(0,0,0,0.05)');
            }
            const inputs = document.querySelectorAll('input[type="text"], textarea');
            inputs.forEach(input => {
                input.style.borderRadius = `var(--input-border-radius)`;
                input.style.boxShadow = `var(--input-shadow)`;
            });
        }
        window.setBodyFont = function(font) {
            const fallback = font.includes('serif') ? 'serif' : 'sans-serif';
            document.documentElement.style.setProperty('--font-body', `"${font}", ${fallback}`);
        }
        window.setTitleFont = function(font) {
            const fallback = font.includes('serif') ? 'serif' : 'sans-serif'; 
            document.documentElement.style.setProperty('--font-title', `"${font}", ${fallback}`);
        }
        function applyTheme(isDark) {
             const color = getLocalStorageSetting('color', 'indigo');
            const contrast = getLocalStorageSetting('contrast', 'default');
            const textHue = getLocalStorageSetting('textHue', false);
            const bodyFont = getLocalStorageSetting('bodyFont', 'Inter');
            const titleFont = getLocalStorageSetting('titleFont', 'Lora');
            
            const body = document.body;
            body.setAttribute('data-color', color);
            body.setAttribute('data-contrast', contrast);
            body.setAttribute('data-text-hue', textHue ? 'themed' : 'default');

            if (isDark) {
                body.classList.add(DARK_CLASS);
            } else {
                body.classList.remove(DARK_CLASS);
            }
            
            window.setBodyFont(bodyFont);
            window.setTitleFont(titleFont);
            applyInputStyles();
        }
        
        // --- UI Update & Navigation ---

        // --- UI Text Translations ---
        const Translations = {
            te: {
                appTitle: "AI ఇంగ్లీష్ టీచర్", scoreLabel: "స్కోర్:", 
                aiInitialMessage: "హలో! నేను మీ AI టీచర్ ని. మనం **English** లో ప్రాక్టీస్ చేద్దాం! ఈ రోజు మీరు ఏ విషయం గురించి మాట్లాడాలనుకుంటున్నారు?",
                aiInputPlaceholder: "ఇంగ్లీష్‌లో మాట్లాడండి లేదా టైప్ చేయండి...",
                aiWaiting: "టీచర్ సమాధానం కోసం వేచి ఉంది...", targetLangPrompt: "మీరు ఈ భాషను ప్రాక్టీస్ చేస్తున్నారు:",
                aiError: "క్షమించండి, AI కి కనెక్ట్ కాలేకపోయాను. దయచేసి మళ్లీ ప్రయత్నించండి.",
                aiConnectionError: "ఇంటర్నెట్ కనెక్షన్ సమస్య. దయచేసి మీ నెట్‌వర్క్‌ను తనిఖీ చేయండి.",
                aiCoachTitle: "AI ఇంగ్లీష్ టీచర్",
                lessonStartMessage: "మీరు ప్రాథమిక శుభాకాంక్షలు (Basic Greetings) పాఠాన్ని ప్రారంభించారు. నాతో English లో మాట్లాడటం ప్రారంభించండి.",
            },
            en: {
                appTitle: "AI English Teacher", scoreLabel: "Score:",
                aiInitialMessage: "Hello! I'm your AI Teacher. Let's practice **English**! What topic would you like to discuss today?",
                aiInputPlaceholder: "Speak or Type your response...",
                aiWaiting: "Waiting for the teacher's response...",
                targetLangPrompt: "You are practicing this language:",
                aiCoachTitle: "AI English Teacher",
                lessonStartMessage: "You have started the Basic Greetings lesson. Start speaking to me in English.",
            }
        };
        
        const updateUI = () => {
            const langData = Translations[currentLang];
            document.querySelector('#app-container h1').textContent = langData.appTitle;
            document.getElementById('aiCoachTitle').textContent = langData.aiCoachTitle;
            // REMOVED: document.getElementById('targetLangPrompt').textContent = langData.targetLangPrompt;
            document.getElementById('aiLoading').textContent = langData.aiWaiting;
            
            // Update input placeholder based on currentLang
            let placeholderText = Translations[currentLang].aiInputPlaceholder;
            document.getElementById('chatInput').placeholder = placeholderText;

            // Update visible view
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`view-${currentView}`).classList.add('active');
            
            document.querySelectorAll('.nav-button').forEach(btn => {
                 btn.classList.remove('active');
            });
            document.querySelector(`.nav-button[data-view="${currentView}"]`).classList.add('active');

            // Rerender initial message/focus if needed
            if (currentView === 'practice' && chatHistory.length === 0) {
                 renderInitialAiMessage();
            }
            if (currentView === 'practice') {
                 document.getElementById('chatInput').focus();
            }
             if (currentView === 'quiz') {
                 // Ensure the quiz loads if we switch to it
                 if (quizData.length > 0) window.loadQuizQuestion(currentQuizIndex);
            }
        };

        window.changeView = (viewName) => {
            if (currentView === viewName) return;
            currentView = viewName;
            // Reset to default tutor instruction when leaving the practice tab
            if (currentView !== 'practice') {
                currentSystemInstructionKey = 'tutor';
            }
            updateUI();
        };

        const switchTargetLanguage = (newTarget) => {
            // Since we only support English now, this function is simplified
            if (targetLang === newTarget) return;
            // Removed targetLang update and switch logic for Hindi
            
            // Reset chat history and instruction
            currentSystemInstructionKey = 'tutor';
            chatHistory = [];
            renderInitialAiMessage();
            updateUI();
        };

        // --- Progress and Firestore ---
        
        const updateLevelText = (score) => {
            if (score < 100) return { name: "Beginner", percentage: score, max: 100 };
            if (score < 300) return { name: "Intermediate", percentage: score - 100, max: 200 };
            return { name: "Advanced", percentage: score - 300, max: 500 };
        };

        const updateProgressBarUI = () => {
            const progress = updateLevelText(userProgress.score);
            const levelEl = document.getElementById('progress-level');
            const scoreEl = document.getElementById('progress-score');
            const barEl = document.getElementById('progress-bar-home');
            const totalScoreEl = document.getElementById('userScore');
            
            totalScoreEl.textContent = userProgress.score;
            levelEl.innerHTML = `స్థాయి: <span class="text-primary font-extrabold text-green-600 dark-mode:text-green-400">${progress.name}</span>`;

            let percent = 0;
            if (progress.max > 0) {
                 percent = (progress.percentage / progress.max) * 100;
            }
            
            barEl.style.width = `${percent}%`;
            scoreEl.textContent = `${userProgress.score} పాయింట్లు (${percent.toFixed(0)}% to ${progress.name === 'Beginner' ? 'Intermediate' : 'Advanced'})`;
        };

        const updateScoreDisplay = async (oldScore) => {
            if (!window.app.db || !window.app.userId) {
                userProgress.score = Math.max(0, userProgress.score); // Ensure score >= 0
                updateProgressBarUI();
                return;
            }

            const progressRef = doc(window.app.db, 
                'artifacts', window.app.appId, 
                'users', window.app.userId, 
                'language_app_data', 'progress'
            );

            try {
                await setDoc(progressRef, userProgress, { merge: true });
                updateProgressBarUI();
                if (userProgress.score > oldScore) {
                     playCorrect(); 
                }
            } catch (error) {
                console.error("Error saving progress:", error);
            }
        };
        
        const setupProgressListener = () => {
             if (!window.app.db || !window.app.userId) {
                updateProgressBarUI();
                return;
            }

            const progressRef = doc(window.app.db, 
                'artifacts', window.app.appId, 
                'users', window.app.userId, 
                'language_app_data', 'progress'
            );

            onSnapshot(progressRef, (docSnap) => {
                const oldScore = userProgress.score;
                if (docSnap.exists()) {
                    userProgress = docSnap.data();
                } else {
                    userProgress = { score: 0, level: 1 };
                    updateScoreDisplay(0); // Initialize Firestore record
                }
                updateProgressBarUI();
            }, (error) => {
                console.error("Error listening to progress:", error);
            });
        };
        
        // --- Chat Functions ---

        const renderMessage = (role, text) => {
            const chatBox = document.getElementById('chatBox');
            const msgDiv = document.createElement('div');
            
            // AI Response processing
            let displayText = text;
            let feedback = '';
            let teluguTip = '';

            if (role === 'ai') {
                // Simple parsing logic: assume corrected sentence is first, then Telugu tip
                const parts = text.split('.');
                // Check for feedback in the entire response
                const correctionMatch = text.match(/(Correction|Improved):\s*(.*?)\.\s*(.*)/i);

                if (correctionMatch) {
                    const correction = correctionMatch[2].trim();
                    const remainingText = correctionMatch[3].trim();
                    
                    // The main conversational text is typically the first sentence before the correction/feedback
                    const firstSentenceEnd = text.indexOf(correctionMatch[0]);
                    if (firstSentenceEnd !== -1) {
                         displayText = text.substring(0, firstSentenceEnd).trim();
                    } else {
                         displayText = text; // Fallback
                    }

                    feedback = `<span class="ai-feedback">Correction: ${correction}.</span>`;
                    
                    // Attempt to extract Telugu tip from remaining text
                    const teluguMatch = remainingText.match(/(మీరు చెప్పే|మీరు మాట్లాడే|సరైన వాక్యం|ఇక్కడ గమనించండి)/i);
                    if (teluguMatch) {
                        teluguTip = `<span class="telugu-tip">${teluguMatch.input.substring(teluguMatch.index)}</span>`;
                        // Remove the Telugu part from the main display text
                        if (displayText === text) {
                            displayText = displayText.substring(0, teluguMatch.index).trim();
                        }
                    } else {
                         displayText = text;
                    }
                }
            }
            
            msgDiv.className = `p-3 shadow-md text-sm mb-2 transition-all duration-300 ${role === 'user' ? 'chat-user-message ml-auto' : 'chat-ai-message mr-auto'}`;
            msgDiv.innerHTML = displayText.replace(/\n/g, '<br>') + feedback + teluguTip;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (role === 'ai') {
                const englishText = extractTargetLanguageForSpeaking(text, targetLang);
                speakText(englishText, targetLang);
            }
        };
        
        const extractTargetLanguageForSpeaking = (fullText, target) => {
            // Heuristic to look for the corrected/main sentence
            const langCode = target === 'english' ? 'English' : 'Hindi';
            // 1. Look for explicit correction/improvement
            const correctionMatch = fullText.match(new RegExp(`(Correction|Improved):\\s*(.*?)\\.\s*`, 'i'));
            if (correctionMatch && correctionMatch[2]) {
                return correctionMatch[2].trim();
            }
            
            // 2. Try to find the first conversational sentence (before any feedback)
            const feedbackStart = fullText.toLowerCase().indexOf('correction:');
            let conversationText = fullText;
            if (feedbackStart !== -1) {
                 conversationText = fullText.substring(0, feedbackStart).trim();
            }
            
            // 3. Extract the first sentence or a long block of text
            const sentenceMatch = conversationText.match(/(\w[\w\s,']{10,}[\.!?])/); 
            if (sentenceMatch) {
                 return sentenceMatch[1].trim();
            }
            return fullText; // Fallback
        };

        const renderInitialAiMessage = () => {
             const chatBox = document.getElementById('chatBox');
             chatBox.innerHTML = '';
             chatHistory = [];
             currentSystemInstructionKey = 'tutor'; // Default to tutor mode
             
             let initialMsg = Translations[currentLang].aiInitialMessage;
             renderMessage('ai', initialMsg);
             chatHistory.push({ role: 'ai', text: initialMsg });
        };
        
        // --- Gemini AI System Instructions (Refactored to handle role-play) ---
        const getSystemInstruction = (key, target) => {
            const teluguGuide = 'మీరు చేసే ప్రతి ఇంగ్లీష్ వాక్యం తర్వాత, దానిని మెరుగుపరిచి, సరైన గ్రామర్, పదం మరియు వాక్య నిర్మాణాన్ని తెలియజేయండి. ఫీడ్‌బ్యాక్ తర్వాత మాత్రమే తదుపరి సంభాషణను English లో కొనసాగించండి.';
            const langName = 'English';

            // --- ROLE PLAY: RESTAURANT ---
            if (key === 'roleplay_restaurant') {
                return `You are now acting as a friendly and helpful waiter/waitress at a restaurant called 'The Global Cafe'. The user is your customer who is learning ${langName} (their native language is Telugu).
                
                Your responses MUST strictly adhere to the role of a server.
                
                CRITICAL: After every user response (order or question), you must immediately provide two things:
                1. Your next natural line in the conversation as a server, in ${langName}.
                2. Then, provide CONSTRUCTIVE FEEDBACK on the user's previous sentence (like the tutor). The feedback must start with "Correction: [Corrected sentence in ${langName}]." and be followed by a quick Telugu tip explaining the error or giving positive encouragement.

                Example AI Response: "Certainly, one latte coming right up! Did you want anything to eat with that? Correction: You said 'I want coffee' but 'I would like coffee' or 'Can I please get a coffee' is more polite. ఇక్కడ 'would like' వాడటం మర్యాదగా ఉంటుంది."
                
                Your response should be short, engaging, and in character. Do NOT use markdown formatting. The user's goal is to successfully order a meal.`;
            } 
            
            // --- DEFAULT: TUTOR ---
            else { 
                return `You are an expert, friendly AI language coach named **AI English Teacher**. Your user is a native Telugu speaker and is currently focused on learning **${langName}**.
                
                Your primary role is to act as a **personal conversational tutor** for ${langName}, providing real-time feedback and coaching.

                Your goals are:
                1. Maintain an engaging conversation, primarily in **${langName}**.
                2. Respond in **${langName}**, but use Telugu for encouragement and clarity.
                3. **CRITICAL: After every user response, provide explicit and constructive feedback.** This feedback must include:
                   - A clear correction of any grammar, spelling, or vocabulary errors.
                   - An improved, natural-sounding version of the user's sentence (The target output).
                   - A quick, positive coaching tip related to their usage.
                4. Do NOT use markdown formatting (like **bold** or bullet points) in your response, keep the output conversational and easy to read.
                5. Telugu Instruction: ${teluguGuide}
                6. Encourage the user to continue the dialogue or start a new topic. **Your responses should be engaging and short to simulate a real conversation.**`;
            }
        };

        // --- NEW FUNCTION: To start the role-play scenario ---
        window.startRolePlay = (scenario) => {
            handleUiTapFeedback();
            currentSystemInstructionKey = `roleplay_${scenario}`;
            chatHistory = []; // Clear previous chat
            let initialMsg = '';

            if (scenario === 'restaurant') {
                 initialMsg = "Hello! Welcome to 'The Global Cafe'. I will be your server today. What can I get started for you? (Please respond in English.)";
            } else {
                 // Fallback to default tutor mode
                 currentSystemInstructionKey = 'tutor';
                 initialMsg = Translations[currentLang].aiInitialMessage;
            }

            // Immediately set the view to practice and render the new message
            changeView('practice');
            document.getElementById('chatBox').innerHTML = ''; // Clear chat area
            renderMessage('ai', initialMsg);
            chatHistory.push({ role: 'ai', text: initialMsg });
            document.getElementById('chatInput').focus();
        };

        // --- NEW FUNCTION: To start a lesson (navigates to chat) ---
        window.startLesson = () => {
             handleUiTapFeedback();
             // Reset to general tutor mode (could be expanded later for specific lesson modes)
             currentSystemInstructionKey = 'tutor'; 
             chatHistory = []; 
             
             // Immediately set the view to practice
             changeView('practice');
             document.getElementById('chatBox').innerHTML = ''; // Clear chat area
             
             // Render a welcoming message for the lesson
             let lessonMsg = Translations[currentLang].lessonStartMessage;
             renderMessage('ai', lessonMsg);
             chatHistory.push({ role: 'ai', text: lessonMsg });
             document.getElementById('chatInput').focus();
        };
        
        // --- Gemini API Handler ---
        const geminiApiCall = async (history, systemInstructionKey, maxRetries = 3) => { // Use key here
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const contents = history.map(msg => ({
                role: msg.role === 'ai' ? 'model' : 'user',
                parts: [{ text: msg.text }]
            }));

            const payload = {
                contents: contents,
                systemInstruction: {
                    // Use the getter function with the current key
                    parts: [{ text: getSystemInstruction(systemInstructionKey, targetLang) }] 
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || Translations[currentLang].aiError;
                    return text;

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (attempt === maxRetries - 1) {
                        return Translations[currentLang].aiConnectionError;
                    }
                }
            }
            return Translations[currentLang].aiError;
        };

        const sendConversationMessage = async () => {
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const micBtn = document.getElementById('micBtn');
            const aiLoading = document.getElementById('aiLoading');

            const userText = chatInput.value.trim();
            if (userText === '') return;
            
            handleUiTapFeedback(); 

            renderMessage('user', userText);
            chatInput.value = '';
            
            chatHistory.push({ role: 'user', text: userText });

            aiLoading.classList.remove('hidden');
            sendChatBtn.disabled = true;
            micBtn.disabled = true;
            chatInput.disabled = true;

            // Pass the current system instruction key
            const aiResponse = await geminiApiCall(chatHistory, currentSystemInstructionKey); 

            aiLoading.classList.add('hidden');
            sendChatBtn.disabled = false;
            micBtn.disabled = false;
            chatInput.disabled = false;
            chatInput.focus();

            renderMessage('ai', aiResponse);
            chatHistory.push({ role: 'ai', text: aiResponse });

            if (userText.length > 5) {
                const oldScore = userProgress.score;
                userProgress.score += 5;
                updateScoreDisplay(oldScore);
            }
        };

        // --- STT Logic (Mic Button) ---
        let recognition = null;
        const micBtn = document.getElementById('micBtn');
        const chatInput = document.getElementById('chatInput');

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onstart = () => {
                micBtn.classList.add('bg-yellow-500', 'animate-pulse');
                chatInput.placeholder = "Listening... Speak now!";
                micBtn.disabled = true; 
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
                sendConversationMessage(); 
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                micBtn.classList.remove('bg-yellow-500', 'animate-pulse');
                chatInput.placeholder = Translations[currentLang].aiInputPlaceholder;
                micBtn.disabled = false;
            };

            recognition.onend = () => {
                micBtn.classList.remove('bg-yellow-500', 'animate-pulse');
                chatInput.placeholder = Translations[currentLang].aiInputPlaceholder;
                micBtn.disabled = false;
            };
            
            micBtn.addEventListener('click', () => {
                handleUiTapFeedback();
                try {
                    recognition.lang = 'en-US'; // Hardcoded to English since Hindi is removed
                    recognition.start();
                } catch (e) {
                    console.error("Recognition already started or error:", e);
                }
            });
        } else {
            micBtn.disabled = true;
            micBtn.style.backgroundColor = '#ccc';
            micBtn.title = "Speech recognition not supported by your browser.";
        }
        
        // --- Gamified Feature Handlers (Word of the Day) ---
        
        window.speakDailyWord = () => {
            handleUiTapFeedback();
            const word = document.getElementById('daily-word-en').textContent;
            speakText(word, 'english');
        }
        
        // --- NEW QUIZ LOGIC (MCQ) ---

        // Helper function to render an option button
        const renderOptionButton = (optionText, index) => {
            // Check if quizData is initialized before trying to access it
            const currentQuestion = quizData[currentQuizIndex];
            const englishWord = currentQuestion && currentQuestion.options_en ? currentQuestion.options_en[index] : 'word';
            
            return `
                <button data-option="${index}" 
                        onclick="window.selectQuizOption(this)"
                        data-english-word="${englishWord}"
                        class="mcq-option ripple-btn w-full p-3 rounded-xl border-2 border-gray-300 dark-mode:border-gray-700 bg-white dark-mode:bg-gray-800 text-gray-800 dark-mode:text-gray-200 text-left telugu-text transition duration-150 hover:bg-gray-100 dark-mode:hover:bg-gray-700 disabled:opacity-100">
                    ${optionText}
                </button>
            `;
        };

        // NEW: Handles option selection and pronunciation
        window.selectQuizOption = (button) => {
            if (isAnswered) return;
            handleUiTapFeedback();
            const optionsContainer = document.getElementById('mcq-options-container');
            
            // Visually select the option
            optionsContainer.querySelectorAll('.mcq-option').forEach(b => {
                 b.classList.remove('border-primary', 'bg-primary/20', 'shadow-md');
                 b.removeAttribute('data-selected');
            });
            button.classList.add('border-primary', 'bg-primary/20', 'shadow-md');
            // Store selection
            button.setAttribute('data-selected', 'true');
            
            // Talk Back: Speak the English word for pronunciation practice
            const englishWord = button.getAttribute('data-english-word');
            speakText(englishWord, 'english');
        };

        window.loadQuizQuestion = (index = 0) => {
            if (quizData.length === 0) return; // Prevent crash if quizData is empty
            currentQuizIndex = index % quizData.length; // Loop through questions
            isAnswered = false;

            const question = quizData[currentQuizIndex];
            const optionsContainer = document.getElementById('mcq-options-container');
            const questionEl = document.getElementById('mcq-question');
            const counterEl = document.getElementById('quiz-counter');
            const resultMsgEl = document.getElementById('quiz-result-message');
            const explanationTextEl = document.getElementById('quiz-explanation-text');
            
            // Reset state
            resultMsgEl.classList.add('hidden');
            explanationTextEl.classList.add('hidden');
            explanationTextEl.classList.remove('bg-blue-100', 'dark-mode:bg-blue-900/40', 'text-blue-800', 'dark-mode:text-blue-200', 'bg-gray-200', 'dark-mode:bg-gray-700');
            document.getElementById('check-answer-btn').disabled = false;
            document.getElementById('next-question-btn').classList.add('hidden');
            document.getElementById('hint-btn').disabled = false;
            document.getElementById('explanation-btn').disabled = true; // Can only explain after answering

            questionEl.textContent = question.question_en;
            counterEl.textContent = `ప్రశ్న ${currentQuizIndex + 1} / ${quizData.length}`;

            // Render Options
            // Pass both option text and its index to the map function
            optionsContainer.innerHTML = question.options.map((option, index) => renderOptionButton(option, index)).join('');
        };

        window.checkQuizAnswerMCQ = async () => {
            if (isAnswered) return;
            
            const optionsContainer = document.getElementById('mcq-options-container');
            const selectedButton = optionsContainer.querySelector('[data-selected="true"]');
            const resultMsgEl = document.getElementById('quiz-result-message');
            const checkBtn = document.getElementById('check-answer-btn');

            if (!selectedButton) {
                resultMsgEl.textContent = "దయచేసి ఒక ఎంపికను ఎంచుకోండి.";
                resultMsgEl.className = 'text-sm font-bold p-2 rounded-lg bg-yellow-100 text-yellow-800 dark-mode:bg-yellow-900/40 dark-mode:text-yellow-200 telugu-text';
                resultMsgEl.classList.remove('hidden');
                return;
            }
            
            handleUiTapFeedback();
            isAnswered = true;
            checkBtn.disabled = true;
            document.getElementById('explanation-btn').disabled = false;
            document.getElementById('next-question-btn').classList.remove('hidden');
            
            const question = quizData[currentQuizIndex];
            const userAnswer = selectedButton.textContent.trim();
            const isCorrect = (userAnswer === question.answer_te);
            
            // Highlight correct/incorrect
            optionsContainer.querySelectorAll('.mcq-option').forEach(btn => {
                const optionText = btn.textContent.trim();
                btn.disabled = true;
                btn.classList.remove('hover:bg-gray-100', 'dark-mode:hover:bg-gray-700', 'border-primary', 'bg-primary/20', 'shadow-md');

                if (optionText === question.answer_te) {
                    // Correct answer highlight (Green)
                    btn.classList.add('bg-green-200', 'dark-mode:bg-green-700', 'border-green-500');
                } else if (btn === selectedButton) {
                    // Incorrect selection highlight (Red)
                    btn.classList.add('bg-red-200', 'dark-mode:bg-red-700', 'border-red-500');
                }
            });

            if (isCorrect) {
                resultMsgEl.textContent = `సరైన సమాధానం! 🎉 10 పాయింట్లు లభించాయి.`;
                resultMsgEl.className = 'text-sm font-bold p-2 rounded-lg bg-green-100 text-green-800 dark-mode:bg-green-900/40 dark-mode:text-green-200 telugu-text';
                
                const oldScore = userProgress.score;
                userProgress.score += 10;
                await updateScoreDisplay(oldScore);
                playCorrect();
            } else {
                resultMsgEl.textContent = `తప్పు సమాధానం. 😔 సరైన సమాధానం: "${question.answer_te}"`;
                resultMsgEl.className = 'text-sm font-bold p-2 rounded-lg bg-red-100 text-red-800 dark-mode:bg-red-900/40 dark-mode:text-red-200 telugu-text';
                playIncorrect();
            }
            resultMsgEl.classList.remove('hidden');
        };

        window.showHint = () => {
            handleUiTapFeedback();
            const explanationTextEl = document.getElementById('quiz-explanation-text');
            const question = quizData[currentQuizIndex];
            
            explanationTextEl.textContent = `హింట్: ${question.hint_te}`;
            explanationTextEl.classList.remove('hidden');
            explanationTextEl.classList.add('bg-blue-100', 'dark-mode:bg-blue-900/40', 'text-blue-800', 'dark-mode:text-blue-200');
            explanationTextEl.classList.remove('bg-gray-200', 'dark-mode:bg-gray-700');
            
            document.getElementById('hint-btn').disabled = true;
        };

        window.showExplanation = () => {
            if (!isAnswered) return;
            handleUiTapFeedback();
            const explanationTextEl = document.getElementById('quiz-explanation-text');
            const question = quizData[currentQuizIndex];

            explanationTextEl.textContent = `వివరణ: ${question.explanation_te}`;
            explanationTextEl.classList.remove('hidden', 'bg-blue-100', 'dark-mode:bg-blue-900/40', 'text-blue-800', 'dark-mode:text-blue-200');
            explanationTextEl.classList.add('bg-gray-200', 'dark-mode:bg-gray-700');
            document.getElementById('explanation-btn').disabled = true;
        };

        window.loadNextQuestion = () => {
            handleUiTapFeedback();
            window.loadQuizQuestion(currentQuizIndex + 1);
        };

        // --- Event Listeners and Initializers ---

        // REMOVED: document.getElementById('targetLangSwitch').addEventListener('click', ...

        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                handleUiTapFeedback();
                changeView(e.target.dataset.view);
            });
        });

        document.getElementById('sendChatBtn').addEventListener('click', sendConversationMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendConversationMessage();
            }
        });
        
        document.getElementById('app-container').addEventListener('click', (e) => {
            // Only vibrate/tap feedback for buttons that don't already have specific handlers
            if (e.target.closest('#app-container button:not(#micBtn):not(.mcq-option):not([onclick])')) {
                handleUiTapFeedback();
            }
        });

        // --- Settings Modal Functions (Needed for Dark Mode) ---
        window.openSettings = function() {
            document.getElementById('settings-modal').classList.remove('hidden');
            // Ensure current theme color and mode are selected visually
            const currentMode = getLocalStorageSetting('theme', 'light');
            const currentColor = getLocalStorageSetting('color', 'indigo');
            
            document.querySelectorAll('#mode-light, #mode-dark').forEach(btn => btn.classList.remove('border-primary'));
            document.getElementById(`mode-${currentMode}`).classList.add('border-primary');
            
            document.querySelectorAll('.color-option').forEach(btn => btn.classList.remove('border-4', 'border-white', 'dark-mode:border-gray-900'));
            document.querySelector(`[data-color-id="${currentColor}"]`).classList.add('border-4', 'border-white', 'dark-mode:border-gray-900');

            // Update toggles
            document.getElementById('toggle-ai-voice').checked = getLocalStorageSetting('disableAiVoice', false);
            document.getElementById('toggle-audio').checked = getLocalStorageSetting('disableSound', false);
            document.getElementById('toggle-haptics').checked = getLocalStorageSetting('disableVibration', false);
        };

        window.closeSettings = function() {
            document.getElementById('settings-modal').classList.add('hidden');
        };

        window.setThemeMode = function(mode) {
            saveLocalStorageSetting('theme', mode);
            applyTheme(mode === 'dark');
            document.querySelectorAll('#mode-light, #mode-dark').forEach(btn => btn.classList.remove('border-primary'));
            document.getElementById(`mode-${mode}`).classList.add('border-primary');
            handleUiTapFeedback();
        };

        window.setThemeColor = function(color) {
            saveLocalStorageSetting('color', color);
            applyTheme(getLocalStorageSetting('theme', 'light') === 'dark'); 
            document.querySelectorAll('.color-option').forEach(btn => btn.classList.remove('border-4', 'border-white', 'dark-mode:border-gray-900'));
            document.querySelector(`[data-color-id="${color}"]`).classList.add('border-4', 'border-white', 'dark-mode:border-gray-900');
            handleUiTapFeedback();
        };

        // Toggle functions for settings
        window.toggleAiVoice = function() {
            const isChecked = document.getElementById('toggle-ai-voice').checked;
            saveLocalStorageSetting('disableAiVoice', isChecked);
        };
        window.toggleAudio = function() {
            const isChecked = document.getElementById('toggle-audio').checked;
            saveLocalStorageSetting('disableSound', isChecked);
        };
        window.toggleHaptics = function() {
            const isChecked = document.getElementById('toggle-haptics').checked;
            saveLocalStorageSetting('disableVibration', isChecked);
        };

        // --- Application Initialization ---

        window.app.initApp = () => {
            // Apply theme/font settings from PWA local storage
            const currentMode = getLocalStorageSetting('theme', (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
            applyTheme(currentMode === 'dark');

            updateUI();
            setupProgressListener(); 
            setupAudio();
            
            // Load the first quiz question when the app starts
            if (quizData.length > 0) window.loadQuizQuestion(0);
        };
    </script>
    
    <!-- Floating Settings Button (Adapted to match your PWA styling) -->
    <button onclick="handleUiTapFeedback(); openSettings()"
        class="fixed bottom-4 right-4 p-4 bg-primary text-white rounded-full shadow-xl shadow-primary/50 hover:bg-opacity-90 transition duration-150 ripple-btn z-20"
        title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.599.345 1.35.424 1.576.471.226.047.608-.184.608-.431V6.26z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>
</body>
</html>

