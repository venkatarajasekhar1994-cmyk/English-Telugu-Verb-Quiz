<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telugu Verb Quiz</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        // Check for service worker support and register it
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered: ', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed: ', error);
                    });
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        /* Import all available fonts for customization */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:wght@700&family=Roboto:wght@400;700&family=Merriweather:wght==400;700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&family=Source+Sans+3:wght@400;700&family=Poppins:wght@400;600;700&display=swap');
        
        /* --- CSS Variables for Theme Management --- */
        
        /* Font Variables */
        :root {
            --font-body: 'Inter', sans-serif;
            --font-title: 'Lora', serif;
            /* Input Variables (Defaults to 'rounded') */
            --input-border-radius: 1.5rem; /* Ultra rounded default */
            --input-shadow: 0 4px 6px rgba(0,0,0,0.05); /* Soft shadow default */
            /* Text Contrast Variables (Defaults to High Contrast for seamlessness) */
            --text-color-light: #111827; /* Near black */
            --text-color-dark: #f3f4f6; /* Near white */
        }
        
        /* Default: Indigo */
        :root,
        body[data-color="Indigo"] { /* UPDATED: Match hub key 'Indigo' */
            --color-primary: 79, 70, 229; /* Indigo 600 RGB */
            --color-primary-hex: #4f46e5;
            --color-primary-light: 165, 180, 252; /* Indigo 300 RGB */
            --color-bg-light-start: #a78bfa;
            --color-bg-light-mid: #818cf8;
            --color-bg-light-end: #3b82f6;
            --color-bg-dark-start: #1f2937;
            --color-bg-dark-mid: #111827;
            --color-bg-dark-end: #0f172a;
        }

        /* Teal Theme */
        body[data-color="Teal"] { /* UPDATED: Match hub key 'Teal' */
            --color-primary: 20, 184, 166; /* Teal 600 RGB */
            --color-primary-hex: #14b8a6;
            --color-primary-light: 94, 234, 212; /* Teal 300 RGB */
            --color-bg-light-start: #2dd4bf;
            --color-bg-light-mid: #5eead4;
            --color-bg-light-end: #0d9488;
            --color-bg-dark-start: #134e4a;
            --color-bg-dark-mid: #115e59;
            --color-bg-dark-end: #0f766e;
        }

        /* Rose Theme */
        body[data-color="Rose"] { /* UPDATED: Match hub key 'Rose' */
            --color-primary: 225, 29, 72; /* Rose 600 RGB */
            --color-primary-hex: #e11d48;
            --color-primary-light: 251, 207, 232; /* Rose 300 RGB */
            --color-bg-light-start: #fda4af;
            --color-bg-light-mid: #f43f5e;
            --color-bg-light-end: #e11d48;
            --color-bg-dark-start: #500724;
            --color-bg-dark-mid: #881337;
            --color-bg-dark-end: #9f1239;
        }

        /* Amber Theme */
        body[data-color="Amber"] { /* UPDATED: Match hub key 'Amber' */
            --color-primary: 245, 158, 11; /* Amber 600 RGB */
            --color-primary-hex: #f59e0b;
            --color-primary-light: 253, 230, 138; /* Amber 300 RGB */
            --color-bg-light-start: #fcd34d;
            --color-bg-light-mid: #f59e0b;
            --color-bg-light-end: #fbbf24;
            --color-bg-dark-start: #78350f;
            --color-bg-dark-mid: #92400e;
            --color-bg-dark-end: #b45309;
        }
        
        /* Emerald Theme */
        body[data-color="Emerald"] { /* UPDATED: Match hub key 'Emerald' */
            --color-primary: 5, 150, 105; /* Emerald 600 RGB */
            --color-primary-hex: #059669;
            --color-primary-light: 110, 231, 183; /* Emerald 300 RGB */
            --color-bg-light-start: #34d399;
            --color-bg-light-mid: #10b981;
            --color-bg-light-end: #059669;
            --color-bg-dark-start: #064e3b;
            --color-bg-dark-mid: #065f46;
            --color-bg-dark-end: #047857;
        }
        
        /* Cyan Theme */
        body[data-color="Cyan"] { /* UPDATED: Match hub key 'Cyan' */
            --color-primary: 8, 145, 178; /* Cyan 600 RGB */
            --color-primary-hex: #0891b2;
            --color-primary-light: 165, 243, 252; /* Cyan 200 RGB */
            --color-bg-light-start: #22d3ee;
            --color-bg-light-mid: #06b6d4;
            --color-bg-light-end: #0891b2;
            --color-bg-dark-start: #164e63;
            --color-bg-dark-mid: #155e75;
            --color-bg-dark-end: #0e7490;
        }

        /* Pink Theme */
        body[data-color="Pink"] { /* UPDATED: Match hub key 'Pink' */
            --color-primary: 219, 39, 119; /* Pink 600 RGB */
            --color-primary-hex: #db2777;
            --color-primary-light: 251, 207, 232; /* Pink 200 RGB */
            --color-bg-light-start: #f9a8d4;
            --color-bg-light-mid: #f472b6;
            --color-bg-light-end: #ec4899;
            --color-bg-dark-start: #500724;
            --color-bg-dark-mid: #831843;
            --color-bg-dark-end: #9d174d;
        }

        /* Orange Theme */
        body[data-color="Orange"] { /* UPDATED: Match hub key 'Orange' */
            --color-primary: 234, 88, 12; /* Orange 600 RGB */
            --color-primary-hex: #ea580c;
            --color-primary-light: 254, 215, 170; /* Orange 200 RGB */
            --color-bg-light-start: #fbbf24;
            --color-bg-light-mid: #f97316;
            --color-bg-light-end: #ea580c;
            --color-bg-dark-start: #7c2d12;
            --color-bg-dark-mid: #9a3412;
            --color-bg-dark-end: #c2410c;
        }

        /* Purple Theme */
        body[data-color="Purple"] { /* UPDATED: Match hub key 'Purple' */
            --color-primary: 147, 51, 234; /* Purple 600 RGB */
            --color-primary-hex: #9333ea;
            --color-primary-light: 221, 214, 254; /* Purple 200 RGB */
            --color-bg-light-start: #c084fc;
            --color-bg-light-mid: #a855f7;
            --color-bg-light-end: #9333ea;
            --color-bg-dark-start: #3b0764;
            --color-bg-dark-mid: #581c87;
            --color-bg-dark-end: #6b21a8;
        }
        
        /* Sky Theme */
        body[data-color="Sky"] { /* UPDATED: Match hub key 'Sky' */
            --color-primary: 2, 132, 199; /* Sky 600 RGB */
            --color-primary-hex: #0284c7;
            --color-primary-light: 186, 230, 253; /* Sky 200 RGB */
            --color-bg-light-start: #38bdf8;
            --color-bg-light-mid: #0ea5e9;
            --color-bg-light-end: #0284c7;
            --color-bg-dark-start: #0c4a6e;
            --color-bg-dark-mid: #075985;
            --color-bg-dark-end: #0369a1;
        }
        
        /* --- Base Styles --- */
        body {
            font-family: var(--font-body);
            min-height: 100vh;
            padding: 1rem;
            color: var(--text-color-light); 
            background: linear-gradient(135deg, var(--color-bg-light-start), var(--color-bg-light-mid), var(--color-bg-light-end));
            transition: background 0.5s ease, color 0.3s ease;
        }
        
        .elegant-title {
            font-family: var(--font-title); 
            font-weight: 700;
            letter-spacing: 0.05em; 
            color: #1e293b;
        }

        /* Main Glass Card */
        .liquid-glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(var(--color-primary-light), 0.35));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: all 0.3s ease;
        }
        
        /* Frosted Glass Effect for Settings Options */
        .frosted-option {
            background: rgba(255, 255, 255, 0.5); /* Lighter background for better contrast */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease, transform 0.1s ease;
        }
        .frosted-option:hover {
            background: rgba(255, 255, 255, 0.7);
        }
        .frosted-option:active { /* Subtle press animation */
            transform: scale(0.98); 
        }
        
        /* Custom selector list items */
        .selector-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(156, 163, 175, 0.3);
            transition: all 0.2s ease, transform 0.1s ease;
        }
        .selector-item:last-child {
            border-bottom: none;
        }
        .selector-item.selected {
            background-color: rgba(var(--color-primary-light), 0.2);
            font-weight: 600;
        }
        .selector-item:active { /* Subtle press animation */
            transform: scale(0.98); 
        }
        
        /* Custom radio circle */
        .radio-circle {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            border: 2px solid #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .radio-circle.selected {
            border-color: var(--color-primary-hex);
        }
        .radio-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            background-color: transparent;
            transition: background-color 0.2s ease;
        }
        .radio-dot.selected {
            background-color: var(--color-primary-hex);
        }


        /* Prompt box styles */
        .prompt-box {
            background: linear-gradient(135deg, rgba(var(--color-primary-light), 0.6), rgba(var(--color-primary), 0.4)); 
            backdrop-filter: blur(8px);
            border-color: rgba(var(--color-primary), 0.5);
        }
        
        /* --- START: MODIFIED INPUT STYLING --- */
        input[type="text"], input[type="number"], textarea {
            font-family: var(--font-body);
            background-color: rgba(255, 255, 255, 0.5) !important;
            border: 1px solid rgba(156, 163, 175, 0.3);
            color: var(--text-color-light) !important;
            transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.3s ease;
            
            border-radius: var(--input-border-radius); 
            box-shadow: var(--input-shadow);
            
            /* For Quiz Inputs */
            padding: 0.75rem 1rem;
            width: 100%;
        }
        
        /* Override for quiz inputs to add feedback borders */
        input.quiz-input {
             border-width: 2px;
             transition: all 0.2s ease;
        }
        
        input.quiz-input:focus {
             border-color: var(--color-primary-hex) !important;
             box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.3);
             outline: none;
        }
        /* --- END: MODIFIED INPUT STYLING --- */

        
        /* Multiple choice buttons (No longer used for quiz, but kept for settings) */
        .mc-option {
            transition: all 0.2s ease;
            border: 2px solid #e5e7eb;
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
        }
        .mc-option:hover:not(.selected):not(.correct):not(.incorrect) {
            border-color: rgba(var(--color-primary), 0.5);
            background-color: rgba(var(--color-primary-light), 0.2);
        }
        .mc-option.selected {
            border-color: var(--color-primary-hex) !important;
            background-color: rgba(var(--color-primary-light), 0.4);
            box-shadow: 0 4px 6px rgba(var(--color-primary), 0.2);
        }
        .mc-option.locked {
            pointer-events: none;
            cursor: default;
        }


        .text-primary { color: var(--color-primary-hex); }
        .border-primary { border-color: var(--color-primary-hex); }
        .bg-primary { background-color: var(--color-primary-hex); }
        .shadow-primary { box-shadow: 0 10px 15px -3px rgba(var(--color-primary), 0.2), 0 4px 6px -4px rgba(var(--color-primary), 0.1); }


        /* --- Feedback styling --- */
        /* --- MODIFIED: For inputs instead of buttons --- */
        .correct {
            border-color: rgba(16, 185, 129, 0.7) !important;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.35), rgba(16, 185, 129, 0.1)) !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5) !important;
        }
        .incorrect {
            border-color: rgba(239, 68, 68, 0.7) !important;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.35), rgba(239, 68, 68, 0.1)) !important;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5) !important;
        }
        
        #progress-bar {
            transition: width 0.5s ease-in-out;
            background-color: var(--color-primary-hex);
        }
        
        /* --- Liquid Glass Ripple Effect --- */
        .ripple-btn {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0); /* Force GPU acceleration */
            z-index: 1;
        }

        .ripple-btn::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            /* Use radial gradient for a soft, liquid ripple look */
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.4) 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform 0.6s, opacity 0.8s;
            border-radius: inherit; /* Inherit the button's rounded corners */
            z-index: -1;
        }

        .ripple-btn:active::after {
            transform: scale(0, 0);
            opacity: 1;
            transition: 0s;
        }

        /* --- START: Added styles for TTS --- */
        .tts-icon {
            display: inline-block;
            margin-left: 0.5rem;
            cursor: pointer;
            font-size: 1.1em; /* Adjust size as needed */
            vertical-align: middle;
            transition: transform 0.1s ease;
        }
        .tts-icon:active {
            transform: scale(0.9);
        }
        /* --- END: Added styles for TTS --- */

        /* --- Dark Mode Styles --- */
        .dark-mode {
            background: linear-gradient(135deg, var(--color-bg-dark-start), var(--color-bg-dark-mid), var(--color-bg-dark-end)); 
            color: var(--text-color-dark);
        }
        
        .dark-mode[data-text-hue="themed"] .text-gray-700,
        .dark-mode[data-text-hue="themed"] .text-gray-800,
        .dark-mode[data-text-hue="themed"] .text-gray-600 { 
            color: var(--color-primary-light); /* Use light primary color for text tint */
        }
        
        .dark-mode .liquid-glass-card {
            background: linear-gradient(135deg, rgba(55, 65, 81, 0.4), rgba(31, 41, 55, 0.5));
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); 
        }

        .dark-mode .frosted-option {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(107, 114, 128, 0.4);
        }
        .dark-mode .frosted-option:hover {
            background: rgba(31, 41, 55, 0.8);
        }
        
        /* Dark mode custom selector styles */
        .dark-mode .selector-item {
             border-bottom: 1px solid rgba(107, 114, 128, 0.4);
        }
        .dark-mode .selector-item.selected {
            background-color: rgba(var(--color-primary-light), 0.1);
        }
        .dark-mode .radio-circle {
            border: 2px solid #6b7280;
        }
        .dark-mode .radio-dot.selected {
            background-color: var(--color-primary-hex);
        }


        .dark-mode h1,
        .dark-mode .elegant-title { color: #ffffff; }

        .dark-mode input[type="text"], .dark-mode input[type="number"], .dark-mode textarea {
            background-color: rgba(31, 41, 55, 0.6) !important;
            color: var(--text-color-dark) !important; 
            border-color: rgba(107, 114, 128, 0.4);
            
            border-radius: var(--input-border-radius); 
            box-shadow: var(--input-shadow);
        }
        
        .dark-mode .prompt-box {
            background: linear-gradient(135deg, rgba(var(--color-primary-light), 0.3), rgba(var(--color-primary), 0.1)) !important;
            border-color: rgba(var(--color-primary), 0.5);
            color: #eef2ff;
        }
        
        /* --- MODIFIED: Dark mode feedback for inputs --- */
        .dark-mode .correct {
            border-color: rgba(52, 211, 153, 0.7) !important;
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.25), rgba(52, 211, 153, 0.1)) !important;
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.6) !important;
        }

        .dark-mode .incorrect {
            border-color: rgba(248, 113, 113, 0.7) !important;
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.25), rgba(248, 113, 113, 0.1)) !important;
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.6) !important;
        }
        
        /* --- START: Added dark mode overrides for results page --- */
        .dark-mode .bg-green-100 { 
            background-color: rgba(20, 83, 45, 0.4) !important; /* This is green-900/40 */
        }
        .dark-mode .bg-red-100 { 
            background-color: rgba(127, 29, 29, 0.4) !important; /* This is red-900/40 */
        }
        .dark-mode .text-green-700 { 
            color: #22c55e !important; /* A light green, e.g., green-500 */
        }
        .dark-mode .text-red-700 { 
            color: #f87171 !important; /* A light red, e.g., red-400 */
        }
        /* --- END: Added dark mode overrides for results page --- */

        /* (Keep MCQ dark mode styles for settings modal) */
        .dark-mode .mc-option {
            background-color: rgba(31, 41, 55, 0.7);
            border: 2px solid #374151; /* Gray 700 */
        }
        .dark-mode .mc-option:hover:not(.selected):not(.correct):not(.incorrect) {
            border-color: rgba(var(--color-primary), 0.7);
            background-color: rgba(var(--color-primary-light), 0.2);
        }
        .dark-mode .mc-option.selected {
            border-color: var(--color-primary-hex) !important;
            background-color: rgba(var(--color-primary-light), 0.2);
        }
        /* --- END DARK MODE STYLES --- */


        /* Set color variables for all text based on theme */
        body:not(.dark-mode)[data-contrast="default"] .text-gray-700,
        body:not(.dark-mode)[data-contrast="default"] .text-gray-800,
        body:not(.dark-mode)[data-contrast="default"] .text-gray-600 { color: var(--text-color-light) !important; }
        
        .dark-mode[data-contrast="default"] .text-gray-700,
        .dark-mode[data-contrast="default"] .text-gray-800,
        .dark-mode[data-contrast="default"] .text-gray-600 { color: var(--text-color-dark) !important; }

        /* NEW: High Contrast Text Styles */
        body:not(.dark-mode)[data-contrast="high"] .text-gray-700,
        body:not(.dark-mode)[data-contrast="high"] .text-gray-800,
        body:not(.dark-mode)[data-contrast="high"] .text-gray-600,
        body:not(.dark-mode)[data-contrast="high"] {
            color: var(--text-color-light) !important;
        }
        
        .dark-mode[data-contrast="high"] .text-gray-700,
        .dark-mode[data-contrast="high"] .text-gray-800,
        .dark-mode[data-contrast="high"] .text-gray-600,
        .dark-mode[data-contrast="high"] {
            color: var(--text-color-dark) !important;
        }
        
        /* Ensure input text is also high contrast */
        body[data-contrast="high"] input,
        body[data-contrast="high"] textarea {
             color: var(--text-color-light) !important;
        }
         .dark-mode[data-contrast="high"] input,
         .dark-mode[data-contrast="high"] textarea {
             color: var(--text-color-dark) !important;
        }


        /* Modal styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        /* New selection modal transition: Adjusted to look centered/higher */
        .selection-modal-content {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.3s forwards; 
            border-radius: 1.5rem; 
            
            width: 90%; 
            max-width: 400px;
            margin-bottom: 5vh; /* Adjusted vertical position */
        }
        
        /* Default modal styles remain for settings/data management */
        .modal-content {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- START: Added specific dark mode text colors needed --- */
        .dark-mode .text-gray-900 { color: #f9fafb !important; } /* gray-50 */
        .dark-mode .text-gray-800 { color: #f3f4f6 !important; } /* gray-100 */
        .dark-mode .text-gray-700 { color: #e5e7eb !important; } /* gray-200 */
        .dark-mode .text-gray-600 { color: #d1d5db !important; } /* gray-300 */
        /* --- END: Added specific dark mode text colors needed --- */

    </style>
    
    <style>
        /* --- Icon Base Styling --- */
        .icon-primary {
            color: var(--color-primary-hex) !important;
        }
        
        /* --- Icon Animations --- */
        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        @keyframes wiggle-icon {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        @keyframes bounce-icon {
            0%, 100% { transform: translateY(0) rotate(0); }
            50% { transform: translateY(-4px) rotate(3deg); }
        }

        /* --- 1. Game Hub (Home) Icon --- */
        #game-container a[href="game hub.html"] svg {
            color: var(--color-primary-hex) !important;
            transition: transform 0.3s ease;
        }
        #game-container a[href="game hub.html"]:hover svg {
            animation: bounce-icon 0.6s ease-in-out;
        }

        /* --- 2. Hamburger Menu Icon --- */
        #hamburger-button svg {
            color: var(--color-primary-hex) !important;
            transition: transform 0.3s ease;
        }
        #hamburger-button:hover svg {
            transform: scale(1.1) rotate(10deg);
        }
        
        /* --- 3. Dropdown Arrow Icon (Chevrons) --- */
        .frosted-option svg {
            color: var(--color-primary-hex);
            transition: transform 0.3s ease;
        }
        .frosted-option:hover svg {
            transform: scale(1.2);
        }

        /* --- 4. Close (X) Icon --- */
        #hamburger-menu button[onclick*="toggleHamburgerMenu"] svg,
        #selection-modal button[onclick*="closeSelectionModal"] svg {
            color: #ef4444; /* Red-500 */
            transition: transform 0.3s ease, color 0.3s ease;
        }
        #hamburger-menu button[onclick*="toggleHamburgerMenu"]:hover svg,
        #selection-modal button[onclick*="closeSelectionModal"]:hover svg {
            transform: scale(1.2) rotate(90deg);
            color: #b91c1c; /* Red-700 */
        }
        .dark-mode #hamburger-menu button[onclick*="toggleHamburgerMenu"] svg,
        .dark-mode #selection-modal button[onclick*="closeSelectionModal"] svg {
            color: #f87171; /* Red-400 */
        }
        .dark-mode #hamburger-menu button[onclick*="toggleHamburgerMenu"]:hover svg,
        .dark-mode #selection-modal button[onclick*="closeSelectionModal"]:hover svg {
            color: #ef4444; /* Red-500 */
        }

        /* --- 5. Theme Toggle Icons (Sun, Moon, System) --- */
        #menu-theme-toggle:hover #menu-theme-icon[class*="text-yellow-500"] {
             transform: rotate(90deg) scale(1.1); /* Sun */
        }
        #menu-theme-toggle:hover #menu-theme-icon[class*="text-purple-400"] {
             transform: scale(1.15); /* Moon */
        }
         #menu-theme-toggle:hover #menu-theme-icon[class*="icon-primary"] {
             transform: scale(1.1); /* System */
        }
        
        /* --- 6. Manage Data Icon (Database) --- */
        button[onclick*="openDataManagementFromMenu"] svg {
            transition: transform 0.3s ease;
        }
        button[onclick*="openDataManagementFromMenu"]:hover svg {
            animation: pulse-icon 1.2s infinite ease-in-out;
        }

        /* --- 7. App Settings Icon (Sliders) --- */
        button[onclick*="openSettings"] svg {
            color: var(--color-primary-hex);
            transition: transform 0.3s ease;
        }
        button[onclick*="openSettings"]:hover svg {
            animation: wiggle-icon 0.5s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div id="game-container" class="w-full max-w-xl liquid-glass-card p-6 md:p-8 my-8">
        
        <div class="flex justify-between items-center mb-6 border-b-2 pb-2 border-primary">
            
            <div class="flex items-center space-x-3">
                 <a href="game hub.html"
                    class="ripple-btn p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark-mode:bg-gray-700 dark-mode:hover:bg-gray-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-primary-hex"
                    aria-label="Go to Game Hub">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-800 dark-mode:text-gray-200">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
                     </svg>
                 </a>
                 <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark-mode:text-gray-50 mb-0 elegant-title">
                    VERB FORMS QUIZ
                </h1>
            </div>

            <div class="flex space-x-2">
                <button id="hamburger-button" onclick="window.toggleHamburgerMenu()" 
                        class="ripple-btn p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark-mode:bg-gray-700 dark-mode:hover:bg-gray-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-primary-hex">
                    <svg id="hamburger-icon" class="w-6 h-6 text-gray-800 dark-mode:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="quiz-status-bar" class="hidden">
            <div class="grid grid-cols-2 gap-4 items-center mb-3">
                <div class="flex items-center space-x-4">
                    <span class="text-gray-600 dark-mode:text-gray-400 text-base">Score: <span id="score-display" class="text-primary text-2xl font-bold">0</span></span>
                    <span class="text-gray-600 dark-mode:text-gray-400 text-base">Q: <span id="question-counter" class="text-primary text-2xl font-bold">0/15</span></span>
                </div>
                <span id="feedback-message" class="text-base font-medium text-right"></span>
            </div>
            
            <div id="progress-bar-container" class="w-full h-2 bg-gray-200 dark-mode:bg-gray-700 rounded-full overflow-hidden mb-6 shadow-inner">
                <div id="progress-bar" class="h-full rounded-full" style="width: 0%;"></div>
            </div>
        </div>


        <div id="start-screen" class="mt-8 text-center">
            <h2 class="text-3xl font-bold text-primary mb-4 elegant-title">Welcome to the Verb Forms Quiz!</h2>
            <p id="start-message" class="text-lg text-gray-700 dark-mode:text-gray-300 mb-8">
                Ready to test your knowledge? Set your quiz options below.
            </p>

            <div class="space-y-4">

                <div class="p-4 bg-primary/5 rounded-xl frosted-option">
                    <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Quiz Length</h3>
                    <button id="quiz-length-button" onclick="handleUiTapFeedback(); openSelectionModal('count')"
                            class="ripple-btn w-full p-3 flex justify-between items-center rounded-xl border-2 border-gray-300 dark-mode:border-gray-600 focus:ring-primary-hex focus:border-primary-hex transition duration-150 text-gray-800 dark-mode:text-gray-100 frosted-option">
                        <span id="current-quiz-length" class="font-semibold">15 Questions (Default)</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                        </svg>
                    </button>
                </div>
                
                <div id="tense-level-button-container" class="hidden p-4 bg-primary/5 rounded-xl frosted-option">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Verb Tense</h3>
                    <button id="tense-level-button" onclick="handleUiTapFeedback(); openSelectionModal('tense')"
                            class="ripple-btn w-full p-3 flex justify-between items-center rounded-xl border-2 border-gray-300 dark-mode:border-gray-600 focus:ring-primary-hex focus:border-primary-hex transition duration-150 text-gray-800 dark-mode:text-gray-100 frosted-option">
                        <span id="current-tense-level" class="font-semibold">All Tenses</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-500">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                        </svg>
                    </button>
                </div>

            </div>
            
            <button id="start-quiz-button" onclick="handleUiTapFeedback(); startQuiz()"
                    class="ripple-btn w-full px-4 py-4 mt-8 bg-green-600 text-white font-extrabold rounded-2xl shadow-xl shadow-green-500/50 hover:bg-green-700 transition duration-300 transform hover:scale-[1.01] text-xl disabled:bg-gray-400 disabled:shadow-none"
                    disabled>
                Start Quiz
            </button>
            <p id="loading-indicator" class="mt-4 text-sm text-gray-500">Loading initial data...</p>

        </div>
        
        <div id="question-area" class="space-y-4 hidden">
            <div class="prompt-box p-4 rounded-xl border-2 border-primary text-center">
                <p id="given-form-label" class="text-lg text-indigo-700 dark-mode:text-gray-300">Given Form (Base Form):</p>
                <p id="question-text" class="text-3xl text-indigo-900 font-bold mb-1 dark-mode:text-gray-100">
                    <span id="question-english-text">tease</span><span class="tts-icon" onclick="speakText(document.getElementById('question-english-text').innerText, 'en-US')">🔊</span>
                </p>
                <p id="question-metadata" class="text-lg text-indigo-700 dark-mode:text-gray-300">
                    <span id="question-telugu-text">ఏడిపించడం</span><span class="tts-icon" onclick="speakText(document.getElementById('question-telugu-text').innerText, 'te-IN')">🔊</span>
                </p>
            </div>
        <div id="forms-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
            
            <div id="explanation-area" class="hidden p-3 mt-4 rounded-xl border-2 border-primary bg-primary/10 dark-mode:bg-primary/5">
                <p class="font-bold text-sm mb-1 text-primary">Correct Answers:</p>
                <p id="explanation-text" class="text-gray-800 dark-mode:text-gray-200 text-base" style="line-height: 1.8;"></p>
            </div>
        </div>

        <div id="quiz-action-buttons" class="mt-8 grid grid-cols-2 gap-4 hidden">
            <button id="skip-button" onclick="handleUiTapFeedback(); skipQuestion()"
                    class="ripple-btn px-2 py-3 bg-yellow-500 text-white font-bold rounded-xl shadow-lg shadow-yellow-500/50 hover:bg-yellow-600 transition duration-150 focus:outline-none focus:ring-4 focus:ring-yellow-500 focus:ring-opacity-50 text-base md:text-lg">
                Skip
            </button>
            <button id="main-action-button" onclick="handleUiTapFeedback(); checkAnswer()"
                    class="ripple-btn px-2 py-3 bg-primary text-white font-bold rounded-xl shadow-lg shadow-indigo-500/50 hover:opacity-90 transition duration-150 disabled:bg-gray-400 focus:outline-none focus:ring-4 focus:ring-primary-hex focus:ring-opacity-50 text-base md:text-lg">
                Check Answer
            </button>
        </div>
        <div id="final-results" class="hidden mt-8 text-center p-4 bg-yellow-300/40 liquid-glass-card border-yellow-300 border-2">
            </div>

    </div>

    <div id="hamburger-menu" class="fixed top-0 right-0 h-full w-64 z-50 transform translate-x-full transition-transform duration-300 bg-white dark-mode:bg-gray-800 shadow-2xl p-6">
        <div class="flex justify-end">
            <button onclick="handleUiTapFeedback(); window.toggleHamburgerMenu()" class="ripple-btn p-2 rounded-full hover:bg-gray-100 dark-mode:hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-800 dark-mode:text-gray-200">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <h3 class="text-xl font-bold mb-6 text-gray-900 dark-mode:text-gray-100 border-b pb-2 border-primary">Menu</h3>

        <button id="menu-theme-toggle" onclick="handleUiTapFeedback(); toggleTheme()" 
                class="ripple-btn w-full flex items-center justify-between p-3 mb-4 rounded-xl text-gray-800 dark-mode:text-gray-200 frosted-option hover:bg-opacity-80 transition duration-150">
            <span id="menu-theme-text" class="font-semibold"></span>
            <svg id="menu-theme-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                </svg>
        </button>
        
        <div class="mb-4 p-3 bg-gray-100 dark-mode:bg-gray-700 rounded-xl text-xs text-gray-600 dark-mode:text-gray-400 overflow-x-auto break-all">
            <span class="font-bold">Status:</span> <span id="user-id-display">Local Data Storage</span>
        </div>

        <button onclick="handleUiTapFeedback(); openDataManagementFromMenu()"
                class="ripple-btn w-full flex items-center p-3 mb-4 rounded-xl text-white font-bold bg-primary hover:opacity-90 transition duration-150 shadow-md shadow-indigo-500/50">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.69 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.69-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0c0 2.278-3.69 4.125-8.25 4.125S3.75 12.331 3.75 10.056m16.5 0v3.75m-16.5-3.75v3.75m16.5 0c0 2.278-3.69 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
            </svg>
            Manage Verb Data
        </button>

        <button onclick="handleUiTapFeedback(); window.toggleHamburgerMenu(); openSettings();"
                class="ripple-btn w-full flex items-center p-3 rounded-xl text-gray-800 dark-mode:text-gray-200 frosted-option hover:bg-opacity-80 transition duration-150 shadow-md shadow-gray-500/10">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 12h9.75m-9.75 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0h3zm9-6h3.75m-3.75 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 18h9.75m-9.75 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0" />
            </svg>
            App Settings
        </button>
    </div>
    
    <div id="hamburger-overlay" class="hidden fixed inset-0 z-40 bg-black opacity-50" onclick="handleUiTapFeedback(); window.toggleHamburgerMenu()"></div>

    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="modal-content liquid-glass-card w-full max-w-sm p-6 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark-mode:text-gray-100 border-b pb-2 border-primary">App Settings</h2>

            <div class="bg-blue-100 dark-mode:bg-blue-900/40 border border-blue-400 text-blue-800 dark-mode:text-blue-200 text-sm p-3 rounded-xl mb-4">
                <p class="font-semibold">Shared settings (Theme, Color, Font, Contrast) are synced across all games. Game-specific settings are saved for this game only.</p>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-3">Color Accent (Shared)</h3>
                <div class="grid grid-cols-5 gap-2">
                    <button onclick="setThemeColor('Indigo')" data-color-id="Indigo"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-indigo-600 hover:opacity-90 text-sm">
                        Indigo
                    </button>
                    <button onclick="setThemeColor('Teal')" data-color-id="Teal"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-teal-600 hover:opacity-90 text-sm">
                        Teal
                    </button>
                    <button onclick="setThemeColor('Rose')" data-color-id="Rose"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-rose-600 hover:opacity-90 text-sm">
                        Rose
                    </button>
                    <button onclick="setThemeColor('Amber')" data-color-id="Amber"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-amber-600 hover:opacity-90 text-sm">
                        Amber
                    </button>
                    <button onclick="setThemeColor('Emerald')" data-color-id="Emerald"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-emerald-600 hover:opacity-90 text-sm">
                        Emerald
                    </button>
                    
                    <button onclick="setThemeColor('Cyan')" data-color-id="Cyan"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-cyan-600 hover:opacity-90 text-sm">
                        Cyan
                    </button>
                    <button onclick="setThemeColor('Pink')" data-color-id="Pink"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-pink-600 hover:opacity-90 text-sm">
                        Pink
                    </button>
                    <button onclick="setThemeColor('Orange')" data-color-id="Orange"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-orange-600 hover:opacity-90 text-sm">
                        Orange
                    </button>
                    <button onclick="setThemeColor('Purple')" data-color-id="Purple"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-purple-600 hover:opacity-90 text-sm">
                        Purple
                    </button>
                    <button onclick="setThemeColor('Sky')" data-color-id="Sky"
                            class="ripple-btn color-option p-2 rounded-xl shadow-md border-2 border-transparent transition duration-150 text-white font-bold bg-sky-600 hover:opacity-90 text-sm">
                        Sky
                    </button>
                    </div>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Text Contrast (Shared)</h3>
                <div class="flex space-x-4">
                    <button onclick="setTextContrast('default')" data-contrast-id="default" id="contrast-default"
                            class="ripple-btn flex-1 p-3 rounded-xl border-2 border-transparent text-gray-700 dark-mode:text-gray-300 frosted-option hover:bg-opacity-80 transition duration-150">
                        Default
                    </button>
                    <button onclick="setTextContrast('high')" data-contrast-id="high" id="contrast-high"
                            class="ripple-btn flex-1 p-3 rounded-xl border-2 border-transparent text-gray-700 dark-mode:text-gray-300 frosted-option hover:bg-opacity-80 transition duration-150">
                        High Contrast
                    </button>
                </div>
            </div>

            <div class="mb-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Body Font (Shared)</h3>
                <button id="body-font-button" onclick="handleUiTapFeedback(); openSelectionModal('body')"
                        class="ripple-btn w-full p-3 flex justify-between items-center rounded-xl border-2 border-gray-300 dark-mode:border-gray-600 focus:ring-primary-hex focus:border-primary-hex transition duration-150 text-gray-800 dark-mode:text-gray-100 frosted-option">
                    <span id="current-body-font" class="font-semibold">Inter (Sans-serif, Default)</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                    </svg>
                </button>
            </div>

            <div class="mb-6">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Title Font (Shared)</h3>
                <button id="title-font-button" onclick="handleUiTapFeedback(); openSelectionModal('title')"
                        class="ripple-btn w-full p-3 flex justify-between items-center rounded-xl border-2 border-gray-300 dark-mode:border-gray-600 focus:ring-primary-hex focus:border-primary-hex transition duration-150 text-gray-800 dark-mode:text-gray-100 frosted-option">
                    <span id="current-title-font" class="font-semibold">Lora (Serif, Default)</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                    </svg>
                </button>
            </div>


            <div class="mb-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Input Style (Game Specific)</h3>
                <div class="flex space-x-4">
                    <button onclick="setInputStyle('rounded')" data-style-id="rounded" id="style-rounded"
                            class="ripple-btn flex-1 p-3 rounded-xl border-2 border-transparent text-gray-700 dark-mode:text-gray-300 frosted-option hover:bg-opacity-80 transition duration-150">
                        Rounded
                    </button>
                    <button onclick="setInputStyle('square')" data-style-id="square" id="style-square"
                            class="ripple-btn flex-1 p-3 rounded-xl border-2 border-transparent text-gray-700 dark-mode:text-gray-300 frosted-option hover:bg-opacity-80 transition duration-150">
                        Square
                    </button>
                </div>
            </div>

            <div class="mb-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Feedback (Game Specific)</h3>
                <div class="flex flex-col space-y-2">
                    <label class="ripple-btn flex items-center space-x-3 cursor-pointer p-2 rounded-xl frosted-option hover:bg-opacity-80">
                        <input type="checkbox" id="toggle-audio" onclick="toggleAudio()" 
                                class="form-checkbox h-5 w-5 rounded text-primary-hex border-gray-300 dark-mode:bg-gray-700 transition duration-150 focus:ring-primary-hex">
                        <span class="text-gray-700 dark-mode:text-gray-300">Disable Sound Effects</span>
                    </label>
                    <label class="ripple-btn flex items-center space-x-3 cursor-pointer p-2 rounded-xl frosted-option hover:bg-opacity-80">
                        <input type="checkbox" id="toggle-haptics" onclick="toggleHaptics()" 
                                class="form-checkbox h-5 w-5 rounded text-primary-hex border-gray-300 dark-mode:bg-gray-700 transition duration-150 focus:ring-primary-hex">
                        <span class="text-gray-700 dark-mode:text-gray-300">Disable Vibration (Haptics)</span>
                    </label>
                </div>
            </div>

            <div class="mb-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2">Quiz Display (Game Specific)</h3>
                <div class="flex flex-col space-y-2">
                    <label class="ripple-btn flex items-center space-x-3 cursor-pointer p-2 rounded-xl frosted-option hover:bg-opacity-80">
                        <input type="checkbox" id="toggle-text-hue" onclick="toggleTextHue()" 
                                class="form-checkbox h-5 w-5 rounded text-primary-hex border-gray-300 dark-mode:bg-gray-700 transition duration-150 focus:ring-primary-hex">
                        <span class="text-gray-700 dark-mode:text-gray-300">Themed Text Hue (Subtle Color Tint)</span>
                    </label>
                </div>
            </div>
            
            <button onclick="handleUiTapFeedback(); closeSettings()"
                    class="ripple-btn mt-8 w-full py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition duration-150">
                Close Settings
            </button>
        </div>
    </div>
    
    <div id="selection-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
        <div class="selection-modal-content liquid-glass-card w-full max-w-sm p-0">
            <div class="p-4 flex justify-between items-center border-b dark-mode:border-gray-700">
                <h3 id="selection-modal-title" class="text-xl font-bold text-gray-900 dark-mode:text-gray-100">Select Option</h3>
                <button onclick="handleUiTapFeedback(); closeSelectionModal()" class="ripple-btn p-2 rounded-full hover:bg-gray-100 dark-mode:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-gray-800 dark-mode:text-gray-200">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="selection-modal-list" class="max-h-80 overflow-y-auto rounded-b-xl">
                </div>
        </div>
    </div>


    <div id="data-management-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="modal-content liquid-glass-card w-full max-w-3xl p-6 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark-mode:text-gray-100 border-b pb-2 border-primary">
                Manage Verb Data (<span id="current-question-count">0</span> Total)
            </h2>
            
            <button id="refresh-base-data" onclick="handleUiTapFeedback(); refreshBaseData()"
                    class="ripple-btn w-full py-2 mb-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-150">
                Fetch Latest Verbs.csv
            </button>
            <p id="refresh-feedback" class="text-center text-sm font-semibold mt-2 hidden"></p>

            
            <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2 mt-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                Manually Add a Custom Verb (All 5 Forms)
            </h3>
            <p class="text-sm text-gray-600 dark-mode:text-gray-400 mb-4">
                Enter the verb and its 4 other forms. This is added to your **Custom Verbs** list.
            </p>
            
            <div id="add-data-form" class="space-y-4 p-4 bg-primary/5 rounded-xl border border-primary/20 frosted-option">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="space-y-2">
                        <label for="add-v1" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V1 (Base Form)</label>
                        <input type="text" id="add-v1" placeholder="e.g., 'go'" class="w-full p-3">
                    </div>
                    <div class="space-y-2">
                        <label for="add-v1-te" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V1 (Telugu Meaning)</label>
                        <input type="text" id="add-v1-te" placeholder="e.g., 'వెళ్ళు'" class="w-full p-3">
                    </div>
                    
                    <div class="space-y-2">
                        <label for="add-v3s" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V (s/es Form)</label>
                        <input type="text" id="add-v3s" placeholder="e.g., 'goes'" class="w-full p-3">
                    </div>
                    <div class="space-y-2">
                        <label for="add-v3s-te" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V (s/es) (Telugu Meaning)</label>
                        <input type="text" id="add-v3s-te" placeholder="e.g., 'వెళ్తాడు/వెళ్తుంది'" class="w-full p-3">
                    </div>
                    
                    <div class="space-y-2">
                        <label for="add-ving" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V-ing (Present Participle)</label>
                        <input type="text" id="add-ving" placeholder="e.g., 'going'" class="w-full p-3">
                    </div>
                    <div class="space-y-2">
                        <label for="add-ving-te" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V-ing (Telugu Meaning)</label>
                        <input type="text" id="add-ving-te" placeholder="e.g., 'వెళుతూ'" class="w-full p-3">
                    </div>
                    
                    <div class="space-y-2">
                        <label for="add-v2" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V2 (Past Simple)</label>
                        <input type="text" id="add-v2" placeholder="e.g., 'went'" class="w-full p-3">
                    </div>
                    <div class="space-y-2">
                        <label for="add-v2-te" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V2 (Telugu Meaning)</label>
                        <input type="text" id="add-v2-te" placeholder="e.g., 'వెళ్ళింది'" class="w-full p-3">
                    </div>

                    <div class="space-y-2">
                        <label for="add-v3" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V3 (Past Participle)</label>
                        <input type="text" id="add-v3" placeholder="e.g., 'gone'" class="w-full p-3">
                    </div>
                    <div class="space-y-2">
                        <label for="add-v3-te" class="text-sm font-medium text-gray-700 dark-mode:text-gray-300 block">V3 (Telugu Meaning)</label>
                        <input type="text" id="add-v3-te" placeholder="e.g., 'వెళ్ళిపోయాడు'" class="w-full p-3">
                    </div>
                </div>

                <button id="save-question-button" onclick="handleUiTapFeedback(); saveNewQuestionData()"
                        class="ripple-btn w-full py-3 mt-4 bg-primary text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition duration-150 disabled:bg-gray-400">
                    Add Verb
                </button>
                <p id="data-management-feedback" class="text-center text-sm font-semibold mt-2 hidden"></p>
            </div>
            <h3 class="font-semibold text-lg text-gray-800 dark-mode:text-gray-300 mb-2 mt-6 border-t pt-4 border-gray-300 dark-mode:border-gray-700">
                Custom Verbs Added:
            </h3>
            
            <div id="user-data-list" class="space-y-2 max-h-48 overflow-y-auto p-2 border rounded-lg frosted-option">
                <p class="text-center text-gray-500" id="no-user-data">No custom verbs added yet.</p>
            </div>


            <button onclick="handleUiTapFeedback(); closeDataManagement()"
                    class="ripple-btn mt-8 w-full py-3 bg-gray-500 text-white font-bold rounded-xl hover:bg-gray-600 transition duration-150">
                Close Data Management
            </button>
        </div>
    </div>


    <script>
        // Data provided by the user (parsed from the uploaded CSV/Excel sheet)
        const INITIAL_DEFAULT_DATA_KEY = 'initialDefaultVerbData';
        
        // --- Configuration ---
        const QUESTION_OPTIONS = [5, 10, 15, 20, 30, 50]; 
        
        // --- MODIFIED: Removed TENSE_LEVELS, as this game mode doesn't need it ---
        
        // --- START: MODIFIED FONT/COLOR OPTIONS TO MATCH HUB ---
        // (These must be identical to game hub.html)
        const FONT_OPTIONS = {
            body: [
                { value: 'Inter', label: 'Inter (Sans-serif, Default)' },
                { value: 'Roboto', label: 'Roboto (Sans-serif)' },
                { value: 'Source Sans 3', label: 'Source Sans 3 (Sans-serif)' },
                { value: 'Merriweather', label: 'Merriweather (Serif)' },
                { value: 'Poppins', label: 'Poppins (Sans-serif)' }
            ],
            title: [
                { value: 'Lora', label: 'Lora (Serif, Default)' },
                { value: 'Playfair Display', label: 'Playfair Display (Serif)' },
                { value: 'Montserrat', label: 'Montserrat (Sans-serif)' },
                { value: 'Merriweather', label: 'Merriweather (Serif)' }
            ]
        };
        
        // NEW: Added COLOR_OPTIONS from game hub.html
        const COLOR_OPTIONS = [
            { id: 'Indigo', bg: 'bg-indigo-600' },
            { id: 'Teal', bg: 'bg-teal-600' },
            { id: 'Rose', bg: 'bg-rose-600' },
            { id: 'Amber', bg: 'bg-amber-600' },
            { id: 'Emerald', bg: 'bg-emerald-600' },
            { id: 'Cyan', bg: 'bg-cyan-600' },
            { id: 'Pink', bg: 'bg-pink-600' },
            { id: 'Orange', bg: 'bg-orange-600' },
            { id: 'Purple', bg: 'bg-purple-600' },
            { id: 'Sky', bg: 'bg-sky-600' },
        ];
        // --- END: MODIFIED FONT/COLOR OPTIONS ---
        
        // Default game settings
        const DEFAULT_MAX_QUESTIONS = 15;
        // --- MODIFIED: Removed DEFAULT_TENSE ---


        // --- Game State ---
        let maxQuestions = DEFAULT_MAX_QUESTIONS;
        // --- MODIFIED: Removed selectedTense ---
        let verbs = []; // All available verbs (Base + Custom)
        let questionPool = []; // Final selected questions (objects)
        let quizLimit = DEFAULT_MAX_QUESTIONS; // Max questions for the current run
        
        let currentQuestionData = null; // This will now be the full verb object
        // --- MODIFIED: Removed selectedOption ---
        let score = 0;
        let questionsAsked = 0; 
        let quizResults = [];
        let isDataLoaded = false;
        let currentSelectionType = null;
        let quizPhase = 'select'; // 'select' (checking answer) or 'next' (ready for next)

        // --- START: MODIFIED STORAGE KEYS ---
        // Key for SHARED settings across all games (from game hub)
        const GLOBAL_SETTINGS_KEY = 'globalHubSettings'; 
        // Key for settings SPECIFIC to this verb game
        const SETTINGS_KEY = 'verbQuizSettings'; // Changed from 'quizSettings' for clarity
        // Key for custom verb data
        const CUSTOM_DATA_KEY = 'customVerbData';
        // --- END: MODIFIED STORAGE KEYS ---

        // --- Column Indices (10-column CSV structure) ---
        // Base Form,Telugu,3rd Person Singular,Telugu ( he she it),-ing Form,Telugu4,Past Simple,Telugu2,Past Participle,Telugu3
        const COL_V1 = 0;
        const COL_V1_TE = 1;
        const COL_V3S = 2;
        const COL_V3S_TE = 3;
        const COL_VING = 4;
        const COL_VING_TE = 5;
        const COL_V2 = 6;
        const COL_V2_TE = 7;
        const COL_V3 = 8;
        const COL_V3_TE = 9;
        const EXPECTED_COLUMNS = 10;
        
        // --- Tone.js Audio Setup (No changes) ---
        let correctSynth;
        let incorrectSynth;
        let clickSynth;

        const setupAudio = () => {
            correctSynth = new Tone.MembraneSynth().toDestination();
            correctSynth.set({ oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 }, pitchDecay: 0.05 });
            incorrectSynth = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination();
            clickSynth = new Tone.Synth({ 
                oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.05, sustain: 0 }
            }).toDestination();
        }

        const playCorrect = () => { 
            const disableSound = getLocalSetting('disableSound', false);
            if (!disableSound) { Tone.context.resume().then(() => { correctSynth.triggerAttackRelease("G5", "8n"); }); } 
        }
        const playIncorrect = () => { 
            const disableSound = getLocalSetting('disableSound', false);
            if (!disableSound) { Tone.context.resume().then(() => { incorrectSynth.triggerAttackRelease("16n"); }); } 
        }
        const playClick = () => {
            const disableSound = getLocalSetting('disableSound', false);
            if (!disableSound) { Tone.context.resume().then(() => { clickSynth.triggerAttackRelease("C5", "32n"); }); } 
        }
        
        const vibrateCorrect = () => { 
            const disableVibration = getLocalSetting('disableVibration', false);
            if (!disableVibration && navigator.vibrate) { navigator.vibrate(100); } 
        };
        const vibrateIncorrect = () => { 
            const disableVibration = getLocalSetting('disableVibration', false);
            if (!disableVibration && navigator.vibrate) { navigator.vibrate([100, 50, 100]); } 
        };
        const vibrateClick = () => { 
            const disableVibration = getLocalSetting('disableVibration', false);
            if (!disableVibration && navigator.vibrate) { navigator.vibrate(30); } 
        };

        window.handleUiTapFeedback = function() {
            playClick();
            vibrateClick();
        }
        // --- End Haptic/Audio Feedback Setup ---
        
        // --- START: Added TTS Function ---
        /**
         * Speaks the given text using the specified language code.
         * @param {string} text - The text to speak.
         * @param {string} lang - The language code (e.g., 'en-US', 'te-IN').
         */
        function speakText(text, lang) {
            if (!text || typeof text !== 'string' || text.trim() === '' || text.trim().toLowerCase() === 'n/a') {
                console.warn("TTS: No valid text provided.");
                return;
            }
            if (!('speechSynthesis' in window)) {
                console.warn("TTS: Speech synthesis not supported by this browser.");
                // Optionally show a message to the user
                return;
            }
            
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            
            // Optional: Find a specific voice if available (enhances Telugu support if multiple voices exist)
            const voices = window.speechSynthesis.getVoices();
            const specificVoice = voices.find(voice => voice.lang === lang);
            if (specificVoice) {
                 utterance.voice = specificVoice;
            } else {
                 console.warn(`TTS: No specific voice found for lang=${lang}. Using default.`);
            }

            utterance.onerror = (event) => {
                console.error(`TTS Error: ${event.error}`);
                // Optionally inform the user about the error
            };

            window.speechSynthesis.speak(utterance);
        }

        // Pre-load voices (recommended for better performance/reliability)
        if ('speechSynthesis' in window && window.speechSynthesis.onvoiceschanged !== undefined) {
             window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        }
        // --- END: Added TTS Function ---

        // --- Theme and Settings Management (No changes) ---
        const DARK_CLASS = 'dark-mode';
        
        // --- START: MODIFIED SETTINGS FUNCTIONS ---
        // (These now match game hub.html and English vocabulary game.html)

        // Gets GAME-SPECIFIC settings
        const getLocalSetting = (key, defaultValue) => {
            try {
                const settingsString = localStorage.getItem(SETTINGS_KEY);
                if (!settingsString) return defaultValue;
                
                const settings = JSON.parse(settingsString);
                
                if (key === 'maxQuestions') {
                    const parsed = parseInt(settings[key]);
                    return isNaN(parsed) ? defaultValue : parsed;
                }
                
                if (typeof settings[key] === 'undefined' || settings[key] === null) {
                    return defaultValue;
                }
                return settings[key];

            } catch (e) {
                console.error(`Error loading local setting key ${key}:`, e);
                return defaultValue;
            }
        };

        // Saves GAME-SPECIFIC settings
        const saveLocalSetting = (key, value) => {
            try {
                const settingsString = localStorage.getItem(SETTINGS_KEY);
                let settings = settingsString ? JSON.parse(settingsString) : {};
                
                settings[key] = value;
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
                
            } catch (e)
                {
                console.error(`Error saving local setting key ${key}:`, e);
            }
        }

        // Gets GLOBAL (shared) settings (from hub)
        const getGlobalSetting = (key, defaultValue) => {
            try {
                const settingsString = localStorage.getItem(GLOBAL_SETTINGS_KEY);
                if (!settingsString) return defaultValue;
                const settings = JSON.parse(settingsString);
                return (settings && typeof settings[key] !== 'undefined') ? settings[key] : defaultValue;
            } catch (e) {
                console.error("Error reading global setting:", key, e);
                return defaultValue;
            }
        };

        // Saves GLOBAL (shared) settings (from hub)
        const setGlobalSetting = (key, value) => {
            try {
                const settingsString = localStorage.getItem(GLOBAL_SETTINGS_KEY);
                let settings = settingsString ? JSON.parse(settingsString) : {};
                settings[key] = value;
                localStorage.setItem(GLOBAL_SETTINGS_KEY, JSON.stringify(settings));
            } catch (e) {
                console.error("Error saving global setting:", key, e);
            }
        };
        
        // --- NEW: applyAccentColor (from hub) ---
        function applyAccentColor(colorName) {
            if (!colorName || !COLOR_OPTIONS.find(c => c.id === colorName)) {
                colorName = 'Indigo'; // Default
            }
            document.body.setAttribute('data-color', colorName);
        }

        // --- NEW: applyTheme (from hub) ---
        // This function *only* handles dark/light mode
        function applyTheme(isDark) {
            const body = document.body;
            const savedTheme = getGlobalSetting('theme', 'auto');

            if (isDark) {
                body.classList.add(DARK_CLASS);
            } else {
                body.classList.remove(DARK_CLASS);
            }
            updateHamburgerMenuUI(savedTheme);
        }

        // --- NEW: applyFont (from hub) ---
        function applyFont(type, fontFamily) {
            const root = document.documentElement.style;
            let fallback = 'sans-serif';
            let defaultFont = 'Inter';
            let key = '--font-body';

            if (type === 'title') {
                fallback = 'serif';
                defaultFont = 'Lora';
                key = '--font-title';
            }

            if (!fontFamily || !FONT_OPTIONS[type].find(f => f.value === fontFamily)) {
                fontFamily = defaultFont;
            }
            
            // Check if selected font is serif to adjust fallback
            if (fontFamily === 'Merriweather' || fontFamily === 'Lora' || fontFamily === 'Playfair Display') {
                fallback = 'serif';
            } else {
                fallback = 'sans-serif';
            }

            root.setProperty(key, `"${fontFamily}", ${fallback}`);
        }
        
        // --- NEW: applyContrast (from hub) ---
        function applyContrast(contrast) {
            if (contrast !== 'high') {
                contrast = 'default';
            }
            document.body.setAttribute('data-contrast', contrast);
        }
        
        // --- NEW: applyTextHue (LOCAL setting) ---
        function applyTextHue() {
            const textHue = getLocalSetting('textHue', false);
            document.body.setAttribute('data-text-hue', textHue ? 'themed' : 'default');
        }

        // --- NEW: applyInputStyles (LOCAL setting) ---
        function applyInputStyles() {
            const style = getLocalSetting('inputStyle', 'rounded');
            const root = document.documentElement.style;
            if (style === 'square') {
                root.setProperty('--input-border-radius', '0.5rem'); 
                root.setProperty('--input-shadow', '0 2px 4px rgba(0,0,0,0.1)');
            } else { 
                root.setProperty('--input-border-radius', '1.5rem'); 
                root.setProperty('--input-shadow', '0 4px 6px rgba(0,0,0,0.05)');
            }
        }
        
        // UPDATED: Cycles theme and saves to GLOBAL
        function toggleTheme() {
            const currentMode = getGlobalSetting('theme', 'auto'); // Hub uses 'auto'
            let newMode;
            
            if (currentMode === 'auto') {
                newMode = 'light';
            } else if (currentMode === 'light') {
                newMode = 'dark';
            } else { // 'dark'
                newMode = 'auto';
            }
            
            setGlobalSetting('theme', newMode); // Save to global
            
            // Apply the change
            let isDark;
            if (newMode === 'auto') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else {
                isDark = (newMode === 'dark');
            }
            applyTheme(isDark);
        }
        
        // UPDATED: Saves to GLOBAL using hub's key 'colorTheme'
        function setThemeColor(color) { // color is 'Indigo', 'Teal'
            setGlobalSetting('colorTheme', color); // Use hub's key
            applyAccentColor(color);
            updateSettingsUI();
        }
        
        // UPDATED: Saves to GLOBAL
        function setTextContrast(contrast) {
            setGlobalSetting('contrast', contrast);
            applyContrast(contrast);
            updateSettingsUI();
        }
        
        // UPDATED: Saves to GLOBAL using hub's simple format
        window.setBodyFont = function(font) { // font is 'Inter', 'Roboto'
            setGlobalSetting('bodyFont', font); // Hub just saves the name
            applyFont('body', font);
            updateSettingsUI(); 
        }

        // UPDATED: Saves to GLOBAL using hub's simple format
        window.setTitleFont = function(font) { // font is 'Lora', 'Montserrat'
            setGlobalSetting('titleFont', font); // Hub just saves the name
            applyFont('title', font);
            updateSettingsUI(); 
        }
        
        // Saves GAME-SPECIFIC (LOCAL) setting
        function setInputStyle(style) {
            saveLocalSetting('inputStyle', style);
            applyInputStyles();
            updateSettingsUI();
        }

        // Saves GAME-SPECIFIC (LOCAL) setting
        function toggleAudio() {
            const currentState = getLocalSetting('disableSound', false);
            saveLocalSetting('disableSound', !currentState);
            updateSettingsUI();
        }

        // Saves GAME-SPECIFIC (LOCAL) setting
        function toggleHaptics() {
            const currentState = getLocalSetting('disableVibration', false);
            saveLocalSetting('disableVibration', !currentState);
            updateSettingsUI();
        }
        
        // UPDATED: Saves to GAME-SPECIFIC (LOCAL) setting
        function toggleTextHue() {
            const currentState = getLocalSetting('textHue', false);
            saveLocalSetting('textHue', !currentState); // Use local storage
            applyTextHue();
            updateSettingsUI();
        }

        // NEW: UI update for quiz settings handlers (Game-specific)
        window.handleQuestionCountChange = function(value) {
            const count = parseInt(value);
            maxQuestions = count;
            quizLimit = count;
            saveLocalSetting('maxQuestions', count);
            updateStartScreenMessage();
        }
        
        // --- MODIFIED: Removed handleTenseLevelChange ---
        
        // This function updates the UI based on GAME-SPECIFIC storage
        function updateSettingsUI() {
            // Read all settings
            const color = getGlobalSetting('colorTheme', 'Indigo'); // Read from global
            const contrast = getGlobalSetting('contrast', 'default'); // Read from global
            const inputStyle = getLocalSetting('inputStyle', 'rounded'); // Read from local
            const disableSound = getLocalSetting('disableSound', false); // Read from local
            const disableVibration = getLocalSetting('disableVibration', false); // Read from local
            const textHue = getLocalSetting('textHue', false); // Read from local
            
            // Highlight active color
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.toggle('border-white', btn.dataset.colorId === color);
                btn.classList.toggle('border-4', btn.dataset.colorId === color);
            });
            
            // Highlight active contrast/input style
            document.querySelectorAll('[data-contrast-id], [data-style-id]').forEach(btn => {
                const isActive = (btn.dataset.contrastId === contrast) || (btn.dataset.styleId === inputStyle);
                btn.classList.toggle('ring-4', isActive);
                btn.classList.toggle('ring-primary-hex', isActive);
            });
            
            // Update toggles (game-specific)
            document.getElementById('toggle-audio').checked = disableSound;
            document.getElementById('toggle-haptics').checked = disableVibration;
            document.getElementById('toggle-text-hue').checked = textHue;
            
            // Update buttons reflecting selected values
            updateQuizLengthButton(); // game-specific
            // --- MODIFIED: Removed updateTenseLevelButton call ---
            updateFontButton('body'); // shared
            updateFontButton('title'); // shared

            document.getElementById('score-display').style.color = `var(--color-primary-hex)`;
            document.getElementById('question-counter').style.color = `var(--color-primary-hex)`;
        }
        
        // --- MODIFIED: Removed updateTenseLevelButton function ---
        
        // UI update for quiz length button (Game-specific)
        function updateQuizLengthButton() {
            const button = document.getElementById('current-quiz-length');
            if (button) {
                const label = getLabel('count', maxQuestions); 
                button.textContent = label;
            }
        }

        // Hamburger menu UI (MODIFIED to match vocab game colors)
        function updateHamburgerMenuUI(savedTheme) {
            if (!savedTheme) {
                 savedTheme = getGlobalSetting('theme', 'auto'); // Hub uses 'auto'
            }
            const iconContainer = document.getElementById('menu-theme-icon');
            const textContainer = document.getElementById('menu-theme-text');
            
            iconContainer.className = "w-6 h-6 transition-transform duration-300";

            if (savedTheme === 'auto') { // Hub uses 'auto'
                iconContainer.classList.add('icon-primary'); 
                iconContainer.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 12h16.5m-16.5 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0h3zm9-6h3.75m-3.75 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 18h16.5m-16.5 0a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0h3z" />`;
                textContainer.textContent = "Theme: System";
            } else if (savedTheme === 'light') {
                iconContainer.classList.add('text-yellow-500'); 
                iconContainer.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`;
                textContainer.textContent = "Theme: Light";
            } else { // 'dark'
                iconContainer.classList.add('text-purple-400'); 
                iconContainer.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.593.748-3.752A9.753 9.753 0 009 12.75a9.75 9.75 0 0011.002 9.75z" />`;
                textContainer.textContent = "Theme: Dark";
            }
        }
        
        // --- REPLACED: loadInitialTheme() with loadInitialSettings() from hub ---
        function loadInitialSettings() {
            // --- 1. Load GLOBAL Settings (from hub) ---
            const savedTheme = getGlobalSetting('theme', 'auto'); // Hub uses 'auto'
            const colorTheme = getGlobalSetting('colorTheme', 'Indigo'); // Hub uses 'colorTheme'
            const bodyFont = getGlobalSetting('bodyFont', 'Inter'); // Hub saves simple name
            const titleFont = getGlobalSetting('titleFont', 'Lora'); // Hub saves simple name
            const savedContrast = getGlobalSetting('contrast', 'default');
            
            // Determine dark mode
            let isDark;
            if (savedTheme === 'auto') {
                isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else {
                isDark = (savedTheme === 'dark');
            }
            
            // Apply GLOBAL settings
            applyTheme(isDark); // Applies dark mode & updates icon
            applyAccentColor(colorTheme); // Applies color
            applyFont('body', bodyFont); // Applies body font
            applyFont('title', titleFont); // Applies title font
            applyContrast(savedContrast); // Applies contrast
            
            // --- 2. Load LOCAL Settings (Game-Specific) ---
            maxQuestions = getLocalSetting('maxQuestions', DEFAULT_MAX_QUESTIONS);
            quizLimit = maxQuestions;
            // --- MODIFIED: Removed selectedTense ---
            
            // Apply LOCAL settings
            applyInputStyles(); // Applies local input style
            applyTextHue(); // Applies local text hue
            
            // --- 3. Update UI ---
            // This updates the modal UI to reflect all loaded settings
            updateSettingsUI(); 
        }
        // --- END: REPLACEMENT ---
        
        // --- End Theme and Settings Management ---
        
        // --- Modals and Helpers (Globalized for button access) ---

        window.openSelectionModal = function(type) {
            currentSelectionType = type;
            const modal = document.getElementById('selection-modal');
            const titleEl = document.getElementById('selection-modal-title');
            const listEl = document.getElementById('selection-modal-list');
            
            listEl.innerHTML = '';
            let optionsHTML = '';
            let currentVal;

            switch(type) {
                case 'count':
                    titleEl.textContent = 'Select Quiz Length';
                    currentVal = maxQuestions;
                    optionsHTML = QUESTION_OPTIONS.map(count => 
                        renderOption('count', count, `${count} Questions${count === DEFAULT_MAX_QUESTIONS ? ' (Default)' : ''}`, currentVal, 'handleSelectionChange')
                    ).join('');
                    break;
                // --- MODIFIED: Removed 'tense' case ---
                case 'body':
                    titleEl.textContent = 'Select Body Font';
                    currentVal = getGlobalSetting('bodyFont', 'Inter'); // Read from global
                    optionsHTML = FONT_OPTIONS.body.map(font => 
                        renderOption('body-font', font.value, font.label, currentVal, 'handleSelectionChange')
                    ).join('');
                    break;
                case 'title':
                    titleEl.textContent = 'Select Title Font';
                    currentVal = getGlobalSetting('titleFont', 'Lora'); // Read from global
                    optionsHTML = FONT_OPTIONS.title.map(font => 
                        renderOption('title-font', font.value, font.label, currentVal, 'handleSelectionChange')
                    ).join('');
                    break;
            }
            
            listEl.innerHTML = optionsHTML;
            modal.classList.remove('hidden');
        }
        
        window.closeSelectionModal = function() {
            document.getElementById('selection-modal').classList.add('hidden');
            currentSelectionType = null;
        }

        window.handleSelectionChange = function(value) {
            switch(currentSelectionType) {
                case 'count':
                    handleQuestionCountChange(value);
                    updateQuizLengthButton();
                    break;
                // --- MODIFIED: Removed 'tense' case ---
                case 'body':
                    setBodyFont(value); // This now syncs to global
                    updateFontButton('body');
                    break;
                case 'title':
                    setTitleFont(value); // This now syncs to global
                    updateFontButton('title');
                    break;
            }
            closeSelectionModal();
        }

        window.openSettings = function() { 
            document.getElementById('settings-modal').classList.remove('hidden'); 
            updateSettingsUI();
        }
        window.closeSettings = function() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        window.toggleHamburgerMenu = function() {
            handleUiTapFeedback();
            const menu = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('hamburger-overlay');
            const isOpen = menu.classList.contains('translate-x-full');
            
            if (isOpen) {
                menu.classList.remove('translate-x-full');
                menu.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; 
            } else {
                menu.classList.remove('translate-x-0');
                menu.classList.add('translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
            updateHamburgerMenuUI(); // Pass no param, it will read from storage
        }
        
        window.openDataManagement = function() {
            document.getElementById('data-management-modal').classList.remove('hidden');
            renderUserDataList();
            document.getElementById('current-question-count').textContent = verbs.length;
            
            // Clear refresh feedback message on open
            const feedbackEl = document.getElementById('refresh-feedback');
            feedbackEl.classList.add('hidden');
            feedbackEl.textContent = '';
        }

        window.openDataManagementFromMenu = function() {
            window.toggleHamburgerMenu();
            window.openDataManagement();
        }

        window.closeDataManagement = function() {
            document.getElementById('data-management-modal').classList.add('hidden');
            resetQuizAndReloadData(); 
            showDataFeedback('', 'green', true);
        }

        function showDataFeedback(message, type = 'gray', hide = false) {
            const feedbackEl = document.getElementById('data-management-feedback');
            feedbackEl.textContent = message;
            feedbackEl.className = `text-center text-sm font-semibold mt-2 text-${type}-600`;
            if (hide) {
                 feedbackEl.classList.add('hidden');
            } else {
                 feedbackEl.classList.remove('hidden');
            }
        }

        function renderOption(type, value, label, currentValue, handler) {
            const isSelected = value.toString() === currentValue.toString();
            const selectedClass = isSelected ? 'selected' : '';
            
            let styleAttr = '';
            if (type.includes('font')) {
                const fallback = (value === 'Lora' || value === 'Playfair Display' || value === 'Merriweather') ? 'serif' : 'sans-serif'; 
                styleAttr = `style="font-family: '${value}', ${fallback};"`;
            }

            return `
                <div class="ripple-btn selector-item ${selectedClass}" 
                     onclick="handleUiTapFeedback(); ${handler}('${value}')"
                     ${styleAttr}>
                    <span>${label}</span>
                    <div class="radio-circle ${selectedClass}">
                        <div class="radio-dot ${selectedClass}"></div>
                    </div>
                </div>
            `;
        }
        
        function getLabel(type, value) {
             if (type === 'count') {
                const limit = parseInt(value);
                return `${limit} Questions${limit === DEFAULT_MAX_QUESTIONS ? ' (Default)' : ''}`;
            }
            // --- MODIFIED: Removed 'tense' case ---
            const options = FONT_OPTIONS[type];
            if (!options) return value;
            const option = options.find(opt => opt.value === value);
            return option ? option.label : value;
        }

        function updateFontButton(type) {
            const id = type === 'body' ? 'current-body-font' : 'current-title-font';
            const defaultFont = type === 'body' ? 'Inter' : 'Lora';
            const value = getGlobalSetting(type === 'body' ? 'bodyFont' : 'titleFont', defaultFont); // Read from global
            const button = document.getElementById(id);
            if (button) {
                button.textContent = getLabel(type, value);
            }
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // --- MODIFIED: Removed getRandomItems, as it's not needed for this game type ---

        // --- START: MODIFIED - Added helper function ---
        /**
         * Returns a human-readable label for a verb form key.
         * @param {string} formKey - e.g., 'v1', 'v3s', 'ving', 'v2', 'v3'
         * @returns {string} - e.g., 'Base Form (V1)'
         */
        function getFormLabel(formKey) {
            switch (formKey) {
                case 'v1': return 'Base Form (V1)';
                case 'v3s': return '3rd Person Singular';
                case 'ving': return '-ing Form';
                case 'v2': return 'Past Simple (V2)';
                case 'v3': return 'Past Participle (V3)';
                default: return 'Unknown Form';
            }
        }
        // --- END: MODIFIED ---

        // <!--- START: NEW TTS HELPER FUNCTIONS (MOVED HERE) --->
        // Helper to safely escape text for onclick attribute
        const escape = (text) => text ? text.replace(/'/g, "\\'") : '';
        
        // Helper to create a TTS icon
        const tts = (text, lang) => text ? `<span class="tts-icon" onclick="speakText('${escape(text)}', '${lang}')">🔊</span>` : '';
        // <!--- END: NEW TTS HELPER FUNCTIONS --->


        // --- Data Parsing and Management (No changes) ---

        let baseCsvContent = ''; // Store the fetched CSV content

        /** Fetches the Verbs.csv file and stores its content */
        async function fetchVerbData() {
             // Initialize default data if it doesn't exist
            if (!localStorage.getItem(INITIAL_DEFAULT_DATA_KEY)) {
                document.getElementById('loading-indicator').textContent = 'Fetching verbs data...';
                try {
                    // --- MODIFICATION: Added cache-busting query parameter ---
                    const response = await fetch(`Verbs.csv?t=${new Date().getTime()}`); 
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    localStorage.setItem(INITIAL_DEFAULT_DATA_KEY, csvText); 
                    baseCsvContent = csvText;
                } catch (e) {
                    console.error("Failed to fetch initial Verbs.csv:", e);
                    document.getElementById('start-message').innerHTML = '<strong>Error:</strong> Could not load <code>Verbs.csv</code>. Please ensure the file is in the same directory as this HTML file and refresh the page.';
                    document.getElementById('loading-indicator').textContent = 'Load failed.';
                    return; // Stop initialization
                }
            } else {
                 baseCsvContent = localStorage.getItem(INITIAL_DEFAULT_DATA_KEY);
            }
        }

        function parseCSVLine(line) {
            const columns = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            return columns.map(col => 
                col.trim().replace(/^"|"$/g, '').trim() 
            );
        }

        // --- START: JAVASCRIPT MODIFIED ---
        function createVerbObject(dataArray, isCustom = false) {
            // Base CSV parsing
            if (!isCustom && dataArray.length < EXPECTED_COLUMNS) return null;
            // Custom data parsing (now expects 10 fields: 5 English, 5 Telugu)
            if (isCustom && dataArray.length < 10) return null; 

            const getField = (index) => dataArray[index] ? dataArray[index].trim() : '';
            
            if (isCustom) {
                return {
                    v1: getField(0),      // English V1
                    v3s: getField(2),     // English V3s
                    ving: getField(4),    // English V-ing
                    v2: getField(6),      // English V2
                    v3: getField(8),      // English V3
                    telugu: { 
                        v1: getField(1) || 'N/A',   // Telugu V1 (default to N/A if empty)
                        v3s: getField(3) || 'N/A',  // Telugu V3s
                        ving: getField(5) || 'N/A', // Telugu V-ing
                        v2: getField(7) || 'N/A',   // Telugu V2
                        v3: getField(9) || 'N/A'    // Telugu V3
                    },
                    source: 'custom'
                }
            } else {
                 return {
                    v1: getField(COL_V1),
                    v3s: getField(COL_V3S),
                    ving: getField(COL_VING),
                    v2: getField(COL_V2),
                    v3: getField(COL_V3),
                    telugu: {
                        v1: getField(COL_V1_TE) || 'N/A', // Default to N/A if empty in CSV
                        v3s: getField(COL_V3S_TE) || 'N/A',
                        ving: getField(COL_VING_TE) || 'N/A',
                        v2: getField(COL_V2_TE) || 'N/A',
                        v3: getField(COL_V3_TE) || 'N/A'
                    },
                    source: 'base'
                };
            }
        }
        // --- END: JAVASCRIPT MODIFIED ---
        
        function loadCustomVerbs() {
            try {
                const customData = localStorage.getItem(CUSTOM_DATA_KEY);
                return customData ? JSON.parse(customData) : [];
            } catch (e) {
                console.error("Error loading custom verbs from storage:", e);
                localStorage.removeItem(CUSTOM_DATA_KEY);
                return [];
            }
        }
        
        function saveCustomVerbs(data) {
            try {
                localStorage.setItem(CUSTOM_DATA_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving custom verbs to storage:", e);
            }
        }
        
        function parseAndLoadVerbs() {
            let baseVerbs = [];
            // --- MODIFICATION: Handle empty baseCsvContent ---
            if (!baseCsvContent) {
                console.warn("parseAndLoadVerbs: baseCsvContent is empty. Skipping parse.");
                // We still need to load custom verbs, though.
            } else {
                const lines = baseCsvContent.trim().split('\n');
                const dataLines = lines.slice(1);
                let validBaseVerbs = 0;

                dataLines.forEach(line => {
                    const columns = parseCSVLine(line);
                    const verb = createVerbObject(columns, false);
                    if (verb) {
                        baseVerbs.push(verb);
                        validBaseVerbs++;
                    }
                });
            }
            
            const customVerbs = loadCustomVerbs();
            verbs = [...baseVerbs, ...customVerbs];
            
            isDataLoaded = true;
            document.getElementById('current-question-count').textContent = verbs.length;
            updateStartScreenMessage();
            return baseVerbs.length; // Return count of base verbs
        }

        // --- START: JAVASCRIPT MODIFIED (Display V1 Telugu in list) ---
        function renderUserDataList() {
            const listEl = document.getElementById('user-data-list');
            const customVerbs = loadCustomVerbs();
            listEl.innerHTML = '';
            
            if (customVerbs.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500" id="no-user-data">No custom verbs added yet.</p>';
                return;
            }
            
            customVerbs.forEach((v, index) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-start p-2 border-b dark-mode:border-gray-700 hover:bg-opacity-80 rounded-md transition duration-150';
                // Display V1 English and V1 Telugu
                const teluguV1 = (v.telugu && v.telugu.v1 && v.telugu.v1 !== 'N/A') ? ` (${v.telugu.v1})` : '';
                item.innerHTML = `
                    <div class="flex-1 min-w-0 mr-4">
                        <span class="font-semibold text-primary dark-mode:text-primary-light line-clamp-1">${v.v1}${teluguV1}</span>
                        <p class="text-xs text-gray-600 dark-mode:text-gray-400 truncate">${v.v3s} / ${v.ving} / ${v.v2} / ${v.v3}</p>
                    </div>
                    <button onclick="handleUiTapFeedback(); deleteCustomQuestion(${index})" class="ripple-btn p-2 rounded-lg text-red-500 hover:text-red-700 text-sm flex-shrink-0">
                        Remove
                    </button>
                `;
                listEl.appendChild(item);
            });
        }
        
        window.deleteCustomQuestion = function(index) {
            const customVerbs = loadCustomVerbs();
            if (index >= 0 && index < customVerbs.length) {
                customVerbs.splice(index, 1);
                saveCustomVerbs(customVerbs);
                renderUserDataList();
                // --- Re-parse all verbs after deletion ---
                parseAndLoadVerbs(); 
                document.getElementById('current-question-count').textContent = verbs.length;
                showDataFeedback('Verb removed successfully! Restart quiz to see change.', 'green');
            }
        }
        
        window.saveNewQuestionData = function() {
            const inputIds = [
                'add-v1', 'add-v1-te', 
                'add-v3s', 'add-v3s-te',
                'add-ving', 'add-ving-te',
                'add-v2', 'add-v2-te',
                'add-v3', 'add-v3-te'
            ];
            const inputs = inputIds.map(id => document.getElementById(id));
            
            // Standardize all to lowercase, except Telugu fields
            const values = inputs.map((input, index) => {
                const isTeluguField = index % 2 === 1; // 1, 3, 5, 7, 9
                return isTeluguField ? input.value.trim() : input.value.trim().toLowerCase();
            });

            // Check only the English fields for validation (indices 0, 2, 4, 6, 8)
            const englishValues = [values[0], values[2], values[4], values[6], values[8]];
            if (englishValues.some(val => val === '')) {
                showDataFeedback('Please fill in ALL 5 English verb forms. (Telugu is optional)', 'red');
                return;
            }
            
            // Use the values directly, createVerbObject handles N/A default
            const newVerb = createVerbObject(values, true);
            
            if (!newVerb) {
                 showDataFeedback('Error creating verb object.', 'red');
                return;
            }

            const customVerbs = loadCustomVerbs();
            
            // Check based on V1 (index 0)
            if (customVerbs.some(v => v.v1.toLowerCase() === newVerb.v1.toLowerCase())) {
                showDataFeedback(`Error: Verb '${newVerb.v1}' already exists in your custom list.`, 'red');
                return;
            }
            
            customVerbs.push(newVerb);
            saveCustomVerbs(customVerbs);
            
            // --- Re-parse all verbs after adding ---
            parseAndLoadVerbs();
            
            inputs.forEach(input => input.value = ''); // Clear all 10 inputs
            showDataFeedback(`Verb '${newVerb.v1}' added! Restart quiz to see change.`, 'green');
            renderUserDataList();
            document.getElementById('current-question-count').textContent = verbs.length;
        }
        // --- END: JAVASCRIPT MODIFIED ---

        window.refreshBaseData = async function() {
            const feedbackEl = document.getElementById('refresh-feedback');
            feedbackEl.className = 'text-center text-sm font-semibold mt-2 text-primary';
            feedbackEl.textContent = 'Fetching latest Verbs.csv...';
            feedbackEl.classList.remove('hidden');

            try {
                // --- MODIFICATION: Added cache-busting query parameter ---
                const response = await fetch(`Verbs.csv?t=${new Date().getTime()}`); 
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                localStorage.setItem(INITIAL_DEFAULT_DATA_KEY, csvText); 
                baseCsvContent = csvText; // Update the in-memory content
                const baseVerbCount = parseAndLoadVerbs(); 
                
                feedbackEl.className = 'text-center text-sm font-semibold mt-2 text-green-600';
                feedbackEl.textContent = `Success! Reloaded ${baseVerbCount} base verbs (${verbs.length} total). Close this window to restart.`;
                document.getElementById('current-question-count').textContent = verbs.length;

            } catch (e) {
                console.error("Failed to refresh Verbs.csv:", e);
                feedbackEl.className = 'text-center text-sm font-semibold mt-2 text-red-600';
                feedbackEl.textContent = 'Error: Could not fetch file. Please check connection and file location.';
            }
        }


        // --- START: MODIFIED GAME LOGIC ---
        
        window.startQuiz = function() {
            let availableVerbs = verbs;
            
            // --- MODIFIED: Changed minimum verbs from 4 to 1 ---
            if (availableVerbs.length < 1) {
                document.getElementById('start-message').innerHTML = `Error: At least 1 verb is needed to start. Please add a custom verb or load the base data.`;
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('loading-indicator').textContent = '';
                return;
            }
            
            quizLimit = Math.min(maxQuestions, availableVerbs.length);
            
            shuffleArray(availableVerbs);
            questionPool = availableVerbs.slice(0, quizLimit); 
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-status-bar').classList.remove('hidden');
            document.getElementById('question-area').classList.remove('hidden');
            document.getElementById('quiz-action-buttons').classList.remove('hidden');
            
            document.getElementById('question-counter').textContent = `0/${quizLimit}`;
            
            score = 0;
            questionsAsked = 0;
            quizResults = [];
            document.getElementById('score-display').textContent = score;
            
            startNextQuestion();
        }

        window.startNextQuestion = function() {
            
            if (questionsAsked >= quizLimit || questionPool.length === 0) {
                endGame();
                return;
            }

            document.getElementById('feedback-message').textContent = '';
            document.getElementById('final-results').classList.add('hidden');
            document.getElementById('explanation-area').classList.add('hidden');
            
            const mainButton = document.getElementById('main-action-button');
            mainButton.textContent = 'Check Answer';
            mainButton.disabled = false;
            
            document.getElementById('skip-button').disabled = false;

            quizPhase = 'select';
            
            currentQuestionData = questionPool.shift(); 
            questionsAsked++;

            // --- START: MODIFIED - Pick a random form to give ---
            const allForms = ['v1', 'v3s', 'ving', 'v2', 'v3'];
            // This adds a new property to the verb object just for this question
            currentQuestionData.givenFormKey = allForms[Math.floor(Math.random() * allForms.length)];
            // --- END: MODIFIED ---

            renderQuestion(); // This will now use the givenFormKey
            updateProgressBar();
        }


        function renderQuestion() {
            if (!currentQuestionData) return;

            // --- START: MODIFIED - Get dynamic form info ---
            const givenFormKey = currentQuestionData.givenFormKey;
            const givenFormValue = currentQuestionData[givenFormKey];
            const givenFormLabel = getFormLabel(givenFormKey);
            // --- END: MODIFIED ---

            document.getElementById('question-counter').textContent = `${questionsAsked}/${quizLimit}`;
            
            // --- START: MODIFIED - Set dynamic prompt text & use specific span IDs ---
            // Set the prompt text (e.g., "goes")
            document.getElementById('question-english-text').textContent = givenFormValue;
            // Set the label (e.g., "Given Form (3rd Person Singular):")
            document.getElementById('given-form-label').textContent = `Given Form (${givenFormLabel}):`;
            // Set the telugu meaning for that specific form
            const teluguMeaning = (currentQuestionData.telugu && currentQuestionData.telugu[givenFormKey] && currentQuestionData.telugu[givenFormKey] !== 'N/A') 
                                 ? currentQuestionData.telugu[givenFormKey] 
                                 : '(No meaning available)';
            document.getElementById('question-telugu-text').textContent = teluguMeaning;
            // --- END: MODIFIED ---
            
            const formsContainer = document.getElementById('forms-container');
            formsContainer.innerHTML = '';

            // --- START: MODIFIED - Dynamically render the 4 OTHER inputs ---
            const allForms = ['v1', 'v3s', 'ving', 'v2', 'v3'];
            let firstInputId = null;

            allForms.forEach(formKey => {
                // Skip the form that was given as the prompt
                if (formKey === givenFormKey) return; 

                const formLabel = getFormLabel(formKey);
                const inputId = `${formKey}-input`;
                if (!firstInputId) firstInputId = inputId; // Store the ID of the first input to focus it

                formsContainer.innerHTML += `
                    <div class="space-y-1">
                        <label for="${inputId}" class="text-sm font-semibold text-gray-700 dark-mode:text-gray-300 ml-2">${formLabel}</label>
                        <input type="text" id="${inputId}" class="quiz-input" placeholder="Enter the ${formLabel}" autocapitalize="none" autocomplete="off" autocorrect="off" spellcheck="false">
                    </div>
                `;
            });
            
            // Focus the first input field
            if (firstInputId) {
                // Use a small timeout to ensure the element is focusable after rendering
                setTimeout(() => {
                     const firstInput = document.getElementById(firstInputId);
                     if (firstInput) firstInput.focus();
                }, 100);
            }
            // --- END: MODIFIED ---
        }
        
        // --- MODIFIED: Removed handleOptionSelection ---

        // <!--- START: EDITED checkAnswer function to add Telugu TTS --->
        window.checkAnswer = function() {
            if (quizPhase === 'next') {
                startNextQuestion();
                return;
            }
            
            if (!currentQuestionData) return;
            
            // --- START: Added TTS stop ---
            // Stop any currently playing speech before checking
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            // --- END: Added TTS stop ---
            
            quizPhase = 'next';
            
            // --- START: MODIFIED - Dynamically find and check inputs ---
            const givenFormKey = currentQuestionData.givenFormKey;
            const allForms = ['v1', 'v3s', 'ving', 'v2', 'v3'];
            const inputs = {};
            const userAnswers = {};
            const correctAnswers = {};
            
            let allCorrect = true;
            let explanation = [];
            
            // Check each answer
            allForms.forEach(formKey => {
                // Skip the form that was given
                if (formKey === givenFormKey) return; 

                const inputEl = document.getElementById(`${formKey}-input`);
                const formLabel = getFormLabel(formKey);
                const engCorrect = currentQuestionData[formKey];
                
                // --- NEW: Get Telugu text ---
                const telCorrectText = (currentQuestionData.telugu && currentQuestionData.telugu[formKey] && currentQuestionData.telugu[formKey] !== 'N/A') 
                                   ? currentQuestionData.telugu[formKey] 
                                   : '';
                const telCorrectDisplay = telCorrectText ? ` (${telCorrectText})` : '';
                
                inputs[formKey] = inputEl;
                userAnswers[formKey] = inputEl.value.trim().toLowerCase();
                correctAnswers[formKey] = engCorrect.toLowerCase();
                
                inputEl.disabled = true; // Lock the input
                
                // --- START: MODIFIED Explanation with Telugu TTS ---
                let explanationLine = `<strong>${formLabel}:</strong> ${engCorrect}${telCorrectDisplay}`;
                explanationLine += tts(engCorrect, 'en-US'); // Add English TTS
                if (telCorrectText) {
                    explanationLine += tts(telCorrectText, 'te-IN'); // Add Telugu TTS
                }
                
                if (userAnswers[formKey] === correctAnswers[formKey]) {
                    inputEl.classList.add('correct');
                    explanationLine += ` (Correct)`;
                } else {
                    inputEl.classList.add('incorrect');
                    // Show the correct answer in the input
                    inputEl.value = engCorrect;
                    allCorrect = false;
                    const userAnswerText = userAnswers[formKey] || 'nothing';
                    explanationLine += ` (You wrote: ${userAnswerText})`;
                }
                explanation.push(explanationLine);
                 // --- END: MODIFIED Explanation ---
            });
            // --- END: MODIFIED ---

            // Update UI
            const mainButton = document.getElementById('main-action-button');
            document.getElementById('skip-button').disabled = true;
            
            if (allCorrect) {
                score++;
                document.getElementById('feedback-message').textContent = 'Correct! Fantastic work!';
                document.getElementById('feedback-message').className = 'text-base font-medium text-green-600';
                playCorrect();
                vibrateCorrect();
            } else {
                document.getElementById('feedback-message').textContent = 'Not quite. Check the answers.';
                document.getElementById('feedback-message').className = 'text-base font-medium text-red-500';
                playIncorrect();
                vibrateIncorrect();
                
                // Show the explanation box with all answers
                document.getElementById('explanation-text').innerHTML = explanation.join('<br>');
                document.getElementById('explanation-area').classList.remove('hidden');
            }
            
            document.getElementById('score-display').textContent = score;

            if (questionsAsked >= quizLimit) {
                mainButton.textContent = 'Finish Quiz';
            } else {
                mainButton.textContent = 'Next Question';
            }
            mainButton.disabled = false;
            
            // --- START: MODIFIED - Store more info for results ---
            quizResults.push({
                questionNumber: questionsAsked,
                promptForm: givenFormKey,
                promptValue: currentQuestionData[givenFormKey],
                correctAnswers: currentQuestionData, // Store the whole verb object
                isCorrect: allCorrect,
                isSkipped: false
            });
            // --- END: MODIFIED ---
        }
        // <!--- END: EDITED checkAnswer function --->
        
        // --- NEW: Added skipQuestion function ---
        window.skipQuestion = function() {
            if (quizPhase !== 'select' || !currentQuestionData) return;
            
             // --- START: Added TTS stop ---
            // Stop any currently playing speech before skipping
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            // --- END: Added TTS stop ---
            
            quizPhase = 'next'; // Prevent double skipping
            
            document.getElementById('feedback-message').textContent = 'Question Skipped.';
            document.getElementById('feedback-message').className = 'text-base font-medium text-yellow-600';

            // --- START: MODIFIED - Store info for results ---
            quizResults.push({
                questionNumber: questionsAsked,
                promptForm: currentQuestionData.givenFormKey,
                promptValue: currentQuestionData[currentQuestionData.givenFormKey],
                correctAnswers: currentQuestionData, // Store the whole verb object
                isCorrect: false, // Skipped is incorrect
                isSkipped: true
            });
            // --- END: MODIFIED ---
            
            // Immediately go to the next question
            startNextQuestion();
        }
        
        // <!--- START: JAVASCRIPT FIX 2 - Replaced endGame function --->
        window.endGame = function() {
             // --- START: Added TTS stop ---
            // Stop any currently playing speech before showing results
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            // --- END: Added TTS stop ---
            
            document.getElementById('question-area').classList.add('hidden');
            document.getElementById('quiz-action-buttons').classList.add('hidden');
            document.getElementById('quiz-status-bar').classList.add('hidden');
            
            document.getElementById('feedback-message').textContent = '';
            
            updateProgressBar(); // Should be 100% here

            const totalQuestions = quizLimit;
            const percentage = totalQuestions > 0 ? ((score / totalQuestions) * 100).toFixed(1) : 0.0;
            
            // --- FIX: Use base text color, the CSS override will handle dark mode ---
            const statusColorClass = (percentage >= 70) ? 'text-green-700' : (percentage >= 40 ? 'text-yellow-700' : 'text-red-700');
            
            const resultBgClass = (percentage >= 70) ? 'bg-green-300/40 border-green-300' : (percentage >= 40 ? 'bg-yellow-300/40 border-yellow-300' : 'bg-red-300/40 border-red-300');

            let resultsHTML = `
                <h3 class="text-2xl font-bold ${statusColorClass} mb-2">Quiz Complete!</h3>
                <p class="text-lg text-gray-700 mb-4">
                    Your Final Score: <span class="font-bold text-2xl text-primary">${score}</span> 
                    out of <span class="font-bold text-2xl text-primary">${totalQuestions}</span> questions!
                </p>
                <p class="text-xl font-bold text-gray-900 mb-4">
                    Percentage: <span class="text-3xl text-primary">${percentage}%</span>
                </p>
                
                <div class="border-t pt-4 mt-4 border-gray-300 dark-mode:border-gray-700 text-left">
                    <h4 class="text-lg font-bold text-gray-900 mb-3">Full Review:</h4>
                    
                    <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
            `;
            
            const allWereCorrect = quizResults.every(r => r.isCorrect);
            if (allWereCorrect && quizResults.length > 0) {
                 resultsHTML += `<p class="text-center text-green-600 font-semibold">Perfect score! Review your answers below.</p>`;
            } else if (quizResults.length === 0) {
                 resultsHTML += `<p class="text-center text-gray-500">No questions were answered.</p>`;
            }

            quizResults.forEach(result => {
                let statusClass, statusText, statusTextColor;
                
                // --- FIX: Removed non-functional 'dark-mode:' prefixes. The CSS now handles this. ---
                if (result.isCorrect) {
                    statusClass = 'bg-green-100 border-green-400';
                    statusText = 'CORRECT';
                    statusTextColor = 'text-green-700'; // CSS override will make this light in dark mode
                } else {
                    statusClass = 'bg-red-100 border-red-400';
                    statusText = result.isSkipped ? 'SKIPPED' : 'INCORRECT';
                    statusTextColor = 'text-red-700'; // CSS override will make this light in dark mode
                }
                
                const givenLabel = getFormLabel(result.promptForm);
                const givenValue = result.promptValue;
                const v = result.correctAnswers; // The full verb object
                
                const teluguV1 = (v.telugu && v.telugu.v1 && v.telugu.v1 !== 'N/A') ? v.telugu.v1 : '';
                
                // Create the "All Forms" string with TTS for each form
                const allFormsWithTTS = [
                    `${v.v1} ${tts(v.v1, 'en-US')}`,
                    `${v.v3s} ${tts(v.v3s, 'en-US')}`,
                    `${v.ving} ${tts(v.ving, 'en-US')}`,
                    `${v.v2} ${tts(v.v2, 'en-US')}`,
                    `${v.v3} ${tts(v.v3, 'en-US')}`
                ].join(' / ');

                // --- FIX: Removed all junk comments and 'dark:' prefixes. ---
                // The base 'text-gray-XXX' classes will now be correctly overridden by your existing CSS.
                resultsHTML += `
                    <div class="p-3 rounded-xl border-2 ${statusClass}">
                        <p class="font-bold text-lg flex justify-between items-center mb-1">
                            <span class="text-gray-900">Q${result.questionNumber}: ${givenValue} (${givenLabel})</span>
                            <span class="text-sm font-extrabold ${statusTextColor}">${statusText}</span>
                        </p>
                        <p class="text-sm text-gray-800">
                           Correct (V1): ${v.v1} ${tts(v.v1, 'en-US')}
                           ${teluguV1 ? `<span class="italic text-primary">(${teluguV1})</span>${tts(teluguV1, 'te-IN')}` : ''}
                        </p>
                        <p class="text-xs text-gray-600" style="line-height: 1.8;">
                            <strong>All Forms:</strong> ${allFormsWithTTS}
                        </p>
                    </div>
                `;
            });

            resultsHTML += `
                    </div>
                </div>
                <button onclick="handleUiTapFeedback(); resetQuizAndReloadData()" class="mt-4 inline-block text-primary font-semibold hover:underline">Start a new quiz?</button>
            `;
            // --- END: MODIFIED ---
            
            document.getElementById('final-results').innerHTML = resultsHTML;
            document.getElementById('final-results').className = `hidden mt-8 text-center p-4 liquid-glass-card border-2 ${resultBgClass}`;
            document.getElementById('final-results').classList.remove('hidden');
        }
        // <!--- END: JAVASCRIPT FIX 2 --->
        
        window.resetQuizAndReloadData = function() {
            score = 0;
            questionsAsked = 0;
            quizResults = [];
            currentQuestionData = null;
            quizPhase = 'select';
            
            document.getElementById('quiz-status-bar').classList.add('hidden');
            document.getElementById('question-area').classList.add('hidden');
            document.getElementById('quiz-action-buttons').classList.add('hidden');
            document.getElementById('final-results').classList.add('hidden');

            document.getElementById('start-screen').classList.remove('hidden');
            
            document.getElementById('score-display').textContent = score;
            document.getElementById('feedback-message').textContent = '';
            
            parseAndLoadVerbs(); 
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const totalQuestions = quizLimit; 
            
            let percentage = 0;
            if (totalQuestions > 0) {
                percentage = (questionsAsked / totalQuestions) * 100;
            }
            
            percentage = Math.max(0, Math.min(100, percentage));
            progressBar.style.width = `${percentage}%`;
        }
        
        function updateStartScreenMessage() {
            const messageEl = document.getElementById('start-message');
            const startButton = document.getElementById('start-quiz-button');
            const indicator = document.getElementById('loading-indicator');

            if (!isDataLoaded) {
                 messageEl.textContent = 'Loading verb data...';
                 startButton.disabled = true;
                 indicator.classList.remove('hidden');
                 return;
            }

            indicator.classList.add('hidden');
            
            updateQuizLengthButton();
            // --- MODIFIED: Removed updateTenseLevelButton call ---

            let availableCount = verbs.length;
            
            const effectiveLimit = Math.min(maxQuestions, availableCount);
            
            if (verbs.length === 0) {
                messageEl.innerHTML = 'Error: No verbs available. Please add custom data to start a quiz.';
                startButton.disabled = true;
            } else if (effectiveLimit < 1) { // --- MODIFIED: Changed min from 4 to 1 ---
                 messageEl.innerHTML = `Warning: At least 1 verb is needed to create a quiz. You only have ${availableCount}. Please add more data.`;
                 startButton.disabled = true;
            } else {
                const quizLengthText = effectiveLimit < maxQuestions 
                    ? `(limited by available data)` 
                    : ``;
                // --- MODIFIED: Removed 'tense' from message ---
                messageEl.innerHTML = `Your next quiz will contain **${effectiveLimit}** questions ${quizLengthText}.`;
                startButton.disabled = false;
            }
        }
        // --- END: MODIFIED GAME LOGIC ---

        // Initialize the game when the window loads
        window.onload = async () => {
            setupAudio();
            loadInitialSettings(); // UPDATED: Applies global settings on load
            await fetchVerbData(); // Wait for the CSV to load
            parseAndLoadVerbs(); // Parse CSV and custom verbs
            
            // --- MODIFIED: Hide the tense selection button container as it's not used ---
            document.getElementById('tense-level-button-container').style.display = 'none';

            // Listen for system theme changes ONLY if mode is 'auto' (hub's key)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                const currentSetting = getGlobalSetting('theme', 'auto'); // Hub uses 'auto'
                if (currentSetting === 'auto') {
                    applyTheme(event.matches); // Re-apply theme based on new system setting
                }
            });

            // Listen for changes in global settings from other tabs/pages
            window.addEventListener('storage', (event) => {
                if (event.key === GLOBAL_SETTINGS_KEY) {
                    // Settings changed in another tab. Apply them here.
                    console.log("Global settings changed in another tab. Applying...");
                    loadInitialSettings(); // UPDATED: Re-load all settings
                }
                 if (event.key === SETTINGS_KEY) {
                    // Game-specific settings changed (e.g., sound)
                    console.log("Local settings changed in another tab. Applying...");
                    loadInitialSettings(); // Re-load all settings
                 }
            });
            
            // NEW: Added pageshow listener from hub to handle bfcache (back/forward)
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    console.log("Page shown from bfcache. Reloading settings.");
                    loadInitialSettings();
                }
            });
            
             // --- START: Added TTS stop on page unload ---
            // Stop TTS if the user navigates away or closes the tab
             window.addEventListener('beforeunload', () => {
                 if ('speechSynthesis' in window) {
                     window.speechSynthesis.cancel();
                 }
             });
            // --- END: Added TTS stop on page unload ---
        };

    </script>
    </body>
</html>

