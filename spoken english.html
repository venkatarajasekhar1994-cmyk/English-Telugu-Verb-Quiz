<meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoken English Course Quiz</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Correct path to the service worker file
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('Service Worker registered: ', registration))
                    .catch(error => console.error('Service Worker registration failed: ', error));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:wght@700&family=Roboto:wght@400;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;700&family=Source+Sans+3:wght@400;700&family=Poppins:wght@400;600;700&display=swap');
        
        :root {
            --title-font: 'Lora', serif;
            --body-font: 'Inter', sans-serif;
            --accent-color: 79, 70, 229; /* Indigo */
            
            /* Light Glass Theme Variables */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --main-text: #f3f4f6;
            --subtle-text: #d1d5db;
            --button-bg: rgba(0, 0, 0, 0.2);
        }

        .dark:root {
             /* Dark Glass Theme Variables - UPDATED for more contrast */
            --glass-bg: rgba(0, 0, 0, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1);
            --main-text: #f3f4f6;
            --subtle-text: #9ca3af;
            --button-bg: rgba(0, 0, 0, 0.6);
        }
        
        body {
            font-family: var(--body-font);
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--main-text);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1, h2, h3, .font-title { font-family: var(--title-font); }
        .accent-bg { background-color: rgb(var(--accent-color)); }
        .accent-text { color: rgb(var(--accent-color)); }
        .accent-border { border-color: rgb(var(--accent-color)); }
        .accent-ring:focus { --tw-ring-color: rgb(var(--accent-color)); }
        
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .subtle-text-color { color: var(--subtle-text); }
        .button-bg-color { background-color: var(--button-bg); }

        .animated-float {
             animation: liquid-float 15s ease-in-out infinite;
        }

        @keyframes liquid-float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="transition-colors duration-300">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white shadow-sm">Spoken English Quiz</h1>
            <div class="flex items-center space-x-2">
                <a href="game hub.html" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </a>
                 <!-- NEW: Curriculum Button -->
                <button id="curriculum-button" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                </button>
                <button id="settings-button" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors">
                    <svg id="theme-icon-light" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
        </header>

        <div id="start-screen" class="text-center p-6 rounded-2xl glass-effect animated-float">
            <h2 class="text-2xl font-bold mb-4 text-white">Welcome!</h2>
            <p id="start-message" class="mb-6 subtle-text-color">Loading data... Please wait.</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <button onclick="openSelectionModal('class')" class="w-full text-white p-3 rounded-lg text-left button-bg-color">
                    <span class="text-xs text-gray-400">Class</span><br>
                    <span id="current-class-selection" class="font-semibold"></span>
                </button>
                <button onclick="openSelectionModal('count')" class="w-full text-white p-3 rounded-lg text-left button-bg-color">
                    <span class="text-xs text-gray-400">Quiz Length</span><br>
                    <span id="current-quiz-length" class="font-semibold"></span>
                </button>
            </div>

            <button id="start-quiz-button" disabled class="w-full accent-bg text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                Start Quiz
            </button>
        </div>

        <div id="quiz-screen" class="hidden animated-float">
            <div class="flex justify-between items-center mb-4">
                <div id="stats" class="text-sm font-semibold">Question 1/10</div>
                <div id="score" class="text-sm font-semibold">Score: 0</div>
            </div>
            <div class="w-full rounded-full h-2.5 mb-4 button-bg-color">
                <div id="progress-bar" class="accent-bg h-2.5 rounded-full" style="width: 10%"></div>
            </div>

            <div id="question-container" class="p-6 rounded-2xl glass-effect"></div>
            <button id="next-question-button" class="hidden mt-6 w-full accent-bg text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Next</button>
        </div>

        <div id="results-screen" class="hidden text-center p-6 rounded-2xl glass-effect animated-float">
             <h2 class="text-2xl font-bold mb-2 text-white">Quiz Complete!</h2>
             <p class="text-lg mb-4 text-gray-200">Your final score is <span id="final-score" class="font-bold accent-text"></span></p>
             <div id="results-details" class="text-left mb-6 space-y-2 max-h-60 overflow-y-auto no-scrollbar"></div>
             <button id="restart-quiz-button" class="w-full accent-bg text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Play Again</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="rounded-2xl shadow-xl p-6 w-full max-w-sm max-h-[80vh] flex flex-col glass-effect">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-white">Select Option</h3>
                <button onclick="closeSelectionModal()" class="text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div id="modal-options" class="space-y-2 overflow-y-auto no-scrollbar"></div>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="rounded-2xl shadow-xl p-6 w-full max-w-sm glass-effect">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Settings</h3>
                <button onclick="closeSettingsModal()" class="text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="space-y-4">
                <button onclick="openSelectionModal('bodyFont')" class="w-full p-3 rounded-lg text-left button-bg-color text-white">
                    <span class="text-xs text-gray-400">Body Font</span><br>
                    <span id="current-body-font" class="font-semibold"></span>
                </button>
                <button onclick="openSelectionModal('titleFont')" class="w-full p-3 rounded-lg text-left button-bg-color text-white">
                    <span class="text-xs text-gray-400">Title Font</span><br>
                    <span id="current-title-font" class="font-semibold"></span>
                </button>
                <button onclick="openSelectionModal('color')" class="w-full p-3 rounded-lg text-left button-bg-color text-white">
                    <span class="text-xs text-gray-400">Accent Color</span><br>
                    <span id="current-accent-color" class="font-semibold"></span>
                </button>
            </div>
        </div>
    </div>

     <!-- NEW: Curriculum Modal -->
    <div id="curriculum-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="rounded-2xl shadow-xl p-6 w-full max-w-3xl max-h-[80vh] flex flex-col glass-effect">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">45-Day Spoken English Curriculum</h3>
                <button onclick="closeCurriculumModal()" class="text-gray-300 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="space-y-6 overflow-y-auto no-scrollbar pr-2 text-sm">
                
                <div>
                    <h4 class="font-bold text-lg mb-2 accent-text">Phase I: Core Action and Simple Tense Mastery (Classes 01–12)</h4>
                    <table class="w-full text-left">
                        <thead class="border-b border-white/20">
                            <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2">01</td><td class="p-2">Pronoun Roles</td><td class="p-2">Establishes the core sentence structure (S+V+O) and differentiates between subject and object pronouns.</td></tr>
                            <tr><td class="p-2">02</td><td class="p-2">Self-Introduction</td><td class="p-2">Teaches the full framework for self-presentation.</td></tr>
                            <tr><td class="p-2">03</td><td class="p-2">Regular Verbs</td><td class="p-2">Drills predictable conjugation patterns (V1, V2, V3, V-ing).</td></tr>
                            <tr><td class="p-2">04</td><td class="p-2">Irregular Verbs</td><td class="p-2">Focuses on high-frequency irregular verbs (e.g., eat/ate/eaten).</td></tr>
                            <tr><td class="p-2">05</td><td class="p-2">Simple Present Tense</td><td class="p-2">Expressing habitual actions, daily routines, and general truths.</td></tr>
                            <tr><td class="p-2">06</td><td class="p-2">Simple Present (Do/Does)</td><td class="p-2">Using Do/Does for questions and negative statements.</td></tr>
                            <tr><td class="p-2">07</td><td class="p-2">WH-Questions (Do/Does)</td><td class="p-2">Synthesizes Do/Does with question words (What, Why, Where, How).</td></tr>
                            <tr><td class="p-2">08</td><td class="p-2">Simple Past Tense</td><td class="p-2">Using the Past Tense form (V2) to describe completed actions.</td></tr>
                            <tr><td class="p-2">09</td><td class="p-2">Simple Past (Did)</td><td class="p-2">Using Did/didn't for questions and negatives in the Past Tense.</td></tr>
                            <tr><td class="p-2">10</td><td class="p-2">WH-Questions (Did)</td><td class="p-2">Integrates Did with question words to ask about past actions.</td></tr>
                            <tr><td class="p-2">11</td><td class="p-2">Simple Future Tense</td><td class="p-2">Using Shall/Will to express future intentions and actions.</td></tr>
                            <tr><td class="p-2">12</td><td class="p-2">WH-Questions (Shall/Will)</td><td class="p-2">Applies Shall/Will with WH-Words to inquire about future plans.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div>
                    <h4 class="font-bold text-lg mb-2 accent-text">Phase II: Actions in Progress—Mastery of Continuous Forms (Classes 13–15)</h4>
                    <table class="w-full text-left">
                        <thead class="border-b border-white/20">
                            <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2">13</td><td class="p-2">Present Continuous</td><td class="p-2">Using Am/Is/Are + V-ing for actions happening now.</td></tr>
                            <tr><td class="p-2">14</td><td class="p-2">Past Continuous</td><td class="p-2">Using Was/Were + V-ing for ongoing past actions.</td></tr>
                            <tr><td class="p-2">15</td><td class="p-2">Future Continuous</td><td class="p-2">Using Shall be/Will be + V-ing for actions that will be in progress.</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h4 class="font-bold text-lg mb-2 accent-text">Phase III: Modality, Ability, and Obligation (Classes 16–20)</h4>
                    <table class="w-full text-left">
                        <thead class="border-b border-white/20">
                            <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2">16</td><td class="p-2">Can/Could</td><td class="p-2">Expressing present ability (Can) and past ability (Could).</td></tr>
                            <tr><td class="p-2">17</td><td class="p-2">May/Might</td><td class="p-2">Expressing uncertainty and possibility.</td></tr>
                            <tr><td class="p-2">18</td><td class="p-2">Should</td><td class="p-2">Expressing general advice, responsibility, and duty.</td></tr>
                            <tr><td class="p-2">19</td><td class="p-2">Must</td><td class="p-2">Expressing strong obligation, determination, or necessity.</td></tr>
                            <tr><td class="p-2">20</td><td class="p-2">Would & Synthesis</td><td class="p-2">Using Would for past habits and synthesizing all learned forms.</td></tr>
                        </tbody>
                    </table>
                </div>
                 <div>
                    <h4 class="font-bold text-lg mb-2 accent-text">Phase IV: Perfect Tenses and Complex Modal Structures (Classes 21–35)</h4>
                    <table class="w-full text-left">
                        <thead class="border-b border-white/20">
                            <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2">21</td><td class="p-2">Have/Has (Possession)</td><td class="p-2">Clarifies role in expressing current possession.</td></tr>
                            <tr><td class="p-2">22</td><td class="p-2">Present Perfect</td><td class="p-2">Using Have/Has + P.P.F for recent past actions with present relevance.</td></tr>
                            <tr><td class="p-2">23</td><td class="p-2">Past Perfect</td><td class="p-2">Using Had + P.P.F for an action that occurred before another past action.</td></tr>
                            <tr><td class="p-2">24</td><td class="p-2">Future Perfect</td><td class="p-2">Using Shall have/Will have + P.P.F for actions completed by a future deadline.</td></tr>
                            <tr><td class="p-2">25</td><td class="p-2">Should have/Must have</td><td class="p-2">Expressing past unfulfilled actions or strong assumptions.</td></tr>
                            <tr><td class="p-2">26</td><td class="p-2">May have/Might have</td><td class="p-2">Expressing degrees of uncertainty about past actions.</td></tr>
                            <tr><td class="p-2">27</td><td class="p-2">Would have/Could have</td><td class="p-2">Discussing hypothetical situations in the past (counterfactuals).</td></tr>
                            <tr><td class="p-2">28</td><td class="p-2">Past Actions Review</td><td class="p-2">Comprehensive review of all 17 structures for past actions.</td></tr>
                            <tr><td class="p-2">29</td><td class="p-2">Present Perfect Continuous</td><td class="p-2">Have been/Has been + V-ing for actions from past to present.</td></tr>
                            <tr><td class="p-2">30</td><td class="p-2">Past Perfect Continuous</td><td class="p-2">Had been + V-ing for continuous actions before a past moment.</td></tr>
                            <tr><td class="p-2">31</td><td class="p-2">Future Perfect Continuous</td><td class="p-2">Shall have been/Will have been + V-ing for action duration up to a future point.</td></tr>
                            <tr><td class="p-2">32</td><td class="p-2">Continuous Modal Perfects</td><td class="p-2">Introduces structures like 'Should have been doing'.</td></tr>
                            <tr><td class="p-2">33</td><td class="p-2">Application of Should/Must Have Been</td><td class="p-2">Drilling continuous modal perfects for past actions.</td></tr>
                            <tr><td class="p-2">34</td><td class="p-2">Application of Would/Could Have Been</td><td class="p-2">Drilling continuous modals for hypothetical past actions.</td></tr>
                            <tr><td class="p-2">35</td><td class="p-2">Application of May/Might Have Been & Review</td><td class="p-2">Final review of all modal and perfect forms.</td></tr>
                        </tbody>
                    </table>
                </div>

                <div>
                    <h4 class="font-bold text-lg mb-2 accent-text">Phase V: Necessity, Desire, and Specialized Auxiliaries (Classes 36–41)</h4>
                    <table class="w-full text-left">
                        <thead class="border-b border-white/20">
                            <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2">36</td><td class="p-2">Have to/Has to</td><td class="p-2">Expressing external compulsion in present and future.</td></tr>
                            <tr><td class="p-2">37</td><td class="p-2">Need to/Dare to/Ought to</td><td class="p-2">Specialized auxiliaries for necessity, courage, and moral obligation.</td></tr>
                            <tr><td class="p-2">38</td><td class="p-2">Want to/Wish to/Would like to</td><td class="p-2">Covers various expressions of desire and preference.</td></tr>
                            <tr><td class="p-2">39</td><td class="p-2">Able to, Willing to, Going to</td><td class="p-2">Phrasal auxiliaries for ability, readiness, and planning.</td></tr>
                            <tr><td class="p-2">40</td><td class="p-2">Had to (Past Obligation)</td><td class="p-2">Expressing a necessity or obligation in the past.</td></tr>
                            <tr><td class="p-2">41</td><td class="p-2">Used to (Past Habit)</td><td class="p-2">Expressing a repeated past habit that is no longer performed.</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div>
                    <h4 class="font-bold text-lg mb-2 accent-text">Phase VI: Synthesis, Tenses, and Voice (Classes 42–45)</h4>
                    <table class="w-full text-left">
                        <thead class="border-b border-white/20">
                           <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2">42</td><td class="p-2">The 12 Tenses Matrix</td><td class="p-2">Unified map of the English verbal system by time and aspect.</td></tr>
                            <tr><td class="p-2">43</td><td class="p-2">12 Tenses Application</td><td class="p-2">Drilling a single verb across all twelve tenses.</td></tr>
                            <tr><td class="p-2">44</td><td class="p-2">Active & Passive Voice</td><td class="p-2">Introduces voice transformation and auxiliary conversion.</td></tr>
                            <tr><td class="p-2">45</td><td class="p-2">Be with P.P. Form</td><td class="p-2">Master key for expressing static states in all modal/auxiliary contexts.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultsScreen = document.getElementById('results-screen');
        const questionContainer = document.getElementById('question-container');
        const startButton = document.getElementById('start-quiz-button');
        const nextButton = document.getElementById('next-question-button');
        const restartButton = document.getElementById('restart-quiz-button');
        const curriculumButton = document.getElementById('curriculum-button');

        // State
        let allQuestions = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isDataLoaded = false;
        let selectedClass = 1;
        let maxQuestions = 10;
        let synth;
        let correctSound, wrongSound;

        // Constants
        const CLASS_TOPICS = [ "Pronoun Roles", "Self-Introduction", "Regular Verbs", "Irregular Verbs", "Simple Present Tense", "Simple Present (Do/Does)", "WH-Questions (Do/Does)", "Simple Past Tense", "Simple Past (Did)", "WH-Questions (Did)", "Simple Future Tense", "WH-Questions (Shall/Will)", "Present Continuous (Am/Is/Are)", "Past Continuous (Was/Were)", "Future Continuous (Shall be/Will be)", "Can/Could", "May/Might", "Should", "Must", "Would (Past Habit) & Synthesis", "Have/Has (Possession)", "Present Perfect Tense", "Past Perfect Tense", "Future Perfect Tense", "Should have/Must have (P.P.F)", "May have/Might have (P.P.F)", "Would have/Could have (P.P.F)", "Past Actions Review", "Present Perfect Continuous", "Past Perfect Continuous", "Future Perfect Continuous", "Continuous Modal Perfects", "Application of Should/Must Have Been", "Application of Would/Could Have Been", "Application of May/Might Have Been & Review", "Have to/Has to (Present/Future)", "Need to/Dare to/Ought to", "Want to/Wish to/Would like to", "Able to, Willing to, Going to, etc.", "Had to (Past Obligation)", "Used to (Past Habit)", "The 12 Tenses Matrix", "12 Tenses Application", "Active Voice & Passive Voice", "Be with P.P. Form and Special Verbs" ];
        const FONT_OPTIONS = {
            body: [ { label: 'Inter', value: 'Inter, sans-serif' }, { label: 'Roboto', value: 'Roboto, sans-serif' }, { label: 'Source Sans', value: "'Source Sans 3', sans-serif" }, { label: 'Poppins', value: 'Poppins, sans-serif' } ],
            title: [ { label: 'Lora', value: 'Lora, serif' }, { label: 'Merriweather', value: 'Merriweather, serif' }, { label: 'Playfair Display', value: "'Playfair Display', serif" }, { label: 'Montserrat', value: 'Montserrat, sans-serif' } ]
        };
        const COLOR_THEMES = [ { name: 'Indigo', value: '79, 70, 229' }, { name: 'Sky', value: '2, 132, 199' }, { name: 'Emerald', value: '5, 150, 105' }, { name: 'Rose', value: '225, 29, 72' }, { name: 'Amber', value: '217, 119, 6' } ];

        // --- Audio & Haptic Feedback ---
        function setupAudio() {
            if (window.Tone) {
                correctSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination();
                wrongSound = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
            }
            synth = window.speechSynthesis;
        }

        function playFeedback(isCorrect) {
            if (window.Tone) {
                if (isCorrect) correctSound.triggerAttackRelease('G5', '8n', Tone.now());
                else wrongSound.triggerAttackRelease('C3', '4n', Tone.now());
            }
            if (navigator.vibrate) {
                if (isCorrect) navigator.vibrate(100);
                else navigator.vibrate([200, 75, 200]);
            }
        }

        function speak(text) {
            if (synth && text) {
                synth.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                synth.speak(utterance);
            }
        }

        // --- Data Loading & Parsing ---
        function parseCsvRow(row) {
            const values = [];
            const regex = /("([^"]|"")*"|[^,]*)(,|$)/g;
            let match;
            let processedRow = row.trim();
            if (processedRow.charAt(processedRow.length - 1) !== ',') processedRow += ',';
            while ((match = regex.exec(processedRow)) !== null) {
                let value = match[1];
                if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1).replace(/""/g, '"');
                values.push(value.trim());
                if (match[3] === '') break;
            }
            if (values.length > 0 && values[values.length - 1] === '') values.pop();
            return values;
        }

        async function loadQuestions() {
            try {
                // IMPROVED: Use a cache-busting parameter for development if needed,
                // but the service worker handles caching in production.
                // The path is kept relative, which works well with GitHub Pages structure.
                const response = await fetch('data.csv');

                if (!response.ok) {
                    // This will catch HTTP errors like 404 Not Found
                    throw new Error(`Failed to fetch data. Status: ${response.status} ${response.statusText}`);
                }

                const csvData = await response.text();
                
                // Check if the CSV data is empty or just headers
                if (!csvData || csvData.trim().split(/\r?\n/).length <= 1) {
                    throw new Error("CSV data is empty or invalid.");
                }

                const lines = csvData.trim().split(/\r?\n/);
                const headers = parseCsvRow(lines[0]);
                
                allQuestions = lines.slice(1).map(line => {
                    if (line.trim() === '') return null;
                    const values = parseCsvRow(line);
                    if (values.length < headers.length) {
                        console.warn('Skipping malformed CSV row:', line);
                        return null;
                    }
                    let question = {};
                    headers.forEach((header, i) => {
                        question[header.trim()] = values[i] || '';
                    });
                    return question;
                }).filter(q => q !== null && q.lesson);

                if (allQuestions.length === 0) {
                    throw new Error("No valid questions were parsed from the data file.");
                }
                
                isDataLoaded = true;
                console.log(`Successfully loaded and parsed ${allQuestions.length} questions.`);

            } catch (error) {
                console.error("Failed to load or parse questions:", error);
                isDataLoaded = false;
                // IMPROVED: Show a user-friendly error message on the screen.
                document.getElementById('start-message').innerHTML = `
                    <strong class="text-red-400">Error: Could not load quiz data.</strong>
                    <br>
                    <small>If you are offline, please connect to the internet to download the latest questions. If the problem continues, the data file may be missing or corrupt.</small>
                `;
            }
            
            // This part runs regardless of success or failure to set up the rest of the UI
            selectedClass = parseInt(getLocalStorageSetting('spokenEnglishClass', '1'), 10);
            maxQuestions = parseInt(getLocalStorageSetting('spokenEnglishLength', '10'), 10);
            updateStartScreenMessage();
            updateClassSelectionButton();
            updateQuizLengthButton();
            startButton.disabled = !isDataLoaded;
        }


        // --- Game Logic ---
        function startQuiz() {
            const filtered = allQuestions.filter(q => parseInt(q.lesson, 10) === selectedClass);
            currentQuestions = filtered.sort(() => 0.5 - Math.random()).slice(0, maxQuestions);
            if (currentQuestions.length === 0) {
                 document.getElementById('start-message').textContent = `No questions available for Class ${selectedClass}. Please select another class.`;
                 return;
            }
            currentQuestionIndex = 0;
            score = 0;
            startScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            displayQuestion();
        }

        function displayQuestion() {
            nextButton.classList.add('hidden');
            const question = currentQuestions[currentQuestionIndex];
            document.getElementById('stats').textContent = `Question ${currentQuestionIndex + 1}/${currentQuestions.length}`;
            document.getElementById('score').textContent = `Score: ${score}`;
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / currentQuestions.length) * 100}%`;
            const prompt = `<div class="flex items-center justify-between mb-4"><p class="text-lg subtle-text-color">${question.promptTE}</p><button onclick="speak('${question.promptEN.replace(/'/g, "\\'")}')" class="p-2 rounded-full hover:bg-white/20 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button></div><h2 class="text-2xl font-bold mb-6 text-white">${question.promptEN}</h2>`;
            let content = '';
            if (question.type === 'mcq') {
                const options = ['A', 'B', 'C', 'D'].map(opt => `<button onclick="checkAnswer('${opt}', this)" class="w-full text-left p-4 border-2 border-white/30 rounded-lg hover:accent-border hover:bg-white/10 transition-all duration-200">${question[opt]}</button>`).join('');
                content = `${prompt}<div class="space-y-3">${options}</div>`;
            } else if (question.type === 'fill_blank') {
                content = `${prompt}<input id="fill-blank-input" type="text" class="w-full p-4 border-2 border-white/30 rounded-lg bg-transparent focus:outline-none focus:ring-2 accent-ring" placeholder="Type your answer..."><button onclick="checkFillBlank()" class="mt-4 w-full accent-bg text-white font-bold py-3 rounded-lg">Check Answer</button>`;
            }
            questionContainer.innerHTML = `<div class="fade-in">${content}</div><div id="feedback" class="mt-4"></div>`;
        }

        function checkAnswer(selected, element) {
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selected === question.correct;
            const buttons = questionContainer.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);
            playFeedback(isCorrect);
            if (isCorrect) {
                score++;
                element.classList.add('bg-green-500/50', 'border-green-400');
            } else {
                element.classList.add('bg-red-500/50', 'border-red-400');
                const correctButton = Array.from(buttons).find(b => b.textContent === question[question.correct]);
                if(correctButton) correctButton.classList.add('bg-green-500/50', 'border-green-400');
            }
            displayFeedback(isCorrect);
        }

        function checkFillBlank() {
            const input = document.getElementById('fill-blank-input');
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = input.value.trim().toLowerCase() === question.correct.trim().toLowerCase();
            input.disabled = true;
            questionContainer.querySelector('button').disabled = true;
            playFeedback(isCorrect);
            if (isCorrect) { score++; input.classList.add('bg-green-500/50', 'border-green-400'); } 
            else { input.classList.add('bg-red-500/50', 'border-red-400'); }
            displayFeedback(isCorrect);
        }

        function displayFeedback(isCorrect) {
            const question = currentQuestions[currentQuestionIndex];
            const icon = isCorrect ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-green-300"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-red-300"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
            document.getElementById('feedback').innerHTML = `<div class="fade-in p-4 rounded-lg glass-effect"><p class="font-semibold">${icon} ${isCorrect ? 'Correct!' : 'Not quite.'}</p><p class="text-sm text-gray-300 mt-2">${question.feedbackEN}</p><p class="text-sm text-gray-400 mt-1">${question.feedbackTE}</p></div>`;
            nextButton.classList.remove('hidden');
        }

        function handleNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuestions.length) displayQuestion();
            else showResults();
        }
        
        function showResults() {
             quizScreen.classList.add('hidden');
             resultsScreen.classList.remove('hidden');
             const percentage = Math.round((score / currentQuestions.length) * 100);
             document.getElementById('final-score').textContent = `${score}/${currentQuestions.length} (${percentage}%)`;
             document.getElementById('results-details').innerHTML = currentQuestions.map((q, i) => `<div class="p-3 rounded-md button-bg-color"><p class="font-semibold text-gray-200">${i+1}. ${q.promptEN}</p><p class="text-green-400">Correct: ${q[q.correct] || q.correct}</p></div>`).join('');
        }

        // Event Listeners
        startButton.addEventListener('click', startQuiz);
        nextButton.addEventListener('click', handleNextQuestion);
        restartButton.addEventListener('click', () => { resultsScreen.classList.add('hidden'); startScreen.classList.remove('hidden'); });

        // Theming & Settings
        function getLocalStorageSetting(key, defaultValue) { return localStorage.getItem(key) || defaultValue; }
        function setLocalStorageSetting(key, value) { localStorage.setItem(key, value); }
        
        function applyTheme(isDark) {
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            if (isDark) {
                document.documentElement.classList.add('dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }
        }
        
        function setBodyFont(font) { document.documentElement.style.setProperty('--body-font', font); setLocalStorageSetting('bodyFont', font); }
        function setTitleFont(font) { document.documentElement.style.setProperty('--title-font', font); setLocalStorageSetting('titleFont', font); }
        function applyAccentColor(name) {
            const theme = COLOR_THEMES.find(t => t.name === name) || COLOR_THEMES[0];
            document.documentElement.style.setProperty('--accent-color', theme.value);
            setLocalStorageSetting('colorTheme', name);
        }
        
        function loadInitialSettings() {
            const savedTheme = getLocalStorageSetting('theme', 'dark'); // Default to dark glass
            applyTheme(savedTheme === 'dark');
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                applyTheme(!isDark);
                setLocalStorageSetting('theme', isDark ? 'light' : 'dark');
            });
            
            setBodyFont(getLocalStorageSetting('bodyFont', FONT_OPTIONS.body[0].value));
            setTitleFont(getLocalStorageSetting('titleFont', FONT_OPTIONS.title[0].value));
            applyAccentColor(getLocalStorageSetting('colorTheme', COLOR_THEMES[0].name));
            updateFontButton('body');
            updateFontButton('title');
            updateColorButton();
            document.getElementById('settings-button').addEventListener('click', openSettingsModal);
            curriculumButton.addEventListener('click', openCurriculumModal); // Add listener for curriculum
        }
        
        // Modals Logic
        function openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function openCurriculumModal() { document.getElementById('curriculum-modal').classList.remove('hidden'); }
        function closeCurriculumModal() { document.getElementById('curriculum-modal').classList.add('hidden'); }
        
        function openSelectionModal(type) {
            if (['bodyFont', 'titleFont', 'color'].includes(type)) {
                closeSettingsModal();
            }

            const modal = document.getElementById('selection-modal');
            const title = document.getElementById('modal-title');
            const optionsContainer = document.getElementById('modal-options');
            let optionsHTML = '';
            const buttonClass = 'w-full text-left p-3 rounded-lg hover:bg-white/10 text-white';

            if (type === 'class') {
                title.textContent = 'Select a Class';
                optionsHTML = CLASS_TOPICS.map((topic, i) => `<button onclick="handleSelectionChange('class', ${i+1})" class="${buttonClass}">${i+1}: ${topic}</button>`).join('');
            } else if (type === 'count') {
                title.textContent = 'Select Quiz Length';
                [4, 5, 10, 15, 20, 25].forEach(count => { optionsHTML += `<button onclick="handleSelectionChange('count', ${count})" class="${buttonClass}">${count} Questions</button>`; });
            } else if (type === 'bodyFont' || type === 'titleFont') {
                title.textContent = type === 'bodyFont' ? 'Select Body Font' : 'Select Title Font';
                const options = FONT_OPTIONS[type === 'bodyFont' ? 'body' : 'title'];
                optionsHTML = options.map(opt => `<button onclick="handleSelectionChange('${type}', '${opt.value}')" class="${buttonClass}" style="font-family: ${opt.value};">${opt.label}</button>`).join('');
            } else if (type === 'color') {
                title.textContent = 'Select Accent Color';
                optionsHTML = COLOR_THEMES.map(theme => `<button onclick="handleSelectionChange('color', '${theme.name}')" class="${buttonClass} flex items-center justify-between"><span>${theme.name}</span><span class="w-6 h-6 rounded-full" style="background-color: rgb(${theme.value})"></span></button>`).join('');
            }
            optionsContainer.innerHTML = optionsHTML;
            modal.classList.remove('hidden');
        }

        function closeSelectionModal() { document.getElementById('selection-modal').classList.add('hidden'); }
        
        function handleSelectionChange(type, value) {
            if (type === 'class') { selectedClass = value; setLocalStorageSetting('spokenEnglishClass', value); updateClassSelectionButton(); } 
            else if (type === 'count') { maxQuestions = value; setLocalStorageSetting('spokenEnglishLength', value); updateQuizLengthButton(); } 
            else if (type === 'bodyFont') { setBodyFont(value); updateFontButton('body'); } 
            else if (type === 'titleFont') { setTitleFont(value); updateFontButton('title'); } 
            else if (type === 'color') { applyAccentColor(value); updateColorButton(); }
            closeSelectionModal();
        }

        // Update UI Text
        function getLabel(type, value) {
            if (type === 'class') return `Class ${value}: ${CLASS_TOPICS[value-1]}`;
            if (type === 'count') return `${value} Questions`;
            if (type === 'bodyFont' || type === 'titleFont') {
                const options = FONT_OPTIONS[type === 'bodyFont' ? 'body' : 'title'];
                return (options.find(opt => opt.value === value) || {}).label || 'Default';
            }
            return value;
        }
        
        function updateFontButton(type) { const id = type === 'body' ? 'current-body-font' : 'current-title-font'; const key = type === 'body' ? 'bodyFont' : 'titleFont'; const value = getLocalStorageSetting(key, FONT_OPTIONS[type][0].value); document.getElementById(id).textContent = getLabel(key, value); }
        function updateColorButton() { const value = getLocalStorageSetting('colorTheme', COLOR_THEMES[0].name); document.getElementById('current-accent-color').textContent = value; }
        function updateClassSelectionButton() { document.getElementById('current-class-selection').textContent = getLabel('class', selectedClass); }
        function updateQuizLengthButton() { document.getElementById('current-quiz-length').textContent = getLabel('count', maxQuestions); }
        
        function updateStartScreenMessage() {
            // Only update the message if the data has loaded. 
            // If there was an error, the error message will be preserved.
            if (isDataLoaded) {
                 document.getElementById('start-message').textContent = `Ready to practice? Select your class and quiz length, then press Start!`;
            }
        }


        window.onload = () => {
            setupAudio();
            loadQuestions();
            loadInitialSettings();
        };
    </script>
</body>
</html>



