<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoken English Course Quiz</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('Service Worker registered: ', registration))
                    .catch(error => console.error('Service Worker registration failed: ', error));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        /* MODIFIED: Google Fonts Import - Added DM Sans, DM Serif Display, Outfit, Lexend */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:wght@700&family=Roboto:wght@400;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@700&family=Montserrat:wght@400;700;900&family=Poppins:wght@400;600;700&family=Source+Sans+3:wght@400;700&family=DM+Sans:wght@400;700&family=DM+Serif+Display&family=Outfit:wght@700&family=Lexend:wght@400;700&display=swap');
        
        /* --- CSS Variables --- */
        :root {
            /* MODIFIED: Updated default fonts */
            --title-font: 'Montserrat', sans-serif;
            --body-font: 'Lexend', sans-serif;
            
            --accent-color-rgb: 79, 70, 229; /* Indigo RGB */
            --accent-color-hex: #4f46e5; /* Indigo Hex */
            
            /* Backgrounds - 4 stops for animation - Set dynamically via JS */
            --bg-grad-color1: #a5b4fc; /* Default light indigo 1 */
            --bg-grad-color2: #818cf8; /* Default light indigo 2 */
            --bg-grad-color3: #6366f1; /* Default light indigo 3 */
            --bg-grad-color4: #4f46e5; /* Default light indigo 4 */
            
            /* Glass Effect (Light Mode Default) */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --button-bg: rgba(0, 0, 0, 0.1);
            --button-hover-bg: rgba(0, 0, 0, 0.2);
            --modal-bg: rgba(255, 255, 255, 0.05);
            
            /* Text Colors */
            --text-main: #f3f4f6;
            --text-subtle: #d1d5db;
            --text-contrast-light: #111827;
            --text-contrast-dark: #f9fafb;
        }

        /* --- Dark Mode Variables --- */
        .dark:root {
            /* Backgrounds - 4 stops - Set dynamically via JS */
            --bg-grad-color1: #312e81; /* Default dark indigo 1 */
            --bg-grad-color2: #4338ca; /* Default dark indigo 2 */
            --bg-grad-color3: #4f46e5; /* Default dark indigo 3 */
            --bg-grad-color4: #6366f1; /* Default dark indigo 4 */

            --glass-bg: rgba(31, 41, 55, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --button-bg: rgba(0, 0, 0, 0.3);
            --button-hover-bg: rgba(0, 0, 0, 0.5);
            --modal-bg: rgba(17, 24, 39, 0.6);

            --text-main: #f9fafb;
            --text-subtle: #9ca3af;
        }
        
        /* --- Text Contrast Application --- */
        body { color: var(--text-main); }
        .subtle-text-color { color: var(--text-subtle); }
        body[data-contrast="high"] { color: var(--text-contrast-light); }
        body[data-contrast="high"] .subtle-text-color { color: #4b5563; }
        .dark body[data-contrast="high"] { color: var(--text-contrast-dark); }
        .dark body[data-contrast="high"] .subtle-text-color { color: #e5e7eb; }
        .dark body[data-contrast="high"] a,
        .dark body[data-contrast="high"] button:not(.accent-bg) { color: var(--text-contrast-dark) !important; }
        body[data-contrast="high"] a,
        body[data-contrast="high"] button:not(.accent-bg) { color: var(--text-contrast-light) !important; }
        body[data-contrast="high"] .accent-text { color: var(--accent-color-hex) !important; }

        /* --- Base Styles with Gradient --- */
        body {
            font-family: var(--body-font);
            background: linear-gradient(-45deg, var(--bg-grad-color1), var(--bg-grad-color2), var(--bg-grad-color3), var(--bg-grad-color4));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: color 0.3s ease;
            min-height: 100vh;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Utility & Component Styles --- */
        h1, h2, h3, .font-title { font-family: var(--title-font); }
        .accent-bg { background-color: rgb(var(--accent-color-rgb)); }
        .accent-text { color: rgb(var(--accent-color-rgb)); }
        .accent-border { border-color: rgb(var(--accent-color-rgb)); }
        .accent-ring:focus { --tw-ring-color: rgb(var(--accent-color-rgb)); }
        
        .glass-effect {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            transition: background 0.3s ease, border 0.3s ease;
        }
        
        .button-bg-color { background-color: var(--button-bg); transition: background-color 0.2s ease; }
        .button-bg-color:hover { background-color: var(--button-hover-bg); }
        .modal-glass { background: var(--modal-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4); }
        .selection-button { background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); transition: background-color 0.2s, border-color 0.2s; }
        .selection-button:hover { background-color: rgba(255, 255, 255, 0.1); }
        .selection-button.active { border-color: rgb(var(--accent-color-rgb)); background-color: rgba(var(--accent-color-rgb), 0.2); font-weight: 600; }
        .animated-float { /* animation: liquid-float 15s ease-in-out infinite; */ } /* Optional: Keep or remove float */
        @keyframes liquid-float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Input placeholder colors */
        input[type="text"] { color: var(--text-main); }
        .dark body[data-contrast="high"] input[type="text"] { color: var(--text-contrast-dark) !important; }
        body[data-contrast="high"] input[type="text"] { color: var(--text-contrast-light) !important; }
         input::placeholder { color: var(--text-subtle); opacity: 0.7; }
         body[data-contrast="high"] input::placeholder { color: #6b7280; }
         .dark body[data-contrast="high"] input::placeholder { color: #9ca3af; }

        /* --- Loading Spinner --- */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto; /* Center the spinner */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Helper class for speak buttons in modals */
        .speak-button {
             @apply p-2 rounded-full hover:bg-white/20 transition-colors text-gray-200 hover:text-white flex-shrink-0;
        }
        
        /* --- MODIFICATION: Make speak buttons in lesson details modal contrast with new backgrounds --- */
        #lesson-details-content .speak-button {
            @apply text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white;
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-white shadow-sm">Spoken English Quiz</h1>
            <div class="flex items-center space-x-2">
                 <a href="game hub.html" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full glass-effect" aria-label="Go to Game Hub">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </a>
                <button id="curriculum-button" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors glass-effect" aria-label="View Curriculum">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                </button>
                <button id="settings-button" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors glass-effect" aria-label="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-200 hover:text-white transition-colors glass-effect" aria-label="Toggle Theme">
                    <svg id="theme-icon-light" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    <svg id="theme-icon-dark" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    <svg id="theme-icon-system" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
                </button>
            </div>
        </header>

        <div id="start-screen" class="text-center p-6 rounded-2xl glass-effect animated-float">
            <h2 class="text-2xl font-bold mb-4 text-white">Welcome!</h2>
            <p id="start-message" class="mb-6 subtle-text-color">Loading data... Please wait.</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <button id="class-selection-button" class="w-full text-white p-3 rounded-lg text-left button-bg-color hover:button-hover-bg transition-colors">
                    <span class="text-xs text-gray-400">Class</span><br>
                    <span id="current-class-selection" class="font-semibold"></span>
                </button>
                <button id="length-selection-button" class="w-full text-white p-3 rounded-lg text-left button-bg-color hover:button-hover-bg transition-colors">
                    <span class="text-xs text-gray-400">Quiz Length</span><br>
                    <span id="current-quiz-length" class="font-semibold"></span>
                </button>
            </div>
            
            <div id="lesson-tips-container" class="hidden text-left p-4 rounded-lg button-bg-color mt-6 glass-effect cursor-pointer hover:bg-white/10 transition-colors duration-200">
                <div class_="flex justify-between items-center">
                    <h3 id="lesson-tip-title" class="font-bold text-lg text-white mb-2">Lesson Focus:</h3>
                    <p class="text-xs text-gray-400 text-right -mt-6">Click to see full lesson</p>
                </div>
                <div class="flex items-center justify-between">
                    <p id="lesson-tip-en" class="text-sm text-gray-200 flex-1 pr-2"></p>
                    <button id="speak-en-tip" class="speak-button" aria-label="Speak tip in English">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    </button>
                </div>
                <hr class="border-white/20 my-2">
                <div class="flex items-center justify-between">
                    <p id="lesson-tip-te" class="text-sm text-gray-300 flex-1 pr-2"></p>
                    <button id="speak-te-tip" class="speak-button" aria-label="Speak tip in Telugu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    </button>
                </div>
            </div>
            
            <button id="start-quiz-button" disabled class="w-full mt-6 accent-bg text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                Start Quiz
            </button>
        </div>

        <div id="quiz-screen" class="hidden animated-float">
             <div class="flex justify-between items-center mb-4">
                <div id="stats" class="text-sm font-semibold subtle-text-color">Question 1/10</div>
                <div id="score" class="text-sm font-semibold subtle-text-color">Score: 0</div>
            </div>
            <div class="w-full rounded-full h-2.5 mb-4 button-bg-color">
                <div id="progress-bar" class="accent-bg h-2.5 rounded-full" style="width: 10%"></div>
            </div>
            
            <div id="question-container" class="p-6 rounded-2xl glass-effect"></div>
            
            <button id="next-question-button" class="hidden mt-6 w-full accent-bg text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">Next</button>
        </div>

        <div id="results-screen" class="hidden text-center p-6 rounded-2xl glass-effect animated-float">
             <h2 class="text-2xl font-bold mb-2 text-white">Quiz Complete!</h2>
             
             <div class="flex items-center justify-center space-x-2 mb-2">
                 <p id="final-score-text-en" class="text-lg text-gray-200">Your final score is <span id="final-score" class="font-bold accent-text"></span></p>
                 <button id="speak-result-en" class="speak-button" aria-label="Speak score in English">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                 </button>
             </div>
             
             <div class="flex items-center justify-center space-x-2 mb-4">
                 <p id="final-score-text-te" class="text-lg text-gray-300">మీ తుది స్కోరు <span id="final-score-te" class="font-bold accent-text"></span></p>
                 <button id="speak-result-te" class="speak-button" aria-label="Speak score in Telugu">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                 </button>
             </div>
             
             <h3 class="text-lg font-bold text-white mb-2 text-left">Question Summary</h3>
             <div id="results-details" class="text-left mb-6 space-y-2 max-h-40 overflow-y-auto no-scrollbar button-bg-color p-3 rounded-lg">
                 </div>
             
             <div id="ai-feedback-section" class="hidden text-left mt-6 border-t border-white/20 pt-4"> <h3 class="text-xl font-bold mb-3 text-white">AI Coach Feedback</h3>
                 <div id="ai-offline-message" class="hidden text-center subtle-text-color p-4 rounded-lg button-bg-color mb-4">
                     </div>
                 <div id="ai-loading-indicator" class="hidden text-center subtle-text-color"> <div class="spinner"></div>
                     Generating personalized feedback...
                 </div>
                 <div id="ai-content" class="hidden space-y-4 text-sm">
                    <div class="p-3 rounded-lg button-bg-color">
                        <strong class="block text-gray-200 mb-1">Feedback (English):</strong>
                        <p id="feedback-en" class="text-gray-300"></p>
                    </div>
                     <div class="p-3 rounded-lg button-bg-color">
                        <strong class="block text-gray-200 mb-1">ఫీడ్‌బ్యాక్ (తెలుగు):</strong>
                        <p id="feedback-te" class="text-gray-300"></p>
                    </div>
                    <div class="p-3 rounded-lg button-bg-color">
                        <strong class="block text-gray-200 mb-1">Coaching (English):</strong>
                        <p id="coaching-en" class="text-gray-300"></p>
                    </div>
                     <div class="p-3 rounded-lg button-bg-color">
                        <strong class="block text-gray-200 mb-1">కోచింగ్ (తెలుగు):</strong>
                        <p id="coaching-te" class="text-gray-300"></p>
                    </div>
                    <div class="p-3 rounded-lg button-bg-color">
                        <strong class="block text-gray-200 mb-1">Tips & Tricks (English):</strong>
                        <p id="tips-en" class="text-gray-300"></p>
                    </div>
                     <div class="p-3 rounded-lg button-bg-color">
                        <strong class="block text-gray-200 mb-1">చిట్కాలు & ఉపాయాలు (తెలుగు):</strong>
                        <p id="tips-te" class="text-gray-300"></p>
                    </div>
                    <p id="ai-error" class="text-red-400 text-center hidden">Could not generate AI feedback at this time.</p>
                 </div>
             </div>
             
             <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="next-class-button" class="hidden w-full accent-bg text-white font-bold py-3 px-6 rounded-lg shadow-md hover:opacity-90 transition-opacity">
                    Move to Next Class
                </button>
                
                <button id="restart-quiz-button" class="w-full button-bg-color text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:button-hover-bg transition-opacity sm:col-span-1">
                    Play Again (This Class)
                </button>
            </div>
            </div>
    </div>

    <div id="selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-xl p-6 w-full max-w-sm max-h-[80vh] flex flex-col modal-glass">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-white">Select Option</h3>
                <button id="close-selection-modal" class="text-gray-300 hover:text-white text-2xl font-bold" aria-label="Close modal">&times;</button>
            </div>
            <div id="modal-options" class="space-y-2 overflow-y-auto no-scrollbar">
                </div>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="rounded-2xl shadow-xl p-6 w-full max-w-md modal-glass"> 
             <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Settings</h3>
                <button id="close-settings-modal" class="text-gray-300 hover:text-white text-2xl font-bold" aria-label="Close settings modal">&times;</button>
            </div>
            <div class="space-y-4">
                <button id="color-button" class="w-full p-3 rounded-lg text-left button-bg-color hover:button-hover-bg text-white flex justify-between items-center">
                    <div> <span class="text-xs text-gray-400">Accent Color</span><br> <span id="current-accent-color" class="font-semibold"></span> </div>
                     <span id="color-preview" class="w-5 h-5 rounded-full border border-white/20"></span>
                </button>
                
                <div>
                     <span class="text-xs text-gray-400 block mb-1">Theme</span>
                     <div class="flex space-x-2"> 
                          <button id="theme-light" onclick="handleSelectionChange('theme', 'light')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">Light</button>
                          <button id="theme-dark" onclick="handleSelectionChange('theme', 'dark')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">Dark</button>
                          <button id="theme-system" onclick="handleSelectionChange('theme', 'system')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">System</button>
                     </div>
                </div>

                <div>
                     <span class="text-xs text-gray-400 block mb-1">Text Contrast</span>
                     <div class="flex space-x-2"> 
                          <button id="contrast-default" onclick="handleSelectionChange('contrast', 'default')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">Default</button>
                          <button id="contrast-high" onclick="handleSelectionChange('contrast', 'high')" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white">High Contrast</button>
                     </div>
                </div>

                <!-- MODIFIED: Added Font Combination buttons -->
                <div>
                     <span class="text-xs text-gray-400 block mb-1">Font Combination</span>
                     <div id="font-combo-btns" class="grid grid-cols-2 gap-2">
                         <button onclick="applyFontCombination('default1')" data-combo="default1" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white text-center">
                             <strong>Default 1</strong><br><span class="text-xs text-gray-400">Elegant Serif</span>
                         </button>
                         <button onclick="applyFontCombination('default2')" data-combo="default2" class="flex-1 py-2 px-3 rounded-lg text-sm selection-button text-white text-center">
                             <strong>Default 2</strong><br><span class="text-xs text-gray-400">Modern Sans</span>
                         </button>
                     </div>
                </div>
                <hr class="border-white/20">
                <span class="text-xs text-gray-400 text-center block -mt-2 mb-2">Or Customize Manually:</span>
                <!-- End of modification -->

                <button id="body-font-button" class="w-full p-3 rounded-lg text-left button-bg-color hover:button-hover-bg text-white">
                    <span class="text-xs text-gray-400">Body Font</span><br> <span id="current-body-font" class="font-semibold"></span>
                </button>
                <button id="title-font-button" class="w-full p-3 rounded-lg text-left button-bg-color hover:button-hover-bg text-white">
                    <span class="text-xs text-gray-400">Title Font</span><br> <span id="current-title-font" class="font-semibold"></span>
                </button>
                <div>
                     <span class="text-xs text-gray-400 block mb-1">Feedback</span>
                     <div class="space-y-2">
                         <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg button-bg-color hover:button-hover-bg text-white">
                            <input type="checkbox" id="toggle-audio" onclick="handleSelectionChange('toggleAudio')" class="form-checkbox h-5 w-5 rounded accent-bg border-gray-500 bg-transparent focus:ring-offset-0 focus:ring-0 text-accent-color-hex">
                            <span>Disable Sound Effects</span>
                         </label>
                         <label class="flex items-center space-x-3 cursor-pointer p-2 rounded-lg button-bg-color hover:button-hover-bg text-white">
                            <input type="checkbox" id="toggle-haptics" onclick="handleSelectionChange('toggleHaptics')" class="form-checkbox h-5 w-5 rounded accent-bg border-gray-500 bg-transparent focus:ring-offset-0 focus:ring-0 text-accent-color-hex">
                            <span>Disable Vibration (Haptics)</span>
                         </label>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div id="curriculum-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
         <div class="rounded-2xl shadow-xl p-6 w-full max-w-3xl max-h-[80vh] flex flex-col modal-glass">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">45-Day Spoken English Curriculum</h3>
                <button id="close-curriculum-modal" class="text-gray-300 hover:text-white text-2xl font-bold" aria-label="Close curriculum modal">&times;</button>
            </div>
            <div class="space-y-6 overflow-y-auto no-scrollbar pr-2 text-sm text-gray-300">
                <div> <h4 class="font-bold text-lg mb-2 accent-text">Phase I: Core Action and Simple Tense Mastery (Classes 01–12)</h4> <table class="w-full text-left"> <thead class="border-b border-white/20"> <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr> </thead> <tbody> <tr><td class="p-2">01</td><td class="p-2">Pronoun Roles</td><td class="p-2">Establishes the core sentence structure (S+V+O) and differentiates between subject and object pronouns.</td></tr> <tr><td class="p-2">02</td><td class="p-2">Self-Introduction</td><td class="p-2">Teaches the full framework for self-presentation.</td></tr> <tr><td class="p-2">03</td><td class="p-2">Regular Verbs</td><td class="p-2">Drills predictable conjugation patterns (V1, V2, V3, V-ing).</td></tr> <tr><td class="p-2">04</td><td class="p-2">Irregular Verbs</td><td class="p-2">Focuses on high-frequency irregular verbs (e.g., eat/ate/eaten).</td></tr> <tr><td class="p-2">05</td><td class="p-2">Simple Present Tense</td><td class="p-2">Expressing habitual actions, daily routines, and general truths.</td></tr> <tr><td class="p-2">06</td><td class="p-2">Simple Present (Do/Does)</td><td class="p-2">Using Do/Does for questions and negative statements.</td></tr> <tr><td class="p-2">07</td><td class="p-2">WH-Questions (Do/Does)</td><td class="p-2">Synthesizes Do/Does with question words (What, Why, Where, How).</td></tr> <tr><td class="p-2">08</td><td class="p-2">Simple Past Tense</td><td class="p-2">Using the Past Tense form (V2) to describe completed actions.</td></tr> <tr><td class="p-2">09</td><td class="p-2">Simple Past (Did)</td><td class="p-2">Using Did/didn't for questions and negatives in the Past Tense.</td></tr> <tr><td class="p-2">10</td><td class="p-2">WH-Questions (Did)</td><td class="p-2">Integrates Did with question words to ask about past actions.</td></tr> <tr><td class="p-2">11</td><td class="p-2">Simple Future Tense</td><td class="p-2">Using Shall/Will to express future intentions and actions.</td></tr> <tr><td class="p-2">12</td><td class="p-2">WH-Questions (Shall/Will)</td><td class="p-2">Applies Shall/Will with WH-Words to inquire about future plans.</td></tr> </tbody> </table> </div>
                <div> <h4 class="font-bold text-lg mb-2 accent-text">Phase II: Actions in Progress—Mastery of Continuous Forms (Classes 13–15)</h4> <table class="w-full text-left"> <thead class="border-b border-white/20"> <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr> </thead> <tbody> <tr><td class="p-2">13</td><td class="p-2">Present Continuous</td><td class="p-2">Using Am/Is/Are + V-ing for actions happening now.</td></tr> <tr><td class="p-2">14</td><td class="p-2">Past Continuous</td><td class="p-2">Using Was/Were + V-ing for ongoing past actions.</td></tr> <tr><td class="p-2">15</td><td class="p-2">Future Continuous</td><td class="p-2">Using Shall be/Will be + V-ing for actions that will be in progress.</td></tr> </tbody> </table> </div>
                <div> <h4 class="font-bold text-lg mb-2 accent-text">Phase III: Modality, Ability, and Obligation (Classes 16–20)</h4> <table class="w-full text-left"> <thead class="border-b border-white/20"> <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr> </thead> <tbody> <tr><td class="p-2">16</td><td class="p-2">Can/Could</td><td class="p-2">Expressing present ability (Can) and past ability (Could).</td></tr> <tr><td class="p-2">17</td><td class="p-2">May/Might</td><td class="p-2">Expressing uncertainty and possibility.</td></tr> <tr><td class="p-2">18</td><td class="p-2">Should</td><td class="p-2">Expressing general advice, responsibility, and duty.</td></tr> <tr><td class="p-2">19</td><td class="p-2">Must</td><td class="p-2">Expressing strong obligation, determination, or necessity.</td></tr> <tr><td class="p-2">20</td><td class="p-2">Would & Synthesis</td><td class="p-2">Using Would for past habits and synthesizing all learned forms.</td></tr> </tbody> </table> </div>
                <div> <h4 class="font-bold text-lg mb-2 accent-text">Phase IV: Perfect Tenses and Complex Modal Structures (Classes 21–35)</h4> <table class="w-full text-left"> <thead class="border-b border-white/20"> <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr> </thead> <tbody> <tr><td class="p-2">21</td><td class="p-2">Have/Has (Possession)</td><td class="p-2">Clarifies role in expressing current possession.</td></tr> <tr><td class="p-2">22</td><td class="p-2">Present Perfect</td><td class="p-2">Using Have/Has + P.P.F for recent past actions with present relevance.</td></tr> <tr><td class="p-2">23</td><td class="p-2">Past Perfect</td><td class="p-2">Using Had + P.P.F for an action that occurred before another past action.</td></tr> <tr><td class="p-2">24</td><td class="p-2">Future Perfect</td><td class="p-2">Using Shall have/Will have + P.P.F for actions completed by a future deadline.</td></tr> <tr><td class="p-2">25</td><td class="p-2">Should have/Must have</td><td class="p-2">Expressing past unfulfilled actions or strong assumptions.</td></tr> <tr><td class="p-2">26</td><td class="p-2">May have/Might have</td><td class="p-2">Expressing degrees of uncertainty about past actions.</td></tr> <tr><td class="p-2">27</td><td class="p-2">Would have/Could have</td><td class="p-2">Discussing hypothetical situations in the past (counterfactuals).</td></tr> <tr><td class="p-2">28</td><td class="p-2">Past Actions Review</td><td class="p-2">Comprehensive review of all 17 structures for past actions.</td></tr> <tr><td class="p-2">29</td><td class="p-2">Present Perfect Continuous</td><td class="p-2">Have been/Has been + V-ing for actions from past to present.</td></tr> <tr><td class="p-2">30</td><td class="p-2">Past Perfect Continuous</td><td class="p-2">Had been + V-ing for continuous actions before a past moment.</td></tr> <tr><td class="p-2">31</td><td class="p-2">Future Perfect Continuous</td><td class="p-2">Shall have been/Will have been + V-ing for action duration up to a future point.</td></tr> <tr><td class="p-2">32</td><td class="p-2">Continuous Modal Perfects</td><td class="p-2">Introduces structures like 'Should have been doing'.</td></tr> <tr><td class="p-2">33</td><td class="p-2">Application of Should/Must Have Been</td><td class="p-2">Drilling continuous modal perfects for past actions.</td></tr> <tr><td class="p-2">34</td><td class="p-2">Application of Would/Could Have Been</td><td class="p-2">Drilling continuous modals for hypothetical past actions.</td></tr> <tr><td class="p-2">35</td><td class="p-2">Application of May/Might Have Been & Review</td><td class="p-2">Final review of all modal and perfect forms.</td></tr> </tbody> </table> </div>
                <div> <h4 class="font-bold text-lg mb-2 accent-text">Phase V: Necessity, Desire, and Specialized Auxiliaries (Classes 36–41)</h4> <table class="w-full text-left"> <thead class="border-b border-white/20"> <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr> </thead> <tbody> <tr><td class="p-2">36</td><td class="p-2">Have to/Has to</td><td class="p-2">Expressing external compulsion in present and future.</td></tr> <tr><td class="p-2">37</td><td class="p-2">Need to/Dare to/Ought to</td><td class="p-2">Specialized auxiliaries for necessity, courage, and moral obligation.</td></tr> <tr><td class="p-2">38</td><td class="p-2">Want to/Wish to/Would like to</td><td class="p-2">Covers various expressions of desire and preference.</td></tr> <tr><td class="p-2">39</td><td class="p-2">Able to, Willing to, Going to</td><td class="p-2">Phrasal auxiliaries for ability, readiness, and planning.</td></tr> <tr><td class="p-2">40</td><td class="p-2">Had to (Past Obligation)</td><td class="p-2">Expressing a necessity or obligation in the past.</td></tr> <tr><td class="p-2">41</td><td class="p-2">Used to (Past Habit)</td><td class="p-2">Expressing a repeated past habit that is no longer performed.</td></tr> </tbody> </table> </div>
                <div> <h4 class="font-bold text-lg mb-2 accent-text">Phase VI: Synthesis, Tenses, and Voice (Classes 42–45)</h4> <table class="w-full text-left"> <thead class="border-b border-white/20"> <tr><th class="p-2 w-1/12">Class</th><th class="p-2 w-3/12">Focus</th><th class="p-2 w-8/12">Summary</th></tr> </thead> <tbody> <tr><td class="p-2">42</td><td class="p-2">The 12 Tenses Matrix</td><td class="p-2">Unified map of the English verbal system by time and aspect.</td></tr> <tr><td class="p-2">43</td><td class="p-2">12 Tenses Application</td><td class="p-2">Drilling a single verb across all twelve tenses.</td></tr> <tr><td class="p-2">44</td><td class="p-2">Active & Passive Voice</td><td class="p-2">Introduces voice transformation and auxiliary conversion.</td></tr> <tr><td class="p-2">45</td><td class="p-2">Be with P.P. Form</td><td class="p-2">Master key for expressing static states in all modal/auxiliary contexts.</td></tr> </tbody> </table> </div>
            </div>
        </div>
    </div>
    
    <div id="lesson-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
         <div class="rounded-2xl shadow-xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col modal-glass">
             <div class="flex justify-between items-center mb-4">
                <h3 id="lesson-details-title" class="text-xl font-bold text-white">Lesson Details</h3>
                <button id="close-lesson-details-modal" class="text-gray-300 hover:text-white text-2xl font-bold" aria-label="Close lesson details modal">&times;</button>
            </div>
            <!-- Diagram content will be styled by new CSS rule for .speak-button -->
            <div id="lesson-details-content" class="space-y-4 overflow-y-auto no-scrollbar pr-2 text-sm">
                <p>Loading lesson...</p>
            </div>
        </div>
    </div>


    <script src="diagram_data.js"></script>

    <script>
        // --- DOM Elements ---
        let startScreen, quizScreen, resultsScreen, questionContainer, startButton, nextButton, restartButton, curriculumButton;
        let lessonTipsContainer, lessonTipTitle, lessonTipEN, lessonTipTE, speakENTipButton, speakTETipButton;
        let stats, scoreEl, progressBar, finalScoreEl, finalScoreTeEl, speakResultEnBtn, speakResultTeBtn, resultsDetails, selectionModal, modalTitle, modalOptions;
        let settingsModal, themeToggle, themeIconLight, themeIconDark, themeIconSystem, startMessage, classSelectionButton, lengthSelectionButton; // Added themeIconSystem
        let currentClassSelection, currentQuizLength, closeSelectionModalBtn, closeSettingsModalBtn, closeCurriculumModalBtn;
        let bodyFontBtn, titleFontBtn, colorBtn, currentBodyFont, currentTitleFont, currentAccentColor;
        let contrastDefaultBtn, contrastHighBtn, toggleAudioCheckbox, toggleHapticsCheckbox, colorPreview;
        let themeLightBtn, themeDarkBtn, themeSystemBtn; // Added theme buttons
        // AI Feedback Elements
        let aiFeedbackSection, aiLoadingIndicator, aiContent, aiError, feedbackEnEl, feedbackTeEl, coachingEnEl, coachingTeEl, tipsEnEl, tipsTeEl;
        // Offline Message Element
        let aiOfflineMessage;
        // Lesson Details Modal Elements
        let lessonDetailsModal, closeLessonDetailsModalBtn, lessonDetailsTitle, lessonDetailsContent;
        // ***** NEW: Next Class Button Element *****
        let nextClassButton;


        // --- State ---
        let allQuestions = [];
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isDataLoaded = false;
        let isLessonDataLoaded = false; 
        let selectedClass = 1;
        let maxQuestions = 10;
        let synth;
        let correctSound, wrongSound;
        let disableSound = false;
        let disableVibration = false;
        let textContrast = 'default';
        let quizResults = []; // Stores all answers (correct and incorrect)

        // --- Constants ---
        // Use the same global settings key as game hub.html
        const SETTINGS_KEY = 'globalHubSettings';
        
        let CLASS_TOPICS = [];
        let LESSON_DATA = [];
        
        // MODIFIED: FONT_OPTIONS use clean names (e.g., 'Lexend')
        const FONT_OPTIONS = {
            body: [
                { label: 'Lexend', value: 'Lexend' }, // Default
                { label: 'DM Sans', value: 'DM Sans' },
                { label: 'Poppins', value: 'Poppins' },
                { label: 'Inter', value: 'Inter' },
                { label: 'Roboto', value: 'Roboto' },
                { label: 'Source Sans 3', value: 'Source Sans 3' },
                { label: 'Merriweather', value: 'Merriweather' }
            ],
            title: [
                { label: 'Montserrat', value: 'Montserrat' }, // Default
                { label: 'DM Serif Display', value: 'DM Serif Display' },
                { label: 'Outfit', value: 'Outfit' },
                { label: 'Lora', value: 'Lora' },
                { label: 'Playfair Display', value: 'Playfair Display' },
                { label: 'Merriweather', value: 'Merriweather' }
            ]
        };
        
        // Aligned color themes with game hub.html (added Teal, removed Emerald)
        const COLOR_THEMES = [ 
            { name: 'Indigo', value: '79, 70, 229', hex: '#4f46e5',
              gradient: { light: ['#a5b4fc', '#818cf8', '#6366f1', '#4f46e5'], dark: ['#312e81', '#4338ca', '#4f46e5', '#6366f1'] } }, 
            { name: 'Teal', value: '20, 184, 166', hex: '#14b8a6',
              gradient: { light: ['#99f6e4', '#5eead4', '#2dd4bf', '#14b8a6'], dark: ['#0f766e', '#0d9488', '#14b8a6', '#2dd4bf'] } },
            { name: 'Rose', value: '225, 29, 72', hex: '#e11d48',
              gradient: { light: ['#fecdd3', '#fda4af', '#fb7185', '#f43f5e'], dark: ['#881337', '#be123c', '#f43f5e', '#fb7185'] } }, 
            { name: 'Amber', value: '217, 119, 6', hex: '#d97706',
              gradient: { light: ['#fde68a', '#fcd34d', '#fbbf24', '#f59e0b'], dark: ['#78350f', '#b45309', '#f59e0b', '#fbbf24'] } },
            { name: 'Sky', value: '2, 132, 199', hex: '#0284c7',
              gradient: { light: ['#bae6fd', '#7dd3fc', '#38bdf8', '#0ea5e9'], dark: ['#0c4a6e', '#0369a1', '#0ea5e9', '#38bdf8'] } },
            { name: 'Cyan', value: '6, 182, 212', hex: '#06b6d4',
              gradient: { light: ['#a5f3fc', '#67e8f9', '#22d3ee', '#06b6d4'], dark: ['#155e75', '#0e7490', '#06b6d4', '#22d3ee'] } },
            { name: 'Pink', value: '219, 39, 119', hex: '#db2777',
              gradient: { light: ['#fbcfe8', '#f9a8d4', '#f472b6', '#ec4899'], dark: ['#831843', '#9d174d', '#db2777', '#ec4899'] } },
            { name: 'Orange', value: '234, 88, 12', hex: '#ea580c',
              gradient: { light: ['#fed7aa', '#fdba74', '#fdba74', '#f97316'], dark: ['#7c2d12', '#9a3412', '#ea580c', '#f97316'] } },
            { name: 'Purple', value: '147, 51, 234', hex: '#9333ea',
              gradient: { light: ['#e9d5ff', '#d8b4fe', '#c084fc', '#a855f7'], dark: ['#581c87', '#6b21a8', '#9333ea', '#a855f7'] } },
            { name: 'Emerald', value: '5, 150, 105', hex: '#059669',
              gradient: { light: ['#a7f3d0', '#6ee7b7', '#34d399', '#10b981'], dark: ['#064e3b', '#065f46', '#059669', '#10b981'] } }
        ];

        // NEW: Font Combination Definitions
        const FONT_COMBINATIONS = {
            'default1': { title: 'DM Serif Display', body: 'DM Sans' }, // Elegant
            'default2': { title: 'Montserrat', body: 'Lexend' } // Modern
        };

        // --- NEW: Theme logic variables ---
        let systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        let mediaQueryListener = (e) => {
            const htmlEl = document.documentElement;
            if (e.matches) {
                htmlEl.classList.add('dark');
            } else {
                htmlEl.classList.remove('dark');
            }
            // Re-apply accent color for gradients
            applyAccentColor(getLocalStorageSetting('colorTheme', COLOR_THEMES[0].name));
        };


        // --- Functions ---
        
        // Setup audio synthesizers
        function setupAudio() { 
            try {
                if (window.Tone) {
                    correctSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination();
                    wrongSound = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
                } else { console.warn("Tone.js not loaded."); }
                synth = window.speechSynthesis;
                if (!synth) { console.warn("Speech Synthesis not available."); }
            } catch (error) { console.error("Error setting up audio:", error); }
        }

        // Play sound and haptic feedback
        function playFeedback(isCorrect) { 
            try {
                if (!disableSound && window.Tone && correctSound && wrongSound) {
                    Tone.start(); 
                    if (isCorrect) correctSound.triggerAttackRelease('G5', '8n', Tone.now()); 
                    else wrongSound.triggerAttackRelease('C3', '4n', Tone.now());
                }
                if (!disableVibration && navigator.vibrate) { 
                    if (isCorrect) navigator.vibrate(100); 
                    else navigator.vibrate([150, 50, 150]); 
                }
            } catch (error) { console.error("Error playing feedback:", error); }
        }

        // Speak text using TTS
        function speak(text, lang = 'en-US') { 
            if (synth && text) { 
                try {
                    synth.cancel(); // Stop any previous speech
                    const utterance = new SpeechSynthesisUtterance(text); 
                    utterance.lang = lang; 
                    utterance.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); }; 
                    synth.speak(utterance); 
                } catch (error) { console.error("Error speaking text:", error); }
            } else if (!synth) { console.warn("Speech Synthesis not available."); }
        }

        // Parse a single row of CSV data, handling quotes
        function parseCsvRow(row) { 
            const values = []; const regex = /("([^"]|"")*"|[^,]*)(,|$)/g; let match; let processedRow = row.trim(); if (processedRow.charAt(processedRow.length - 1) !== ',') processedRow += ','; while ((match = regex.exec(processedRow)) !== null) { let value = match[1] || ''; if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1).replace(/""/g, '"'); values.push(value.trim()); if (match[3] === '') break; } if (values.length > 0 && values[values.length - 1] === '') values.pop(); return values;
        }

        // Get/Set Local Storage functions (using the global SETTINGS_KEY)
        function getLocalStorageSetting(key, defaultValue) { 
             try { 
                 const settingsString = localStorage.getItem(SETTINGS_KEY); 
                 if (!settingsString) return defaultValue; 
                 const settings = JSON.parse(settingsString); 
                 if (key === 'selectedClass' || key === 'maxQuestions') { const parsed = parseInt(settings[key]); return isNaN(parsed) ? defaultValue : parsed; } 
                 if (key === 'disableSound' || key === 'disableVibration') { return typeof settings[key] === 'boolean' ? settings[key] : defaultValue; } 
                 // Handle contrast default
                 if (key === 'contrast' && typeof settings[key] === 'undefined') { return 'default'; }
                 if (typeof settings[key] === 'undefined' || settings[key] === null) return defaultValue; 
                 return settings[key]; 
            } catch (e) { console.error(`Error loading local setting key ${key}:`, e); return defaultValue; }
        }
        function setLocalStorageSetting(key, value) { 
            try { 
                const settingsString = localStorage.getItem(SETTINGS_KEY); 
                let settings = settingsString ? JSON.parse(settingsString) : {}; 
                settings[key] = value; 
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); 
            } catch (e) { console.error(`Error saving local setting key ${key}:`, e); }
        }

        // Load question data from data.csv
        async function loadQuestions() { 
             try { 
                 const response = await fetch('data.csv'); 
                 if (!response.ok) throw new Error(`Failed to fetch data.csv. Status: ${response.status}`); 
                 const csvData = await response.text(); 
                 if (!csvData || csvData.trim().split(/\r?\n/).length <= 1) throw new Error("data.csv is empty or invalid."); 
                 
                 const lines = csvData.trim().split(/\r?\n/); 
                 const headers = parseCsvRow(lines[0]); 
                 allQuestions = lines.slice(1).map(line => { 
                     if (line.trim() === '') return null; 
                     const values = parseCsvRow(line); 
                     if (values.length < headers.length) { 
                         console.warn('Skipping question row, column count mismatch:', values); 
                         return null; 
                     } 
                     let question = {}; 
                     headers.forEach((header, i) => { 
                         question[header.trim()] = values[i] || ''; 
                     }); 
                     if (!question.lesson || !question.promptEN || !question.correct) { 
                         console.warn('Skipping question row, missing essential data:', question); 
                         return null; 
                     } 
                     return question; 
                 }).filter(q => q !== null); 
                 
                 if (allQuestions.length === 0) throw new Error("No valid questions were parsed from data.csv."); 
                 isDataLoaded = true; 
                 console.log(`Successfully loaded ${allQuestions.length} questions.`); 
             } catch (error) { 
                 console.error("Failed to load or parse questions:", error); 
                 isDataLoaded = false; 
             } 
        }

        // Load lesson data from data2.csv
        async function loadLessonData() {
            try {
                const response = await fetch('data2.csv');
                if (!response.ok) throw new Error(`Failed to fetch data2.csv. Status: ${response.status}`);
                const csvData = await response.text();
                if (!csvData || csvData.trim().split(/\r?\n/).length <= 1) throw new Error("data2.csv is empty or invalid.");

                const lines = csvData.trim().split(/\r?\n/);
                const headers = parseCsvRow(lines[0]);
                
                // Find indices of required columns by name
                const idx = {
                    classNum: headers.indexOf('Class_Number'),
                    titleEN: headers.indexOf('Class_Title_EN'),
                    tipEN: headers.indexOf('Tips_Tricks_EN'),
                    tipTE: headers.indexOf('Tips_Tricks_TE'),
                    keyTopicsEN: headers.indexOf('Key_Topics_EN'),
                    keyTopicsTE: headers.indexOf('Key_Topics_TE'),
                    instructionsEN: headers.indexOf('Instructions_EN'),
                    instructionsTE: headers.indexOf('Instructions_TE'),
                    usesEN: headers.indexOf('Uses_EN'),
                    usesTE: headers.indexOf('Uses_TE')
                };
                
                // Check if all essential columns are present
                if (idx.classNum === -1 || idx.titleEN === -1 || idx.tipEN === -1 || idx.tipTE === -1) {
                    throw new Error("data2.csv is missing required columns (e.g., Class_Number, Class_Title_EN, Tips_Tricks_EN, Tips_Tricks_TE).");
                }
                
                const parsedLessonData = [];
                const parsedClassTopics = [];

                lines.slice(1).forEach(line => {
                    if (line.trim() === '') return;
                    const values = parseCsvRow(line);
                    if (values.length < headers.length) {
                        console.warn('Skipping lesson row, column count mismatch:', values);
                        return;
                    }

                    const classNum = parseInt(values[idx.classNum], 10);
                    const titleEN = values[idx.titleEN];
                    
                    if (!classNum || !titleEN) {
                         console.warn('Skipping lesson row, missing class number or title:', values);
                         return;
                    }
                    
                    parsedLessonData.push({
                        class: classNum,
                        title: titleEN,
                        tipEN: values[idx.tipEN] || "No tip available.",
                        tipTE: values[idx.tipTE] || "చిట్కా అందుబాటులో లేదు.",
                        keyTopicsEN: values[idx.keyTopicsEN] || "No key topics available.",
                        keyTopicsTE: values[idx.keyTopicsTE] || "ముఖ్య విషయాలు అందుబాటులో లేవు.",
                        instructionsEN: values[idx.instructionsEN] || "No instructions available.",
                        instructionsTE: values[idx.instructionsTE] || "సూచనలు అందుబాటులో లేవు.",
                        usesEN: values[idx.usesEN] || "No usage examples available.",
                        usesTE: values[idx.usesTE] || "వాడుక ఉదాహరణలు అందుబాటులో లేవు."
                    });
                    
                    // Assuming class numbers are sequential and 1-based
                    parsedClassTopics[classNum - 1] = titleEN;
                });

                if (parsedLessonData.length === 0) throw new Error("No valid lessons were parsed from data2.csv.");

                // Assign to global variables
                LESSON_DATA = parsedLessonData;
                // Filter out any empty spots if classes weren't sequential
                CLASS_TOPICS = parsedClassTopics.filter(t => t); 

                isLessonDataLoaded = true;
                console.log(`Successfully loaded ${LESSON_DATA.length} lessons.`);
                
            } catch (error) {
                console.error("Failed to load or parse lesson data:", error);
                isLessonDataLoaded = false;
            }
        }

        // Start the quiz
        function startQuiz() { 
            const filtered = allQuestions.filter(q => parseInt(q.lesson, 10) === selectedClass); currentQuestions = filtered.sort(() => 0.5 - Math.random()).slice(0, maxQuestions); if (currentQuestions.length === 0) { if(startMessage) startMessage.textContent = `No questions available for Class ${selectedClass}. Please select another class.`; return; } currentQuestionIndex = 0; score = 0; 
            quizResults = []; // Reset the results array
            
            if(lessonTipsContainer) lessonTipsContainer.classList.add('hidden'); if(startScreen) startScreen.classList.add('hidden'); if(resultsScreen) resultsScreen.classList.add('hidden'); if(quizScreen) quizScreen.classList.remove('hidden'); displayQuestion();
        }

        // Display the current question
        function displayQuestion() { 
            if(nextButton) nextButton.classList.add('hidden'); const question = currentQuestions[currentQuestionIndex]; if (!question) { console.error("No question data found for index:", currentQuestionIndex); showResults(); return; } if(stats) stats.textContent = `Question ${currentQuestionIndex + 1}/${currentQuestions.length}`; if(scoreEl) scoreEl.textContent = `Score: ${score}`; if(progressBar) progressBar.style.width = `${((currentQuestionIndex + 1) / currentQuestions.length) * 100}%`; const prompt = `<div class="flex items-center justify-between mb-4"> <p class="text-lg subtle-text-color">${question.promptTE || ''}</p> <button onclick="speak('${(question.promptEN || '').replace(/'/g, "\\'")}', 'en-US')" class="speak-button" aria-label="Speak prompt in English"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> </button> </div> <h2 class="text-2xl font-bold mb-6 text-white">${question.promptEN || 'Question Text Missing'}</h2>`; let content = ''; if (question.type === 'mcq') { const options = ['A', 'B', 'C', 'D'] .filter(opt => question[opt] !== undefined && question[opt] !== '') .map(opt => ` <div class="flex items-center space-x-2"> <button onclick="checkAnswer('${opt}', this.parentElement)" class="flex-grow text-left p-4 border-2 border-white/30 rounded-lg hover:accent-border hover:bg-white/10 transition-all duration-200"> ${question[opt]} </button> <button onclick="speak('${(question[opt] || '').replace(/'/g, "\\'")}', 'en-US')" class="speak-button -mr-2" aria-label="Speak option"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> </button> </div>`).join(''); content = `${prompt}<div class="space-y-3">${options}</div>`; } else if (question.type === 'fill_blank') { content = `${prompt}<input id="fill-blank-input" type="text" class="w-full p-4 border-2 border-white/30 rounded-lg bg-transparent focus:outline-none focus:ring-2 accent-ring text-white" placeholder="Type your answer..."><button onclick="checkFillBlank()" class="mt-4 w-full accent-bg text-white font-bold py-3 rounded-lg">Check Answer</button>`; } else { content = `${prompt}<p class="text-red-400">Error: Unknown question type "${question.type}"</p>`; } if(questionContainer) { questionContainer.innerHTML = `<div class="fade-in">${content}</div><div id="feedback" class="mt-4"></div>`; if (textContrast === 'high') document.body.setAttribute('data-contrast', 'high'); } else { console.error("Question container not found!"); }
        }
        
        // Check answer for MCQ
        window.checkAnswer = function(selected, parentElement) { 
            if (!parentElement) return; 
            const question = currentQuestions[currentQuestionIndex]; 
            if (!question) return; 
            const isCorrect = selected === question.correct; 
            
            // Store result for every question
            quizResults.push({
                question: question.promptEN,
                yourAnswer: question[selected] || selected,
                correctAnswer: question[question.correct] || question.correct,
                isCorrect: isCorrect
            });

            const allOptionDivs = questionContainer?.querySelectorAll('.flex.items-center.space-x-2'); 
            allOptionDivs?.forEach(div => { div.querySelectorAll('button').forEach(btn => btn.disabled = true); }); 
            
            playFeedback(isCorrect); 
            
            const firstButton = parentElement.querySelector('button:first-child'); 
            if (!firstButton) return; 
            
            if (isCorrect) { 
                score++; 
                firstButton.classList.add('bg-green-500/50', 'border-green-400'); 
            } else { 
                firstButton.classList.add('bg-red-500/50', 'border-red-400'); 
                // Highlight the correct answer
                allOptionDivs?.forEach(div => { 
                    const button = div.querySelector('button:first-child'); 
                    const correctAnswerText = question[question.correct] ? String(question[question.correct]).trim() : ''; 
                    if (button && correctAnswerText && button.textContent.trim() === correctAnswerText) { 
                        button.classList.add('bg-green-500/50', 'border-green-400'); 
                    } 
                }); 
            } 
            displayFeedback(isCorrect);
        }

        // Check answer for Fill in the Blank
        window.checkFillBlank = function() { 
            const input = document.getElementById('fill-blank-input'); 
            if (!input) return; 
            const question = currentQuestions[currentQuestionIndex]; 
            if (!question || !question.correct) return; 
            
            const userAnswer = input.value.trim().toLowerCase().replace(/[.,!?;:]/g, ''); 
            const correctAnswer = question.correct.trim().toLowerCase().replace(/[.,!?;:]/g, ''); 
            const isCorrect = userAnswer === correctAnswer; 

            // Store result for every question
            quizResults.push({
                question: question.promptEN,
                yourAnswer: input.value || "(empty)", // Store the user's raw input
                correctAnswer: question.correct,
                isCorrect: isCorrect
            });

            input.disabled = true; 
            const checkButton = questionContainer?.querySelector('button:not([onclick^="speak"])'); 
            if(checkButton) checkButton.disabled = true; 
            
            playFeedback(isCorrect); 
            
            if (isCorrect) { 
                score++; 
                input.classList.add('bg-green-500/50', 'border-green-400'); 
            } else { 
                input.classList.add('bg-red-500/50', 'border-red-400'); 
            } 
            displayFeedback(isCorrect);
        }

        // Display feedback after an answer
        function displayFeedback(isCorrect) { 
             const feedbackEl = document.getElementById('feedback'); if (!feedbackEl) return; const question = currentQuestions[currentQuestionIndex]; if (!question) return; const icon = isCorrect ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-green-300"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-red-300"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`; const feedbackContent = ` <div class="fade-in p-4 rounded-lg glass-effect"> <p class="font-semibold">${icon} ${isCorrect ? 'Correct!' : 'Not quite.'}</p> <div class="flex items-center justify-between mt-2"> <p class="text-sm text-gray-300 flex-1 pr-2">${question.feedbackEN || ''}</p> <button onclick="speak('${(question.feedbackEN || '').replace(/'/g, "\\'")}', 'en-US')" class="speak-button -mr-1" aria-label="Speak feedback in English"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> </button> </div> <div class="flex items-center justify-between mt-1"> <p class="text-sm text-gray-400 flex-1 pr-2">${question.feedbackTE || ''}</p> <button onclick="speak('${(question.feedbackTE || '').replace(/'/g, "\\'")}', 'te-IN')" class="speak-button -mr-1" aria-label="Speak feedback in Telugu"> <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> </button> </div> </div>`; feedbackEl.innerHTML = feedbackContent; if (nextButton) nextButton.classList.remove('hidden');
        }

        // Move to the next question or show results
        function handleNextQuestion() { 
            currentQuestionIndex++; if (currentQuestionIndex < currentQuestions.length) displayQuestion(); else showResults();
        }
        
        // Check if the user is online
        function isOnline() { return navigator.onLine; }
        
        // Show the final results screen
        function showResults() { 
             if(quizScreen) quizScreen.classList.add('hidden'); 
             if(resultsScreen) resultsScreen.classList.remove('hidden'); 
             const totalQuestions = currentQuestions.length;
             const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0; 
             
             const scoreString = `${score}/${totalQuestions} (${percentage}%)`;
             const scoreStringEn = `Your final score is ${score} out of ${totalQuestions}, which is ${percentage} percent.`;
             const scoreStringTe = `మీ తుది స్కోరు ${totalQuestions} కి ${score}, అంటే ${percentage} శాతం.`;

             if(finalScoreEl) finalScoreEl.textContent = scoreString;
             if(finalScoreTeEl) finalScoreTeEl.textContent = scoreString; // Also update the Telugu span

             // Add speak button listeners
             if (speakResultEnBtn) {
                 speakResultEnBtn.onclick = () => speak(scoreStringEn, 'en-US');
             }
             if (speakResultTeBtn) {
                 speakResultTeBtn.onclick = () => speak(scoreStringTe, 'te-IN');
             }
             
             // Populate results details with ALL questions
             if(resultsDetails) {
                 resultsDetails.innerHTML = quizResults.length > 0 
                     ? quizResults.map((item, i) => 
                         `<div class="p-2 rounded-md button-bg-color text-xs">
                             <p class="font-semibold text-gray-300 flex items-center">
                                ${item.isCorrect 
                                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-green-400 flex-shrink-0"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>` 
                                    : `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-red-400 flex-shrink-0"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`
                                }
                                <span>${i+1}. ${item.question}</span>
                             </p>
                             <p class="${item.isCorrect ? 'text-gray-400' : 'text-red-400'} pl-6">You: ${item.yourAnswer}</p>
                             ${!item.isCorrect ? `<p class="text-green-400 pl-6">Correct: ${item.correctAnswer}</p>` : ''}
                          </div>`
                       ).join('')
                     : '<p class="text-center text-gray-400 text-sm">No results to display.</p>';
                 resultsDetails.scrollTop = 0; // Scroll to top of list
             } 
             
             saveProgress();
             
             // --- Check online status for AI Feedback ---
             if (isOnline()) {
                 if (aiFeedbackSection) aiFeedbackSection.classList.remove('hidden'); // Show the AI section
                 if (aiOfflineMessage) aiOfflineMessage.classList.add('hidden');    // Hide offline msg
                 getAIFeedback(); // Attempt to get AI feedback
             } else {
                 // Completely hide the AI section if offline
                 if (aiFeedbackSection) aiFeedbackSection.classList.add('hidden'); 
                 console.log("Offline: Skipping AI feedback generation.");
             }
             
            // --- ***** NEW: Logic for "Next Class" button ***** ---
            if (nextClassButton && restartButton) {
                const isLastClass = selectedClass >= LESSON_DATA.length; // Use LESSON_DATA.length
                
                if (percentage >= 50 && !isLastClass) {
                    // Show "Next Class" button
                    nextClassButton.classList.remove('hidden');
                    // Make "Play Again" button secondary
                    restartButton.classList.add('sm:col-span-1');
                    restartButton.classList.remove('sm:col-span-2');
                    restartButton.classList.remove('accent-bg'); // Remove primary color
                    restartButton.classList.add('button-bg-color', 'font-semibold'); // Add secondary color
                    restartButton.textContent = "Play Again (This Class)";
                } else {
                    // Hide "Next Class" button
                    nextClassButton.classList.add('hidden');
                    // Make "Play Again" button primary and full-width
                    restartButton.classList.remove('sm:col-span-1');
                    restartButton.classList.add('sm:col-span-2'); // Span full width
                    restartButton.classList.add('accent-bg'); // Add primary color
                    restartButton.classList.remove('button-bg-color', 'font-semibold'); // Remove secondary color
                    restartButton.textContent = "Play Again";
                }
            }
            // --- ***** END OF NEW LOGIC ***** ---
        }

        // Get AI Feedback from Gemini API
        async function getAIFeedback() {
            if (!aiLoadingIndicator || !aiContent || !aiError || !aiFeedbackSection) return; 

            // Ensure the AI section is visible before showing loading
            aiFeedbackSection.classList.remove('hidden'); 
            aiLoadingIndicator.classList.remove('hidden');
            aiContent.classList.add('hidden');
            aiError.classList.add('hidden');
            if (aiOfflineMessage) aiOfflineMessage.classList.add('hidden'); 

            const lessonTitle = CLASS_TOPICS[selectedClass - 1] || `Lesson ${selectedClass}`;
            const totalQuestions = currentQuestions.length;
            const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;

            // Build summary from quizResults
            const incorrectSummary = quizResults.filter(r => !r.isCorrect).length > 0 
                ? `Incorrect answers included: ${quizResults.filter(r => !r.isCorrect).map(item => `Question: "${item.question.substring(0, 50)}...", Your Answer: "${item.yourAnswer}", Correct: "${item.correctAnswer}"`).slice(0, 5).join('; ')}` 
                : "No incorrect answers.";

            const userQuery = `Completed Spoken English Class ${selectedClass} (${lessonTitle}). Score: ${score}/${totalQuestions} (${percentage}%). ${incorrectSummary}`;

            const systemPrompt = `Act as a friendly and encouraging English tutor. The user just completed a quiz for a specific Spoken English lesson. 
            Provide concise feedback, coaching, and tips based on their score and the lesson topic. Keep each section brief (1-2 sentences). 
            Address the user directly. Provide the response in both English and Telugu. 
            Focus coaching on the general topic if there were no errors, or on the types of errors made if available.
            Location context: Visakhapatnam, Andhra Pradesh, India. Current time: Sunday, October 26, 2025 at 12:08 PM IST.`;

             const payload = {
                 contents: [{ parts: [{ text: userQuery }] }],
                 systemInstruction: { parts: [{ text: systemPrompt }] },
                 generationConfig: {
                     responseMimeType: "application/json",
                     responseSchema: {
                         type: "OBJECT",
                         properties: {
                             "feedbackEN": { "type": "STRING", "description": "Overall feedback in English based on the score (1-2 sentences)." },
                             "feedbackTE": { "type": "STRING", "description": "Overall feedback in Telugu based on the score (1-Unchanged)." },
                             "coachingEN": { "type": "STRING", "description": "Specific coaching advice in English, mentioning areas for improvement based on incorrect answers or lesson topic (1-2 sentences)." },
                             "coachingTE": { "type": "STRING", "description": "Specific coaching advice in Telugu (1-2 sentences)." },
                             "tipsEN": { "type": "STRING", "description": "Relevant tips or tricks in English related to the lesson topic (1-2 sentences)." },
                             "tipsTE": { "type": "STRING", "description": "Relevant tips or tricks in Telugu (1-2 sentences)." }
                         }
                     }
                 }
             };

            const apiKey = "AIzaSyCLTCvCybpcM9Yiw9lVY8SnwGTs2yPBZSc"; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            let retries = 0;
            const maxRetries = 3;
            
            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        console.error("API Error Response:", response.status, await response.text());
                         if (response.status === 429 || response.status >= 500) { 
                            // Retry on rate limit or server error
                            throw new Error(`API Error: ${response.status}`);
                        } else {
                             // Don't retry on bad requests (e.g., 400)
                             throw new Error(`API Request Failed: ${response.status}`);
                        }
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const parsedJson = JSON.parse(jsonText);

                        // Populate the AI content fields
                        if(feedbackEnEl) feedbackEnEl.textContent = parsedJson.feedbackEN || "N/A";
                        if(feedbackTeEl) feedbackTeEl.textContent = parsedJson.feedbackTE || "N/Adding";
                        if(coachingEnEl) coachingEnEl.textContent = parsedJson.coachingEN || "N/A";
                        if(coachingTeEl) coachingTeEl.textContent = parsedJson.coachingTE || "N/A";
                        if(tipsEnEl) tipsEnEl.textContent = parsedJson.tipsEN || "N/A";
                        if(tipsTeEl) tipsTeEl.textContent = parsedJson.tipsTE || "N/A";

                        aiLoadingIndicator.classList.add('hidden');
                        aiContent.classList.remove('hidden');
                        aiError.classList.add('hidden');
                        return; // Success, exit the loop
                    } else {
                        console.error("Unexpected API response structure:", result);
                         throw new Error("Invalid API response structure.");
                    }

                } catch (error) {
                    console.error("Error fetching AI feedback (retry " + (retries+1) + "):", error);
                    retries++;
                    if (retries >= maxRetries) {
                        // Max retries reached
                        aiLoadingIndicator.classList.add('hidden');
                        aiContent.classList.add('hidden');
                        aiError.classList.remove('hidden');
                         if(aiError) aiError.textContent = "Sorry, couldn't get AI feedback after multiple attempts. Please try again later.";
                        break; // Exit loop
                    }
                    // Wait with exponential backoff
                    const delay = Math.pow(2, retries) * 1000; 
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            } // end while loop
        }
        
        // Save progress to local storage (for the hub)
        function saveProgress() { 
             try { 
                 // We use 'englishHubProgress' to be consistent with the hub
                 let progress = JSON.parse(localStorage.getItem('englishHubProgress') || '{}'); 
                 if (typeof progress !== 'object' || progress === null) progress = {}; 
                 // Only update if the current class is higher than the saved one
                 if (!progress.spoken || typeof progress.spoken !== 'number' || progress.spoken < selectedClass) { 
                     progress.spoken = selectedClass; 
                 } 
                 localStorage.setItem('englishHubProgress', JSON.stringify(progress)); 
                 console.log("Progress saved:", progress); 
            } catch (e) { console.error("Failed to save progress:", e); }
         }

        // Update the lesson tip on the start screen
        function updateLessonTip(classNumber) { 
            const lessonData = LESSON_DATA.find(l => l.class === classNumber); 
            if (lessonData && lessonTipTitle && lessonTipEN && lessonTipTE && speakENTipButton && speakTETipButton && lessonTipsContainer) { 
                lessonTipTitle.textContent = `Lesson ${classNumber}: ${lessonData.title}`; 
                lessonTipEN.textContent = lessonData.tipEN; 
                lessonTipTE.textContent = lessonData.tipTE; 
                
                // Stop propagation to prevent modal from opening when clicking speak buttons
                speakENTipButton.onclick = (e) => { e.stopPropagation(); speak(lessonData.tipEN, 'en-US'); }; 
                speakTETipButton.onclick = (e) => { e.stopPropagation(); speak(lessonData.tipTE, 'te-IN'); }; 
                
                lessonTipsContainer.classList.remove('hidden'); 
                lessonTipsContainer.classList.add('fade-in'); 
            } else if (lessonTipsContainer) { 
                lessonTipsContainer.classList.add('hidden'); 
            }
        }
        
        // --- REFACTORED: Theme Functions ---

        // Apply light/dark/system theme
        function applyTheme(theme) {
            const htmlEl = document.documentElement;
            
            // 1. Remove existing listener
            try {
                systemPrefersDark.removeEventListener('change', mediaQueryListener);
            } catch (e) {
                // Ignore errors if listener wasn't attached
            }

            // 2. Set dark class based on theme
            if (theme === 'light') {
                htmlEl.classList.remove('dark');
            } else if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else { // 'system'
                if (systemPrefersDark.matches) {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
                // 3. Add listener ONLY for system theme
                try {
                    systemPrefersDark.addEventListener('change', mediaQueryListener);
                } catch (e) {
                    console.error("Error adding theme listener:", e);
                }
            }
            
            // 4. Update UI and save settings
            updateHeaderIcon(theme);
            updateThemeButtonsUI();
            setLocalStorageSetting('theme', theme);
            
            // 5. Re-apply accent color (it will read the new DOM state)
            applyAccentColor(getLocalStorageSetting('colorTheme', COLOR_THEMES[0].name));
        }

        // NEW: Update header icon based on theme
        function updateHeaderIcon(theme) {
            if (!themeIconLight || !themeIconDark || !themeIconSystem) return;
            themeIconLight.classList.add('hidden');
            themeIconDark.classList.add('hidden');
            themeIconSystem.classList.add('hidden');

            if (theme === 'light') {
                themeIconLight.classList.remove('hidden');
            } else if (theme === 'dark') {
                themeIconDark.classList.remove('hidden');
            } else { // system
                themeIconSystem.classList.remove('hidden');
            }
        }

        // NEW: Update theme buttons in settings modal
        function updateThemeButtonsUI() {
            const currentTheme = getLocalStorageSetting('theme', 'system');
            if (themeLightBtn) themeLightBtn.classList.toggle('active', currentTheme === 'light');
            if (themeDarkBtn) themeDarkBtn.classList.toggle('active', currentTheme === 'dark');
            if (themeSystemBtn) themeSystemBtn.classList.toggle('active', currentTheme === 'system');
        }
        
        // MODIFIED: Apply font settings (accepts clean name)
        function setBodyFont(fontName) { 
            if (fontName) {
                // Add fallback
                const fallback = (fontName === 'Merriweather') ? 'serif' : 'sans-serif';
                const fontValue = `'${fontName}', ${fallback}`;
                
                document.documentElement.style.setProperty('--body-font', fontValue); 
                setLocalStorageSetting('bodyFont', fontName); // Save ONLY the name
                updateFontCombinationUI(); // Update combo buttons
            }
        }
        function setTitleFont(fontName) { 
            if (fontName) {
                // Add fallback
                const fallback = (fontName === 'Lora' || fontName === 'Playfair Display' || fontName === 'Merriweather' || fontName === 'DM Serif Display') ? 'serif' : 'sans-serif';
                const fontValue = `'${fontName}', ${fallback}`;
                
                document.documentElement.style.setProperty('--title-font', fontValue); 
                setLocalStorageSetting('titleFont', fontName); // Save ONLY the name
                updateFontCombinationUI(); // Update combo buttons
            }
        }
        
        // Apply accent color and gradients
        function applyAccentColor(name) {
             const theme = COLOR_THEMES.find(t => t.name === name) || COLOR_THEMES[0];
             const rootStyle = document.documentElement.style;
             const isDark = document.documentElement.classList.contains('dark'); // Reads current state
             const gradientSet = theme.gradient && theme.gradient[isDark ? 'dark' : 'light'] && theme.gradient[isDark ? 'dark' : 'light'].length === 4 
                               ? theme.gradient[isDark ? 'dark' : 'light'] 
                               : COLOR_THEMES[0].gradient[isDark ? 'dark' : 'light']; 
             rootStyle.setProperty('--accent-color-rgb', theme.value);
             rootStyle.setProperty('--accent-color-hex', theme.hex); 
             rootStyle.setProperty('--bg-grad-color1', gradientSet[0]);
             rootStyle.setProperty('--bg-grad-color2', gradientSet[1]);
             rootStyle.setProperty('--bg-grad-color3', gradientSet[2]);
             rootStyle.setProperty('--bg-grad-color4', gradientSet[3]); 
             setLocalStorageSetting('colorTheme', name);
             updateColorButton(); 
         }
        
        // Apply text contrast setting
        function applyContrast(contrastValue) { 
             textContrast = contrastValue; 
             document.body.setAttribute('data-contrast', contrastValue); 
             setLocalStorageSetting('contrast', contrastValue); 
             updateContrastButtonsUI(); 
         }

        // Load all settings from local storage on startup
        function loadInitialSettings() { 
             // Load settings from the global key
             const savedTheme = getLocalStorageSetting('theme', 'system'); // Default to system
             applyTheme(savedTheme); // applyTheme now handles logic and saving
             
             // MODIFIED: Load fonts, falling back to new aligned defaults (clean names)
             setBodyFont(getLocalStorageSetting('bodyFont', FONT_OPTIONS.body[0].value)); 
             setTitleFont(getLocalStorageSetting('titleFont', FONT_OPTIONS.title[0].value)); 
             
             // Load color, falling back to new aligned default
             // applyAccentColor is already called by applyTheme
             
             // Load contrast
             applyContrast(getLocalStorageSetting('contrast', 'default')); 
             
             // Load app-specific settings (sound/haptics)
             disableSound = getLocalStorageSetting('disableSound', false); 
             disableVibration = getLocalStorageSetting('disableVibration', false); 
             
             // Load class/quiz length here
             selectedClass = getLocalStorageSetting('selectedClass', 1); 
             maxQuestions = getLocalStorageSetting('maxQuestions', 10); 
             
             updateSettingsUI();
             updateFontCombinationUI(); // NEW: Add this call
         }
        
        // Modal open/close functions
        function openSettingsModal() { 
            updateSettingsUI(); if(settingsModal) settingsModal.classList.remove('hidden'); 
        }
        function closeSettingsModal() { if(settingsModal) settingsModal.classList.add('hidden'); }
        function openCurriculumModal() { 
             const modal = document.getElementById('curriculum-modal'); if(modal) modal.classList.remove('hidden'); 
         }
        function closeCurriculumModal() { 
             const modal = document.getElementById('curriculum-modal'); if(modal) modal.classList.add('hidden'); 
         }
         
        // --- *** MODIFIED HELPER FUNCTIONS FOR DIAGRAMS *** ---
        // (Styling updated for color, opacity, and contrast)

        /**
         * Renders a flowchart diagram into an HTML string.
         * @param {object} diagram - The diagram object from allLessonDiagrams.
         * @returns {string} HTML string for the flowchart.
         */
        function renderFlowchart(diagram) {
            const rulesHTML = diagram.rules.map(rule => {
                // Colorful, solid backgrounds for each part
                const subjectsHTML = rule.subjects ? `<div class="p-2 bg-indigo-100 dark:bg-indigo-800 rounded text-center shadow-sm"><strong class="block text-indigo-900 dark:text-indigo-100">${rule.subjects.join(', ')}</strong><span class="text-xs text-indigo-700 dark:text-indigo-200">${(rule.subjectsTelugu || []).join(', ')}</span></div>` : '';
                const helpingVerbHTML = rule.helpingVerb ? `<div class="p-2 bg-teal-100 dark:bg-teal-800 rounded text-center shadow-sm"><strong class="block text-teal-900 dark:text-teal-100">${rule.helpingVerb}</strong><span class="text-xs text-teal-700 dark:text-teal-200">${rule.helpingVerbTelugu || ''}</span></div>` : '';
                const verbFormHTML = rule.verbForm ? `<div class="p-2 bg-rose-100 dark:bg-rose-800 rounded text-center shadow-sm"><strong class="block text-rose-900 dark:text-rose-100">${rule.verbForm}</strong><span class="text-xs text-rose-700 dark:text-rose-200">${rule.verbFormTelugu || ''}</span></div>` : '';
                const objectsHTML = rule.objects ? `<div class="p-2 bg-amber-100 dark:bg-amber-800 rounded text-center shadow-sm"><strong class="block text-amber-900 dark:text-amber-100">${rule.objects.join(', ')}</strong><span class="text-xs text-amber-700 dark:text-amber-200">${(rule.objectsTelugu || []).join(', ')}</span></div>` : '';
                
                // Arrow symbol with better contrast
                const arrow = `<div class="text-2xl text-gray-600 dark:text-gray-400 flex-shrink-0 mx-2">&rarr;</div>`;
                
                return `
                    <div class="mt-3 p-3 rounded-lg bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border border-white/20 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center justify-center flex-wrap gap-2">
                            ${subjectsHTML}
                            ${subjectsHTML && (helpingVerbHTML || verbFormHTML) ? arrow : ''}
                            ${helpingVerbHTML}
                            ${helpingVerbHTML && verbFormHTML ? arrow : ''}
                            ${verbFormHTML}
                            ${verbFormHTML && objectsHTML ? arrow : ''}
                            ${objectsHTML}
                        </div>
                        ${rule.example ? `<p class="text-sm text-gray-700 dark:text-gray-300 mt-3 text-center p-2 bg-gray-100 dark:bg-gray-700/50 rounded">e.g., ${rule.example} (${rule.exampleTelugu || ''})</p>` : ''}
                    </div>
                `;
            }).join('');

            return `
                <div class="mt-4">
                    <h4 class="font-bold text-lg mb-2 text-white">${diagram.title} <span class="text-gray-300">(${diagram.titleTelugu})</span></h4>
                    <p class="text-sm text-gray-100 dark:text-gray-300 mb-2">${diagram.use} (${diagram.useTelugu})</p>
                    ${rulesHTML}
                </div>
            `;
        }


        /**
         * Renders a mindmap diagram into an HTML string.
         * @param {object} diagram - The diagram object from allLessonDiagrams.
         * @returns {string} HTML string for the mindmap.
         */
        function renderMindmap(diagram) {
            // Recursive function to render branches and sub-branches
            const renderBranches = (branches, isSubBranch = false) => {
                const listTag = isSubBranch ? 'ul' : 'ul';
                const itemTag = 'li';
                
                // NEW STYLING:
                // Top-level branches: Opaque, colorful background
                // Sub-branches: Lighter background, indented
                
                const itemClass = isSubBranch 
                    ? 'ml-4 mt-2 p-2 rounded-lg bg-white/60 dark:bg-gray-700/60 text-xs' 
                    : 'p-3 rounded-lg bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border border-white/20 dark:border-gray-700 mt-2 shadow-sm';
                
                const strongClass = isSubBranch
                    ? 'text-gray-800 dark:text-white'
                    : 'text-lg text-gray-900 dark:text-white'; // Make top-level text larger
                
                const teluguClass = isSubBranch
                    ? 'text-gray-600 dark:text-gray-300'
                    : 'text-gray-700 dark:text-gray-300';

                const exampleClass = isSubBranch
                    ? 'text-xs text-gray-500 dark:text-gray-400'
                    : 'text-sm text-gray-600 dark:text-gray-400';

                return `<${listTag} class="${isSubBranch ? 'list-disc list-inside' : 'space-y-2'}">
                    ${branches.map(branch => {
                        const subBranchesHTML = (branch.subBranches && branch.subBranches.length > 0) ? renderBranches(branch.subBranches, true) : '';
                        return `
                            <${itemTag} class="${itemClass}">
                                <strong class="${strongClass}">${branch.text}</strong>
                                ${branch.telugu ? `<span class="${teluguClass}"> (${branch.telugu})</span>` : ''}
                                ${branch.example ? `<p class="${exampleClass} mt-1">e.g., ${branch.example}</p>` : ''}
                                ${subBranchesHTML}
                            </${itemTag}>
                        `;
                    }).join('')}
                </${listTag}>`;
            };
            
            const branchesHTML = renderBranches(diagram.branches || []);

            return `
                <div class="mt-4">
                    <h4 class="font-bold text-lg mb-2 text-white">${diagram.title} <span class="text-gray-300">(${diagram.titleTelugu})</span></h4>
                    <div class="text-center p-3 rounded-lg accent-bg text-white font-bold my-3 whitespace-pre-wrap shadow-lg">${diagram.centralTopic}</div>
                    ${branchesHTML}
                </div>
            `;
        }

         
        // --- *** MODIFIED: openLessonDetailsModal *** ---
        // (Styling of text and speak buttons updated for new diagram backgrounds)
        
        /**
         * Opens the Lesson Details modal, populating it with data from
         * LESSON_DATA (data2.csv) and allLessonDiagrams (diagram_data.js).
         */
        function openLessonDetailsModal() {
            if (!isLessonDataLoaded) {
                console.error("Lesson data is not loaded yet.");
                return;
            }
            const lesson = LESSON_DATA.find(l => l.class === selectedClass);
            if (!lesson) {
                console.error(`No lesson data found for class ${selectedClass}`);
                return;
            }
            
            // Stop any speaking tips
            if (synth) synth.cancel();

            if (lessonDetailsTitle) lessonDetailsTitle.textContent = `Class ${lesson.class}: ${lesson.title}`;
            if (lessonDetailsContent) {
                
                // Function to create a clean, speakable string
                const cleanText = (text) => (text || '').replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, " ");

                // Helper to create a content block
                // MODIFIED: Using more opaque backgrounds for readability
                const createSection = (title, enText, teText) => {
                    const enClean = cleanText(enText);
                    const teClean = cleanText(teText);
                    return `
                        <h4 class="font-bold text-lg mb-2 text-white">${title}</h4>
                        <div class="p-3 rounded-lg bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border border-white/20 dark:border-gray-700 shadow-sm mb-2">
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-800 dark:text-gray-100 flex-1 pr-2">${enText || 'N/A'}</p>
                                <button onclick="speak('${enClean}', 'en-US')" class="speak-button" aria-label="Speak ${title} in English">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-3 rounded-lg bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm border border-white/20 dark:border-gray-700 shadow-sm mb-4">
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-700 dark:text-gray-200 flex-1 pr-2">${teText || 'N/A'}</p>
                                <button onclick="speak('${teClean}', 'te-IN')" class="speak-button" aria-label="Speak ${title} in Telugu">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                };

                // --- DIAGRAM LOGIC (Unchanged, uses new render functions) ---
                let diagramsHTML = '';
                try {
                    // Check if allLessonDiagrams is loaded (from diagram_data.js)
                    if (typeof allLessonDiagrams !== 'undefined' && allLessonDiagrams.length > 0) {
                        const classIdString = "Class " + String(selectedClass).padStart(2, '0');
                        const diagramInfo = allLessonDiagrams.find(d => d.classId === classIdString);

                        if (diagramInfo && diagramInfo.diagrams && diagramInfo.diagrams.length > 0) {
                            diagramsHTML = '<hr class="border-white/20 my-4">'; // Add a separator
                            diagramsHTML += diagramInfo.diagrams.map(diag => {
                                if (diag.type === 'flowchart') {
                                    return renderFlowchart(diag); // Use the new helper function
                                } else if (diag.type === 'mindmap') {
                                    return renderMindmap(diag); // Use the new helper function
                                }
                                return ''; // Handle unknown types
                            }).join('');
                        }
                    } else {
                         console.warn("diagram_data.js might not be loaded or is empty.");
                    }
                } catch (e) {
                    console.error("Error rendering diagrams:", e);
                    diagramsHTML = '<p class="text-red-400">Error loading diagrams.</p>';
                }
                // --- END DIAGRAM LOGIC ---

                // Combine existing sections with new diagrams
                // MODIFIED: Changed text color for main modal content
                lessonDetailsContent.innerHTML = `
                    <div class="text-gray-900 dark:text-gray-100"> 
                        ${createSection('Key Topics', lesson.keyTopicsEN, lesson.keyTopicsTE)}
                        ${createSection('Instructions', lesson.instructionsEN, lesson.instructionsTE)}
                        ${createSection('Uses', lesson.usesEN, lesson.usesTE)}
                    </div>
                    ${diagramsHTML}`; // Append the new HTML
            }
            
            if (lessonDetailsModal) {
                 lessonDetailsModal.classList.remove('hidden');
                 // Scroll the content to the top
                 if (lessonDetailsContent) lessonDetailsContent.scrollTop = 0;
            }
        }

        function closeLessonDetailsModal() {
            if (lessonDetailsModal) lessonDetailsModal.classList.add('hidden');
            if (synth) synth.cancel(); // Stop speech when closing modal
        }

        // NEW: Function to apply font combination
        window.applyFontCombination = function(comboName) {
            const combo = FONT_COMBINATIONS[comboName];
            if (combo) {
                setTitleFont(combo.title);
                setBodyFont(combo.body);
                // Update individual dropdowns
                updateFontButton('title');
                updateFontButton('body');
            }
            updateFontCombinationUI(); // Update button active state
        }

        // NEW: Function to update font combination buttons UI
        function updateFontCombinationUI() {
            if (typeof FONT_COMBINATIONS === 'undefined') return; // Ensure constant is defined
            
            const currentTitle = getLocalStorageSetting('titleFont', FONT_OPTIONS.title[0].value);
            const currentBody = getLocalStorageSetting('bodyFont', FONT_OPTIONS.body[0].value);

            const default1 = FONT_COMBINATIONS['default1'];
            const default2 = FONT_COMBINATIONS['default2'];

            let activeCombo = null;
            if (currentTitle === default1.title && currentBody === default1.body) {
                activeCombo = 'default1';
            } else if (currentTitle === default2.title && currentBody === default2.body) {
                activeCombo = 'default2';
            }

            document.querySelectorAll('#font-combo-btns button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.combo === activeCombo);
            });
        }
        
        // Open the generic selection modal
        window.openSelectionModal = function(type) { 
             if (type === 'class' && !isLessonDataLoaded) {
                 console.warn("Lesson data not loaded yet. Cannot open class selection.");
                 return;
             }
             if (['bodyFont', 'titleFont', 'color'].includes(type)) { closeSettingsModal(); } 
             let optionsHTML = ''; 
             const buttonClass = 'w-full text-left p-3 rounded-lg selection-button text-white'; 
             if (type === 'class') { 
                 if(modalTitle) modalTitle.textContent = 'Select a Class'; 
                 optionsHTML = CLASS_TOPICS.map((topic, i) => `<button onclick="handleSelectionChange('class', ${i+1})" class="${buttonClass} ${selectedClass === (i+1) ? 'active' : ''}">${i+1}: ${topic}</button>`).join(''); 
             } else if (type === 'count') { 
                 if(modalTitle) modalTitle.textContent = 'Select Quiz Length'; 
                 [4, 5, 10, 15, 20, 25].forEach(count => { 
                     optionsHTML += `<button onclick="handleSelectionChange('count', ${count})" class="${buttonClass} ${maxQuestions === count ? 'active' : ''}">${count} Questions</button>`; 
                 }); 
            // MODIFIED: Logic for font modals
             } else if (type === 'bodyFont' || type === 'titleFont') { 
                 if(modalTitle) modalTitle.textContent = type === 'bodyFont' ? 'Select Body Font' : 'Select Title Font'; 
                 const options = FONT_OPTIONS[type === 'bodyFont' ? 'body' : 'title']; 
                 const currentFont = getLocalStorageSetting(type === 'bodyFont' ? 'bodyFont' : 'titleFont'); // This is now 'Lexend'
                 optionsHTML = options.map(opt => {
                     // opt.value is 'Lexend', currentFont is 'Lexend'
                     // Re-construct CSS string for button preview
                     const fallback = (opt.value === 'Merriweather' || opt.value === 'Lora' || opt.value === 'Playfair Display' || opt.value === 'DM Serif Display') ? 'serif' : 'sans-serif';
                     return `<button onclick="handleSelectionChange('${type}', '${opt.value}')" class="${buttonClass} ${currentFont === opt.value ? 'active' : ''}" style="font-family: '${opt.value}', ${fallback};">${opt.label}</button>`
                 }).join('');
             } else if (type === 'color') { 
                 if(modalTitle) modalTitle.textContent = 'Select Accent Color'; 
                 const currentColor = getLocalStorageSetting('colorTheme'); 
                 optionsHTML = COLOR_THEMES.map(theme => `<button onclick="handleSelectionChange('color', '${theme.name}')" class="${buttonClass} ${currentColor === theme.name ? 'active' : ''} flex items-center justify-between"><span>${theme.name}</span><span class="w-6 h-6 rounded-full border border-white/20" style="background-color: ${theme.hex}"></span></button>`).join(''); 
             } 
             if(modalOptions) modalOptions.innerHTML = optionsHTML; 
             if(selectionModal) selectionModal.classList.remove('hidden');
         }

        // Close the generic selection modal
        function closeSelectionModal() { if(selectionModal) selectionModal.classList.add('hidden'); }
        
        // Handle changes from the selection modal
        window.handleSelectionChange = function(type, value) { 
            // App-specific settings
            if (type === 'class') { selectedClass = value; setLocalStorageSetting('selectedClass', value); updateClassSelectionButton(); updateLessonTip(selectedClass); } 
            else if (type === 'count') { maxQuestions = value; setLocalStorageSetting('maxQuestions', value); updateQuizLengthButton(); } 
            // Global settings
            else if (type === 'theme') { applyTheme(value); } // NEW: Handle theme change
            else if (type === 'bodyFont') { setBodyFont(value); updateFontButton('body'); } // MODIFIED: Value is clean name
            else if (type === 'titleFont') { setTitleFont(value); updateFontButton('title'); } // MODIFIED: Value is clean name
            else if (type === 'color') { applyAccentColor(value); } 
            else if (type === 'contrast') { applyContrast(value); } 
            // App-specific settings (toggles)
            else if (type === 'toggleAudio') { disableSound = !disableSound; setLocalStorageSetting('disableSound', disableSound); updateFeedbackCheckboxesUI(); } 
            else if (type === 'toggleHaptics') { disableVibration = !disableVibration; setLocalStorageSetting('disableVibration', disableVibration); updateFeedbackCheckboxesUI(); } 
            
            // Close modal unless it was a toggle or contrast button
            if (!type.startsWith('toggle') && type !== 'contrast' && type !== 'theme') { closeSelectionModal(); }
        }

        // MODIFIED: Get the display label for a setting
        function getLabel(type, value) { 
            // value is now a clean name like 'Lexend'
            if (type === 'class') { 
                return `Class ${value}: ${CLASS_TOPICS[value-1] || 'Unknown'}`; 
            } 
            if (type === 'count') return `${value} Questions`; 
            if (type === 'bodyFont' || type === 'titleFont') { 
                const options = FONT_OPTIONS[type === 'bodyFont' ? 'body' : 'title'];
                // Find by 'value' which is the clean name
                return (options.find(opt => opt.value === value) || {}).label || 'Default'; 
            } 
            return value;
        }
        
        // --- UI Update Functions ---
        
        // MODIFIED: Update font button UI
        function updateFontButton(type) { 
             const buttonElement = type === 'body' ? currentBodyFont : currentTitleFont; 
             const storageKey = type === 'body' ? 'bodyFont' : 'titleFont'; 
             const defaultValue = FONT_OPTIONS[type === 'body' ? 'body' : 'title'][0].value; 
             const currentFontName = getLocalStorageSetting(storageKey, defaultValue); // This is now 'Lexend'
             if (buttonElement) { 
                 buttonElement.textContent = getLabel(storageKey, currentFontName); // getLabel now works with clean names
                 // Re-construct the CSS font-family string for the button preview
                 const fallback = (currentFontName === 'Merriweather' || currentFontName === 'Lora' || currentFontName === 'Playfair Display' || currentFontName === 'DM Serif Display') ? 'serif' : 'sans-serif';
                 buttonElement.style.fontFamily = `'${currentFontName}', ${fallback}`; 
             }
         }
        function updateColorButton() { 
             const themeName = getLocalStorageSetting('colorTheme', COLOR_THEMES[0].name); 
             if (currentAccentColor) currentAccentColor.textContent = themeName; 
             if (colorPreview) { const theme = COLOR_THEMES.find(t => t.name === themeName) || COLOR_THEMES[0]; colorPreview.style.backgroundColor = theme.hex; }
         }
        function updateClassSelectionButton() { if(currentClassSelection) currentClassSelection.textContent = getLabel('class', selectedClass); }
        function updateQuizLengthButton() { if(currentQuizLength) currentQuizLength.textContent = getLabel('count', maxQuestions); }
        function updateContrastButtonsUI() { 
             if (contrastDefaultBtn && contrastHighBtn) { 
                 contrastDefaultBtn.classList.toggle('active', textContrast === 'default'); 
                 contrastHighBtn.classList.toggle('active', textContrast === 'high'); 
             }
         }
        function updateFeedbackCheckboxesUI() { 
            if (toggleAudioCheckbox) toggleAudioCheckbox.checked = disableSound; if (toggleHapticsCheckbox) toggleHapticsCheckbox.checked = disableVibration;
         }
        // Update all settings UI elements
        function updateSettingsUI() { 
             updateFontButton('body'); updateFontButton('title'); updateColorButton(); updateContrastButtonsUI(); updateFeedbackCheckboxesUI();
             updateThemeButtonsUI(); // NEW: Update theme buttons
             updateFontCombinationUI(); // NEW: Add this call
         }
        // Update the start screen UI (message, buttons)
        function updateStartScreenUI() { 
             updateStartScreenMessage(); 
             updateClassSelectionButton(); 
             updateQuizLengthButton(); 
             if(startButton) startButton.disabled = !isDataLoaded; // Only depends on question data
             updateLessonTip(selectedClass); 
         }
         function updateStartScreenMessage() { 
             if (isDataLoaded && isLessonDataLoaded) { // Check both flags
                if(startMessage) startMessage.textContent = `Ready to practice? Select your class and quiz length, then press Start!`; 
             } else { 
                if(startMessage) startMessage.innerHTML = `Loading data... Please wait.`; 
             }
         }

        // --- Window Onload (Initialization) ---
        window.onload = async () => {
            // Assign DOM Elements
            startScreen = document.getElementById('start-screen'); quizScreen = document.getElementById('quiz-screen'); resultsScreen = document.getElementById('results-screen'); questionContainer = document.getElementById('question-container'); startButton = document.getElementById('start-quiz-button'); nextButton = document.getElementById('next-question-button'); restartButton = document.getElementById('restart-quiz-button'); curriculumButton = document.getElementById('curriculum-button'); 
            lessonTipsContainer = document.getElementById('lesson-tips-container'); lessonTipTitle = document.getElementById('lesson-tip-title'); lessonTipEN = document.getElementById('lesson-tip-en'); lessonTipTE = document.getElementById('lesson-tip-te'); speakENTipButton = document.getElementById('speak-en-tip'); speakTETipButton = document.getElementById('speak-te-tip'); 
            stats = document.getElementById('stats'); scoreEl = document.getElementById('score'); progressBar = document.getElementById('progress-bar'); 
            finalScoreEl = document.getElementById('final-score');
            finalScoreTeEl = document.getElementById('final-score-te');
            speakResultEnBtn = document.getElementById('speak-result-en');
            speakResultTeBtn = document.getElementById('speak-result-te');
            resultsDetails = document.getElementById('results-details'); 
            selectionModal = document.getElementById('selection-modal'); modalTitle = document.getElementById('modal-title'); modalOptions = document.getElementById('modal-options'); 
            settingsModal = document.getElementById('settings-modal'); 
            themeToggle = document.getElementById('theme-toggle'); themeIconLight = document.getElementById('theme-icon-light'); themeIconDark = document.getElementById('theme-icon-dark'); 
            themeIconSystem = document.getElementById('theme-icon-system'); // NEW
            startMessage = document.getElementById('start-message'); 
            classSelectionButton = document.getElementById('class-selection-button'); lengthSelectionButton = document.getElementById('length-selection-button'); 
            currentClassSelection = document.getElementById('current-class-selection'); currentQuizLength = document.getElementById('current-quiz-length'); 
            closeSelectionModalBtn = document.getElementById('close-selection-modal'); closeSettingsModalBtn = document.getElementById('close-settings-modal'); closeCurriculumModalBtn = document.getElementById('close-curriculum-modal'); 
            bodyFontBtn = document.getElementById('body-font-button'); titleFontBtn = document.getElementById('title-font-button'); colorBtn = document.getElementById('color-button'); 
            currentBodyFont = document.getElementById('current-body-font'); currentTitleFont = document.getElementById('current-title-font'); currentAccentColor = document.getElementById('current-accent-color'); 
            contrastDefaultBtn = document.getElementById('contrast-default'); contrastHighBtn = document.getElementById('contrast-high'); 
            toggleAudioCheckbox = document.getElementById('toggle-audio'); toggleHapticsCheckbox = document.getElementById('toggle-haptics'); 
            colorPreview = document.getElementById('color-preview');
            themeLightBtn = document.getElementById('theme-light'); // NEW
            themeDarkBtn = document.getElementById('theme-dark'); // NEW
            themeSystemBtn = document.getElementById('theme-system'); // NEW
            // AI Elements
            aiFeedbackSection = document.getElementById('ai-feedback-section'); aiLoadingIndicator = document.getElementById('ai-loading-indicator'); aiContent = document.getElementById('ai-content'); aiError = document.getElementById('ai-error'); feedbackEnEl = document.getElementById('feedback-en'); feedbackTeEl = document.getElementById('feedback-te'); coachingEnEl = document.getElementById('coaching-en'); coachingTeEl = document.getElementById('coaching-te'); tipsEnEl = document.getElementById('tips-en'); tipsTeEl = document.getElementById('tips-te');
            // Offline Message Element
            aiOfflineMessage = document.getElementById('ai-offline-message');
            // Lesson Details Modal Elements
            lessonDetailsModal = document.getElementById('lesson-details-modal');
            closeLessonDetailsModalBtn = document.getElementById('close-lesson-details-modal');
            lessonDetailsTitle = document.getElementById('lesson-details-title');
            lessonDetailsContent = document.getElementById('lesson-details-content');
            // ***** NEW: Assign Next Class Button *****
            nextClassButton = document.getElementById('next-class-button');
            
            // Add Event Listeners
            if(startButton) startButton.addEventListener('click', startQuiz); 
            if(nextButton) nextButton.addEventListener('click', handleNextQuestion); 
            if(restartButton) restartButton.addEventListener('click', () => { 
                if(resultsScreen) resultsScreen.classList.add('hidden'); 
                if(startScreen) startScreen.classList.remove('hidden'); 
                // Reset AI feedback section
                if(aiFeedbackSection) aiFeedbackSection.classList.add('hidden'); // Hide entire AI section
                if(aiLoadingIndicator) aiLoadingIndicator.classList.add('hidden'); 
                if(aiOfflineMessage) aiOfflineMessage.classList.add('hidden');    
                if(aiContent) aiContent.classList.add('hidden');
                if(aiError) aiError.classList.add('hidden');
                updateLessonTip(selectedClass); 
            }); 
            
            // NEW: Updated themeToggle listener
            if(themeToggle) themeToggle.addEventListener('click', () => {
                const currentTheme = getLocalStorageSetting('theme', 'system');
                let newTheme;
                if (currentTheme === 'light') {
                    newTheme = 'dark';
                } else if (currentTheme === 'dark') {
                    newTheme = 'system';
                } else { // system
                    newTheme = 'light';
                }
                applyTheme(newTheme);
            }); 

            const settingsBtn = document.getElementById('settings-button'); if(settingsBtn) settingsBtn.addEventListener('click', openSettingsModal); 
            if(curriculumButton) curriculumButton.addEventListener('click', openCurriculumModal); 
            if(classSelectionButton) classSelectionButton.addEventListener('click', () => openSelectionModal('class')); 
            if(lengthSelectionButton) lengthSelectionButton.addEventListener('click', () => openSelectionModal('count')); 
            if(closeSelectionModalBtn) closeSelectionModalBtn.addEventListener('click', closeSelectionModal); 
            if(closeSettingsModalBtn) closeSettingsModalBtn.addEventListener('click', closeSettingsModal); 
            if(closeCurriculumModalBtn) closeCurriculumModalBtn.addEventListener('click', closeCurriculumModal); 
            if(bodyFontBtn) bodyFontBtn.addEventListener('click', () => openSelectionModal('bodyFont')); 
            if(titleFontBtn) titleFontBtn.addEventListener('click', () => openSelectionModal('titleFont')); 
            if(colorBtn) colorBtn.addEventListener('click', () => openSelectionModal('color')); 
            
            // Lesson Details Modal Listeners
            if(lessonTipsContainer) lessonTipsContainer.addEventListener('click', openLessonDetailsModal);
            if(closeLessonDetailsModalBtn) closeLessonDetailsModalBtn.addEventListener('click', closeLessonDetailsModal);

            // ***** NEW: Next Class Button Listener *****
            if (nextClassButton) {
                nextClassButton.addEventListener('click', () => {
                    if (selectedClass < LESSON_DATA.length) {
                        selectedClass++; // Move to the next class
                        setLocalStorageSetting('selectedClass', selectedClass); // Save it
                        
                        // Go back to start screen
                        if(resultsScreen) resultsScreen.classList.add('hidden');
                        if(startScreen) startScreen.classList.remove('hidden');
                        
                        // Reset AI feedback section
                        if(aiFeedbackSection) aiFeedbackSection.classList.add('hidden');
                        if(aiLoadingIndicator) aiLoadingIndicator.classList.add('hidden');
                        if(aiOfflineMessage) aiOfflineMessage.classList.add('hidden');
                        if(aiContent) aiContent.classList.add('hidden');
                        if(aiError) aiError.classList.add('hidden');
                        
                        // Update UI for the *new* class
                        updateClassSelectionButton(); 
                        updateLessonTip(selectedClass); 
                    }
                });
            }

            // Run Setup
            setupAudio();
            loadInitialSettings(); // This now loads selectedClass and maxQuestions
            
            // NEW LOADING LOGIC
            // Show loading message
            if(startMessage) startMessage.innerHTML = `Loading data... Please wait.`;

            // Load both files concurrently
            await Promise.all([
                loadQuestions(),
                loadLessonData()
            ]);

            // Check if everything loaded correctly
            if (isDataLoaded && isLessonDataLoaded) {
                updateStartScreenUI(); // This will update buttons and call updateLessonTip
                if(startMessage) startMessage.textContent = `Ready to practice? Select your class and quiz length, then press Start!`;
                if(startButton) startButton.disabled = false;
            } else {
                // Determine the error message
                let errorMsg = "Error: Could not load data.";
                if (!isDataLoaded && !isLessonDataLoaded) {
                    errorMsg = "Error: Could not load quiz questions or lesson data.";
                } else if (!isDataLoaded) {
                    errorMsg = "Error: Could not load quiz questions (data.csv).";
                } else if (!isLessonDataLoaded) {
                    errorMsg = "Error: Could not load lesson info (data2.csv).";
                }
                if(startMessage) startMessage.innerHTML = `<strong class="text-red-400">${errorMsg}</strong><br><small>Please check your internet connection or try again later.</small>`;
                if(startButton) startButton.disabled = true;
            }
        };
    </script>
</body>
</html>



