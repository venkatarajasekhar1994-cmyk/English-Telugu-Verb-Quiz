<meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoken English Course Quiz</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('Service Worker registered: ', registration))
                    .catch(error => console.error('Service Worker registration failed: ', error));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added PapaParse for robust CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Added diagram_data.js, defer ensures it loads after HTML but before DOMContentLoaded -->
    <script src="diagram_data.js" defer></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:wght@700&family=Roboto:wght@400;700&family=Merriweather:wght@400;700&family=Noto+Sans:wght@400;700&family=Noto+Sans+Telugu:wght@400;700&display=swap');
        
        /* Basic theme variables */
        :root {
            --font-body: 'Inter', sans-serif;
            --font-title: 'Lora', serif;
            
            --color-bg: #F3F4F6; /* light-gray-100 */
            --color-card: #FFFFFF;
            --color-text: #1F2937; /* light-gray-800 */
            --color-text-dim: #4B5563; /* light-gray-600 */
            --color-primary: #3B82F6; /* light-blue-500 */
            --color-primary-hover: #2563EB;
            --color-primary-text: #FFFFFF;
            --color-border: #E5E7EB; /* light-gray-200 */
            --color-correct: #10B981; /* light-green-500 */
            --color-incorrect: #EF4444; /* light-red-500 */
            --color-modal-overlay: rgba(0, 0, 0, 0.5);
            --color-modal-bg: #FFFFFF;
        }

        /* Dark theme variables */
        .dark {
            --color-bg: #111827; /* dark-gray-900 */
            --color-card: #1F2937; /* dark-gray-800 */
            --color-text: #F3F4F6; /* dark-gray-100 */
            --color-text-dim: #9CA3AF; /* dark-gray-400 */
            --color-primary: #60A5FA; /* dark-blue-400 */
            --color-primary-hover: #3B82F6;
            --color-primary-text: #1F2937;
            --color-border: #374151; /* dark-gray-700 */
            --color-correct: #34D399; /* dark-green-400 */
            --color-incorrect: #F87171; /* dark-red-400 */
            --color-modal-overlay: rgba(0, 0, 0, 0.7);
            --color-modal-bg: #1F2937;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-body);
            transition: background-color 0.3s, color 0.3s;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-title);
        }

        /* Base styles for modals */
        .modal {
            background-color: var(--color-modal-overlay);
        }
        .modal-content {
            background-color: var(--color-modal-bg);
            color: var(--color-text);
        }

        /* Other element styles */
        .card, .modal-content, .selection-item {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
        }
        
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
        }
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
        
        .btn-secondary {
             background-color: var(--color-card);
             color: var(--color-text);
             border: 1px solid var(--color-border);
        }
        .btn-secondary:hover {
            background-color: var(--color-bg);
        }
        
        /* Custom styles for diagram nodes */
        .diagram-node {
            background-color: var(--color-card);
            border: 2px solid var(--color-primary);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            /* ADDED: Ensures Telugu characters render beautifully */
            font-family: var(--font-body), 'Noto Sans Telugu', sans-serif;
        }
        .diagram-column-title {
            font-family: var(--font-title), 'Noto Sans Telugu', sans-serif;
            font-weight: 700;
            color: var(--color-primary);
            text-align: center;
            margin-bottom: 1rem;
        }
        .diagram-svg-line {
            stroke: var(--color-text-dim);
            stroke-width: 2px;
            fill: none;
        }

        .option.correct {
            background-color: var(--color-correct) !important;
            color: var(--color-primary-text) !important;
            border-color: var(--color-correct) !important;
        }
        .option.incorrect {
            background-color: var(--color-incorrect) !important;
            color: var(--color-primary-text) !important;
            border-color: var(--color-incorrect) !important;
        }
        
        /* Ensure selection items have text color */
        .selection-item {
            color: var(--color-text);
        }
        
        .selection-item.selected {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
            border-color: var(--color-primary);
        }

        /* Basic loading spinner */
        .loader {
            border: 4px solid var(--color-border);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Icon styles */
        .icon-btn {
            color: var(--color-text-dim);
        }
        .icon-btn:hover {
            color: var(--color-text);
        }

    </style>
</head>
<body class="min-h-screen">

    <!-- Main App Container -->
    <div id="app-container" class="max-w-2xl mx-auto p-4">

        <!-- Header -->
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold" style="font-family: var(--font-title);">Spoken English</h1>
            <div class="flex items-center space-x-2">
                <button id="curriculum-button" title="View Curriculum" class="icon-btn p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </button>
                <button id="settings-button" title="Settings" class="icon-btn p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <button id="theme-toggle" title="Toggle Theme" class="icon-btn p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loading-spinner" class="flex justify-center items-center h-64">
            <div class="loader"></div>
        </div>

        <!-- Quiz Setup Screen -->
        <div id="quiz-setup" class="hidden flex flex-col gap-4 p-4">
            <!-- Setup Controls -->
            <div class="card rounded-lg p-4 flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Class</label>
                    <button id="class-selection-button" class="btn-secondary w-full text-left p-2 rounded-md shadow-sm">
                        Class 1: Pronouns
                    </button>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Length</label>
                    <button id="length-selection-button" class="btn-secondary w-full text-left p-2 rounded-md shadow-sm">
                        10 Questions
                    </button>
                </div>
            </div>

            <!-- NEW: Lesson Info Card -->
            <div id="lessonInfoCard" class="card rounded-lg p-4 hidden">
                <h3 id="lessonInfoTitle" class="text-xl font-bold mb-3" style="font-family: var(--font-title);">Lesson Info</h3>
                
                <div id="lessonInfoContent" class="space-y-3">
                    <!-- Content will be injected by JS -->
                </div>
                
                <button id="viewDiagramBtn" class="btn-secondary w-full text-center p-2 rounded-md shadow-sm mt-4 hidden">
                    View Lesson Diagram
                </button>
            </div>
            
            <button id="start-button" class="btn-primary w-full p-3 rounded-lg text-lg font-bold shadow-lg">
                Start Quiz
            </button>
        </div>

        <!-- Quiz Container -->
        <div id="quiz-container" class="hidden">
            <!-- Quiz Header -->
            <div class="flex justify-between items-center mb-2">
                <span id="question-counter" class="text-sm font-medium text-gray-500 dark:text-gray-400">Question 1/10</span>
                <button id="end-quiz-button" class="text-sm font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">End Quiz</button>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 dark:bg-blue-400 h-2.5 rounded-full" style="width: 10%; transition: width 0.3s;"></div>
            </div>
            
            <!-- Question Card -->
            <div id="question-card" class="card rounded-lg p-5 shadow-md">
                <p id="prompt-te" class="text-lg mb-2" style="font-family: 'Noto Sans Telugu', sans-serif;">...</p>
                
                <div class="flex items-center space-x-2">
                    <p id="prompt-en" class="text-xl font-semibold mb-4">...</p>
                    <button id="speak-prompt-btn" title="Speak Prompt" class="icon-btn text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                
                <div id="options-container" class="space-y-3">
                    <!-- Options will be injected here -->
                </div>
            </div>
            
            <!-- Feedback Card (for Fill-in-the-blanks) -->
            <div id="fib-card" class="hidden card rounded-lg p-5 shadow-md mt-4">
                <input type="text" id="fib-input" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="Type your answer...">
                <button id="fib-submit" class="btn-primary w-full p-2 rounded-lg mt-3">Check</button>
            </div>
            
            <!-- Tip Card -->
            <div id="tip-card" class="card rounded-lg p-4 mt-4 hidden">
                 <h4 class="font-bold text-lg mb-2">Tip / Trick</h4>
                 <div class="flex items-start space-x-2">
                    <p id="tip-text" class="text-sm flex-1">...</p>
                    <button id="speak-tip-btn" title="Speak Tip" class="icon-btn text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white pt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>

            <!-- Feedback Card -->
            <div id="feedback-card" class="card rounded-lg p-5 mt-4 hidden">
                <h3 id="feedback-title" class="text-xl font-bold mb-2"></h3>
                <p id="feedback-text-te" class="mb-2" style="font-family: 'Noto Sans Telugu', sans-serif;">...</p>
                <p id="feedback-text-en" class="mb-4">...</p>
                <button id="next-button" class="btn-primary w-full p-3 rounded-lg text-lg font-bold">Next</button>
            </div>
        </div>

        <!-- Quiz Results Screen -->
        <div id="results-screen" class="hidden card rounded-lg p-6 shadow-lg text-center">
            <h2 class="text-3xl font-bold mb-4">Quiz Complete!</h2>
            <p class="text-5xl font-bold mb-2"><span id="score-percent">0</span>%</p>
            <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">You got <span id="score-correct">0</span> out of <span id="score-total">0</span> correct.</p>
            <div class="space-y-4">
                <button id="restart-quiz-button" class="btn-primary w-full p-3 rounded-lg text-lg font-bold">Restart Quiz</button>
                <button id="back-to-setup-button" class="btn-secondary w-full p-3 rounded-lg text-lg font-bold">Change Settings</button>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Selection Modal -->
    <div id="selectionModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-content w-full max-w-md rounded-lg shadow-xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 id="selectionModalTitle" class="text-xl font-bold">Select</h3>
                <button id="closeSelectionModalBtn" class="icon-btn p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="selectionModalContent" class="p-4 max-h-96 overflow-y-auto">
                <!-- Selection items will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-content w-full max-w-md rounded-lg shadow-xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold">Settings</h3>
                <button id="closeSettingsModalBtn" class="icon-btn p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <button id="bodyFontBtn" class="btn-secondary w-full p-2 rounded-md">Body Font: <span id="bodyFontName">Inter</span></button>
                <button id="titleFontBtn" class="btn-secondary w-full p-2 rounded-md">Title Font: <span id="titleFontName">Lora</span></button>
                <button id="colorBtn" class="btn-secondary w-full p-2 rounded-md">Theme Color: <span id="colorName">Blue</span></button>
            </div>
        </div>
    </div>
    
    <!-- Curriculum Modal -->
    <div id="curriculumModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-content w-full max-w-md rounded-lg shadow-xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold">Curriculum</h3>
                <button id="closeCurriculumModalBtn" class="icon-btn p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="curriculumList" class="p-4 max-h-96 overflow-y-auto">
                <!-- Curriculum items will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- NEW: Diagram Modal -->
    <div id="diagramModal" class="modal fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-content w-full max-w-4xl rounded-lg shadow-xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 id="diagramModalTitle" class="text-xl font-bold">Lesson Diagram</h3>
                <button id="closeDiagramModalBtn" class="icon-btn p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="diagramModalTabs" class="p-2 border-b border-gray-200 dark:border-gray-700 flex space-x-2 hidden">
                <!-- Tabs for multi-diagram lessons will be injected here -->
            </div>
            <div id="diagramModalContent" class="p-6 max-h-[70vh] overflow-auto">
                <!-- Diagram will be rendered here -->
            </div>
        </div>
    </div>


    <!-- Main App Logic -->
    <script>
        // --- DOM Elements ---
        let appContainer, loadingSpinner, quizSetup, startButton, quizContainer, questionCounter, progressBar, questionCard, promptEn, promptTe, speakPromptBtn, optionsContainer, fibCard, fibInput, fibSubmit, feedbackCard, feedbackTitle, feedbackTextEn, feedbackTextTe, nextButton, resultsScreen, scorePercent, scoreCorrect, scoreTotal, restartQuizButton, backToSetupButton, endQuizButton, themeToggle, themeIconLight, themeIconDark, classSelectionButton, lengthSelectionButton, selectionModal, selectionModalTitle, selectionModalContent, closeSelectionModalBtn, settingsModal, closeSettingsModalBtn, curriculumModal, closeCurriculumModalBtn, curriculumList, bodyFontBtn, titleFontBtn, colorBtn, tipCard, tipText, speakTipBtn, lessonInfoCard, lessonInfoTitle, lessonInfoContent, viewDiagramBtn, diagramModal, diagramModalTitle, diagramModalTabs, diagramModalContent, closeDiagramModalBtn, bodyFontName, titleFontName, colorName;

        // --- State ---
        let allQuestions = [];
        let allLessonDetails = []; // NEW: To store data2.csv
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentClass = 1;
        let quizLength = 10;
        let isDark = false;
        let currentSelectionType = '';
        let synth = window.speechSynthesis;
        let lessonTips = {}; // To store tips from data2.csv
        let currentDiagrams = []; // To hold data for multi-diagram modal
 
        // --- Settings Data ---
        const fonts = {
            bodyFont: [
                { name: 'Inter', value: "'Inter', sans-serif" },
                { name: 'Roboto', value: "'Roboto', sans-serif" },
                { name: 'Noto Sans', value: "'Noto Sans', sans-serif" },
                { name: 'Merriweather', value: "'Merriweather', serif" },
            ],
            titleFont: [
                { name: 'Lora', value: "'Lora', serif" },
                { name: 'Merriweather', value: "'Merriweather', serif" },
                { name: 'Roboto', value: "'Roboto', sans-serif" },
                { name: 'Noto Sans', value: "'Noto Sans', sans-serif" },
            ]
        };
        
        const colors = [
            { name: 'Blue', value: '#3B82F6', hover: '#2563EB', dark: '#60A5FA', darkHover: '#3B82F6' },
            { name: 'Green', value: '#10B981', hover: '#059669', dark: '#34D399', darkHover: '#10B981' },
            { name: 'Red', value: '#EF4444', hover: '#DC2626', dark: '#F87171', darkHover: '#EF4444' },
            { name: 'Purple', value: '#8B5CF6', hover: '#7C3AED', dark: '#A78BFA', darkHover: '#8B5CF6' },
        ];
        
        const quizLengths = [10, 20, 30, 'All'];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            bindDOMElements();
            addGlobalListeners();
            initApp();
        });

        function bindDOMElements() {
            appContainer = document.getElementById('app-container');
            loadingSpinner = document.getElementById('loading-spinner');
            quizSetup = document.getElementById('quiz-setup');
            startButton = document.getElementById('start-button');
            quizContainer = document.getElementById('quiz-container');
            questionCounter = document.getElementById('question-counter');
            progressBar = document.getElementById('progress-bar');
            questionCard = document.getElementById('question-card');
            promptEn = document.getElementById('prompt-en');
            promptTe = document.getElementById('prompt-te');
            speakPromptBtn = document.getElementById('speak-prompt-btn');
            optionsContainer = document.getElementById('options-container');
            fibCard = document.getElementById('fib-card');
            fibInput = document.getElementById('fib-input');
            fibSubmit = document.getElementById('fib-submit');
            feedbackCard = document.getElementById('feedback-card');
            feedbackTitle = document.getElementById('feedback-title');
            feedbackTextEn = document.getElementById('feedback-text-en');
            feedbackTextTe = document.getElementById('feedback-text-te');
            nextButton = document.getElementById('next-button');
            resultsScreen = document.getElementById('results-screen');
            scorePercent = document.getElementById('score-percent');
            scoreCorrect = document.getElementById('score-correct');
            scoreTotal = document.getElementById('score-total');
            restartQuizButton = document.getElementById('restart-quiz-button');
            backToSetupButton = document.getElementById('back-to-setup-button');
            endQuizButton = document.getElementById('end-quiz-button');
            themeToggle = document.getElementById('theme-toggle');
            themeIconLight = document.getElementById('theme-icon-light');
            themeIconDark = document.getElementById('theme-icon-dark');
            classSelectionButton = document.getElementById('class-selection-button');
            lengthSelectionButton = document.getElementById('length-selection-button');
            selectionModal = document.getElementById('selectionModal');
            selectionModalTitle = document.getElementById('selectionModalTitle');
            selectionModalContent = document.getElementById('selectionModalContent');
            closeSelectionModalBtn = document.getElementById('closeSelectionModalBtn');
            settingsModal = document.getElementById('settingsModal');
            closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
            curriculumModal = document.getElementById('curriculumModal');
            closeCurriculumModalBtn = document.getElementById('closeCurriculumModalBtn');
            curriculumList = document.getElementById('curriculumList');
            bodyFontBtn = document.getElementById('bodyFontBtn');
            titleFontBtn = document.getElementById('titleFontBtn');
            colorBtn = document.getElementById('colorBtn');
            tipCard = document.getElementById('tip-card');
            tipText = document.getElementById('tip-text');
            speakTipBtn = document.getElementById('speak-tip-btn');
            bodyFontName = document.getElementById('bodyFontName');
            titleFontName = document.getElementById('titleFontName');
            colorName = document.getElementById('colorName');
            
            // NEW elements
            lessonInfoCard = document.getElementById('lessonInfoCard');
            lessonInfoTitle = document.getElementById('lessonInfoTitle');
            lessonInfoContent = document.getElementById('lessonInfoContent');
            viewDiagramBtn = document.getElementById('viewDiagramBtn');
            diagramModal = document.getElementById('diagramModal');
            diagramModalTitle = document.getElementById('diagramModalTitle');
            diagramModalTabs = document.getElementById('diagramModalTabs');
            diagramModalContent = document.getElementById('diagramModalContent');
            closeDiagramModalBtn = document.getElementById('closeDiagramModalBtn');
        }

        async function initApp() {
            console.log("Initializing App...");
            loadInitialSettings();
            setupAudio();
            
            try {
                // Fetch both CSV files in parallel
                const [questionsData, lessonsData] = await Promise.all([
                    fetchCsv('data.csv'),
                    fetchCsv('data2.csv')
                ]);

                // Process Questions (data.csv)
                allQuestions = questionsData;
                console.log(`Loaded ${allQuestions.length} questions.`);

                // Process Lesson Details (data2.csv)
                allLessonDetails = lessonsData;
                console.log(`Loaded ${allLessonDetails.length} lesson details.`);
                
                // Populate lesson tips and curriculum modal
                const curriculumItems = [];
                allLessonDetails.forEach(lesson => {
                    if (lesson.Class_Number) {
                        const classNum = parseInt(lesson.Class_Number);
                        // Store tips
                        if (lesson.Tips_Tricks_EN || lesson.Tips_Tricks_TE) {
                            lessonTips[classNum] = {
                                en: lesson.Tips_Tricks_EN,
                                te: lesson.Tips_Tricks_TE
                            };
                        }
                        // Add to curriculum list
                        curriculumItems.push(
                            `<div class="selection-item p-3 rounded-md cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700" data-value="${classNum}">
                                Class ${classNum}: ${lesson.Class_Title_EN}
                            </div>`
                        );
                    }
                });
                curriculumList.innerHTML = curriculumItems.join('');
                // Add click listeners to curriculum items
                curriculumList.querySelectorAll('.selection-item').forEach(item => {
                    item.addEventListener('click', () => {
                        updateClass(parseInt(item.dataset.value));
                        closeCurriculumModal();
                    });
                });

                // Now that data is loaded, set up the UI
                setupQuizUI();
                
                // Hide spinner and show setup screen
                loadingSpinner.classList.add('hidden');
                quizSetup.classList.remove('hidden');
                quizSetup.classList.add('flex');

            } catch (error) {
                console.error("Error loading data:", error);
                // UPDATED: More helpful error message
                loadingSpinner.innerHTML = `
                <div class="text-red-500 dark:text-red-400 text-center p-4 rounded-lg bg-red-100 dark:bg-red-900 border border-red-300 dark:border-red-700">
                    <p class="font-bold text-lg">Error Loading Data</p>
                    <p class="mt-1">Could not load <strong>data.csv</strong> or <strong>data2.csv</strong>.</p>
                    <p class="mt-2 text-sm">Please make sure all files (<code>.html</code>, <code>.csv</code>, <code>.js</code>) are in the same folder, then refresh the page.</p>
                </div>`;
            }
        }
        
        // NEW: Fetch and parse CSV using PapaParse
        function fetchCsv(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        resolve(results.data);
                    },
                    error: (error) => {
                        reject(error);
                    }
                });
            });
        }
        
        // DEPRECATED: Old loadQuestions, replaced by fetchCsv
        /*
        async function loadQuestions() {
            // ... old logic ...
        }
        */

        // --- UI Setup ---
        
        function setupQuizUI() {
            // Update class button text
            const classDetail = allLessonDetails.find(l => parseInt(l.Class_Number) === currentClass);
            if (classDetail) {
                classSelectionButton.textContent = `Class ${currentClass}: ${classDetail.Class_Title_EN}`;
            } else {
                classSelectionButton.textContent = `Class ${currentClass}`;
            }
            
            // Update length button text
            lengthSelectionButton.textContent = (quizLength === 'All') ? 'All Questions' : `${quizLength} Questions`;
            
            // NEW: Update Lesson Info Card
            updateLessonInfoCard(currentClass);
        }
        
        // NEW: Function to update the lesson info card
        function updateLessonInfoCard(classNum) {
            const lesson = allLessonDetails.find(l => parseInt(l.Class_Number) === classNum);
            
            if (!lesson) {
                lessonInfoCard.classList.add('hidden');
                return;
            }
            
            lessonInfoTitle.textContent = `Lesson ${lesson.Class_Number}: ${lesson.Class_Title_EN}`;
            
            const contentHTML = `
                <div class="mb-2">
                    <h4 class="font-semibold text-sm text-gray-600 dark:text-gray-400">Key Topics (EN)</h4>
                    <div class="flex items-start space-x-2">
                        <p class="flex-1">${lesson.Key_Topics_EN || 'N/A'}</p>
                        <button class="icon-btn speak-info-btn pt-1" data-lang="en-US" data-text="${escape(lesson.Key_Topics_EN || '')}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-sm text-gray-600 dark:text-gray-400" style="font-family: 'Noto Sans Telugu', sans-serif;">‡∞Æ‡±Å‡∞ñ‡±ç‡∞Ø ‡∞Ö‡∞Ç‡∞∂‡∞æ‡∞≤‡±Å (TE)</h4>
                    <div class="flex items-start space-x-2">
                        <p class="flex-1" style="font-family: 'Noto Sans Telugu', sans-serif;">${lesson.Key_Topics_TE || 'N/A'}</p>
                        <button class="icon-btn speak-info-btn pt-1" data-lang="te-IN" data-text="${escape(lesson.Key_Topics_TE || '')}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            `;
            lessonInfoContent.innerHTML = contentHTML;
            
            // Add listeners for new speak buttons
            lessonInfoContent.querySelectorAll('.speak-info-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const target = e.currentTarget;
                    const text = unescape(target.dataset.text);
                    const lang = target.dataset.lang;
                    if (text && text !== 'N/A') {
                        speak(text, lang);
                    }
                });
            });

            // Check for diagram
            if (window.DIAGRAM_DATA && window.DIAGRAM_DATA[classNum]) {
                viewDiagramBtn.classList.remove('hidden');
            } else {
                viewDiagramBtn.classList.add('hidden');
            }
            
            lessonInfoCard.classList.remove('hidden');
        }

        // --- Quiz Logic ---

        function startQuiz() {
            // Filter questions for the current class
            const classQuestions = allQuestions.filter(q => parseInt(q.lesson) === currentClass);
            
            // Shuffle and slice
            if (quizLength === 'All' || classQuestions.length <= quizLength) {
                currentQuizQuestions = shuffleArray(classQuestions);
            } else {
                currentQuizQuestions = shuffleArray(classQuestions).slice(0, quizLength);
            }
            
            if (currentQuizQuestions.length === 0) {
                alert(`No questions found for Class ${currentClass}.`);
                return;
            }

            currentQuestionIndex = 0;
            score = 0;
            
            quizSetup.classList.remove('flex');
            quizSetup.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            
            showQuestion();
        }

        function showQuestion() {
            // Hide feedback
            feedbackCard.classList.add('hidden');
            tipCard.classList.add('hidden');
            
            // Get current question
            const q = currentQuizQuestions[currentQuestionIndex];
            
            // Update UI
            questionCounter.textContent = `Question ${currentQuestionIndex + 1}/${currentQuizQuestions.length}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / currentQuizQuestions.length) * 100}%`;
            
            promptEn.textContent = q.promptEN;
            promptTe.textContent = q.promptTE;
            
            // Reset question-specific UI
            optionsContainer.innerHTML = '';
            fibCard.classList.add('hidden');
            questionCard.classList.remove('hidden');
            
            if (q.type === 'mcq') {
                const options = shuffleArray([
                    { text: q.A, value: 'A' },
                    { text: q.B, value: 'B' },
                    { text: q.C, value: 'C' },
                    { text: q.D, value: 'D' }
                ]);
                
                options.forEach(opt => {
                    const button = document.createElement('button');
                    button.textContent = opt.text;
                    button.classList.add('option', 'btn-secondary', 'w-full', 'p-3', 'rounded-lg', 'text-left', 'transition-colors', 'duration-150');
                    button.dataset.value = opt.value;
                    button.addEventListener('click', () => handleAnswer(opt.value));
                    optionsContainer.appendChild(button);
                });
                
            } else if (q.type === 'fib') {
                questionCard.classList.add('hidden'); // Hide MCQ card
                fibCard.classList.remove('hidden');
                fibInput.value = '';
                fibInput.focus();
            }
            
            // Update lesson tip
            updateLessonTip(currentClass);
        }

        function handleAnswer(selectedAnswer) {
            const q = currentQuizQuestions[currentQuestionIndex];
            const isCorrect = (selectedAnswer.trim().toLowerCase() === q.correct.trim().toLowerCase());
            
            // Disable options / input
            if (q.type === 'mcq') {
                optionsContainer.querySelectorAll('.option').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.value === q.correct) {
                        btn.classList.add('correct');
                    } else if (btn.dataset.value === selectedAnswer) {
                        btn.classList.add('incorrect');
                    }
                });
            } else if (q.type === 'fib') {
                fibInput.disabled = true;
                fibSubmit.disabled = true;
            }

            // Update score
            if (isCorrect) {
                score++;
                feedbackTitle.textContent = "Correct! üéâ";
                feedbackTitle.style.color = 'var(--color-correct)';
                playTone('C4');
            } else {
                feedbackTitle.textContent = "Incorrect üòï";
                feedbackTitle.style.color = 'var(--color-incorrect)';
                playTone('C3');
                
                // For FIB, show the correct answer
                if (q.type === 'fib') {
                    q.feedbackEN = `Correct Answer: ${q[q.correct] || q.correct}. ${q.feedbackEN}`;
                    q.feedbackTE = `‡∞∏‡∞∞‡±à‡∞® ‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞Ç: ${q[q.correct] || q.correct}. ${q.feedbackTE}`;
                }
            }
            
            // Show feedback
            feedbackTextEn.textContent = q.feedbackEN;
            feedbackTextTe.textContent = q.feedbackTE;
            feedbackCard.classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizQuestions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }
        
        function updateLessonTip(classNum) {
            if (lessonTips[classNum] && Math.random() < 0.3) { // 30% chance to show a tip
                const tip = lessonTips[classNum];
                const tipToShow = (tip.en || tip.te);
                tipText.textContent = `${tip.en || ''} \n\n ${tip.te || ''}`;
                
                // Add speak listener for the tip
                speakTipBtn.onclick = () => {
                    if (tip.en) speak(tip.en, 'en-US');
                    if (tip.te) speak(tip.te, 'te-IN');
                };
                
                tipCard.classList.remove('hidden');
            } else {
                tipCard.classList.add('hidden');
            }
        }

        function showResults() {
            quizContainer.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            
            const percent = Math.round((score / currentQuizQuestions.length) * 100);
            scorePercent.textContent = percent;
            scoreCorrect.textContent = score;
            scoreTotal.textContent = currentQuizQuestions.length;
        }

        function endQuiz() {
            if (confirm('Are you sure you want to end the quiz?')) {
                showResults();
            }
        }

        function restartQuiz() {
            startQuiz(); // Re-uses the same settings
        }

        function backToSetup() {
            resultsScreen.classList.add('hidden');
            quizSetup.classList.remove('hidden');
            quizSetup.classList.add('flex');
            setupQuizUI(); // Refresh setup UI
        }

        // --- Helpers ---
        function shuffleArray(array) {
            let currentIndex = array.length,  randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function playTone(note) {
            try {
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease(note, "8n");
            } catch (e) {
                console.warn("Tone.js sound failed to play:", e);
            }
        }

        // --- Event Listeners ---
        function addGlobalListeners() {
            startButton.addEventListener('click', startQuiz);
            nextButton.addEventListener('click', nextQuestion);
            endQuizButton.addEventListener('click', endQuiz);
            restartQuizButton.addEventListener('click', restartQuiz);
            backToSetupButton.addEventListener('click', backToSetup);
            fibSubmit.addEventListener('click', () => handleAnswer(fibInput.value));
            fibInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleAnswer(fibInput.value);
            });
            speakPromptBtn.addEventListener('click', () => {
                const q = currentQuizQuestions[currentQuestionIndex];
                speak(q.promptEN, 'en-US');
                speak(q.promptTE, 'te-IN');
            });
            
            themeToggle.addEventListener('click', () => {
                applyTheme(!isDark);
            });
            
            settingsBtn.addEventListener('click', openSettingsModal);
            curriculumButton.addEventListener('click', openCurriculumModal);
            
            classSelectionButton.addEventListener('click', () => openSelectionModal('class'));
            lengthSelectionButton.addEventListener('click', () => openSelectionModal('count'));
            
            closeSelectionModalBtn.addEventListener('click', closeSelectionModal);
            closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
            closeCurriculumModalBtn.addEventListener('click', closeCurriculumModal);
            
            bodyFontBtn.addEventListener('click', () => openSelectionModal('bodyFont'));
            titleFontBtn.addEventListener('click', () => openSelectionModal('titleFont'));
            colorBtn.addEventListener('click', () => openSelectionModal('color'));

            // NEW Listeners
            viewDiagramBtn.addEventListener('click', openDiagramModal);
            closeDiagramModalBtn.addEventListener('click', closeDiagramModal);
        }

        // --- Settings & Modals ---

        function openSelectionModal(type) {
            currentSelectionType = type;
            let title = '';
            let itemsHTML = '';
            
            if (type === 'class') {
                title = 'Select Class';
                itemsHTML = allLessonDetails.map(lesson => {
                    const classNum = parseInt(lesson.Class_Number);
                    const isSelected = classNum === currentClass ? 'selected' : '';
                    return `<div class="selection-item p-3 rounded-md cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${isSelected}" data-value="${classNum}">
                                Class ${classNum}: ${lesson.Class_Title_EN}
                            </div>`;
                }).join('');
                
            } else if (type === 'count') {
                title = 'Select Quiz Length';
                itemsHTML = quizLengths.map(len => {
                    const isSelected = len === quizLength ? 'selected' : '';
                    return `<div class="selection-item p-3 rounded-md cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${isSelected}" data-value="${len}">
                                ${len === 'All' ? 'All Questions' : `${len} Questions`}
                            </div>`;
                }).join('');
                
            } else if (type === 'bodyFont' || type === 'titleFont') {
                const fontList = fonts[type];
                const currentFont = document.documentElement.style.getPropertyValue(`--font-${type === 'bodyFont' ? 'body' : 'title'}`);
                title = `Select ${type === 'bodyFont' ? 'Body' : 'Title'} Font`;
                itemsHTML = fontList.map(font => {
                    const isSelected = font.value === currentFont ? 'selected' : '';
                    return `<div class="selection-item p-3 rounded-md cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${isSelected}" data-value="${font.value}" style="font-family: ${font.value};">
                                ${font.name}
                            </div>`;
                }).join('');
                
            } else if (type === 'color') {
                const currentColor = document.documentElement.style.getPropertyValue('--color-primary');
                title = 'Select Theme Color';
                itemsHTML = colors.map(color => {
                    const isSelected = color.value === currentColor ? 'selected' : '';
                    return `<div class="selection-item p-3 rounded-md cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${isSelected}" data-value="${color.value}">
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 rounded-full" style="background-color: ${color.value}"></div>
                                    <span>${color.name}</span>
                                </div>
                            </div>`;
                }).join('');
            }

            selectionModalTitle.textContent = title;
            selectionModalContent.innerHTML = itemsHTML;
            
            // Add click listeners to new items
            selectionModalContent.querySelectorAll('.selection-item').forEach(item => {
                item.addEventListener('click', () => {
                    handleSelection(item.dataset.value);
                });
            });
            
            selectionModal.classList.remove('hidden');
            selectionModal.classList.add('flex');
        }

        function handleSelection(value) {
            if (currentSelectionType === 'class') {
                updateClass(parseInt(value));
            } else if (currentSelectionType === 'count') {
                updateLength(value === 'All' ? 'All' : parseInt(value));
            } else if (currentSelectionType === 'bodyFont') {
                applyFont('body', value);
            } else if (currentSelectionType === 'titleFont') {
                applyFont('title', value);
            } else if (currentSelectionType === 'color') {
                applyColor(value);
            }
            closeSelectionModal();
        }
        
        function updateClass(newClass) {
            currentClass = newClass;
            setupQuizUI();
        }
        
        function updateLength(newLength) {
            quizLength = newLength;
            setupQuizUI();
        }

        function closeSelectionModal() {
            selectionModal.classList.add('hidden');
            selectionModal.classList.remove('flex');
        }
        
        function openSettingsModal() {
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
        }
        
        function closeSettingsModal() {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        }
        
        function openCurriculumModal() {
            curriculumModal.classList.remove('hidden');
            curriculumModal.classList.add('flex');
        }
        
        function closeCurriculumModal() {
            curriculumModal.classList.add('hidden');
            curriculumModal.classList.remove('flex');
        }
        
        // --- NEW: Diagram Modal Functions ---
        function openDiagramModal() {
            if (!window.DIAGRAM_DATA) {
                console.error("diagram_data.js not loaded or DIAGRAM_DATA is missing.");
                return;
            }
            
            const diagramData = window.DIAGRAM_DATA[currentClass];
            if (!diagramData) {
                console.error(`No diagram data found for class ${currentClass}`);
                return;
            }
            
            diagramModalContent.innerHTML = ''; // Clear previous
            diagramModalTabs.innerHTML = ''; // Clear tabs
            
            if (Array.isArray(diagramData)) {
                // Multi-diagram lesson
                currentDiagrams = diagramData;
                diagramModalTabs.classList.remove('hidden');
                diagramData.forEach((diag, index) => {
                    const tab = document.createElement('button');
                    tab.textContent = diag.title.split('(')[1] || `Diagram ${index + 1}`;
                    tab.classList.add('diagram-tab', 'p-2', 'rounded-md', 'text-sm');
                    if (index === 0) {
                        tab.classList.add('btn-primary');
                    } else {
                        tab.classList.add('btn-secondary');
                    }
                    tab.dataset.index = index;
                    tab.addEventListener('click', () => renderDiagramTab(index));
                    diagramModalTabs.appendChild(tab);
                });
                renderDiagram(diagramData[0]); // Render first diagram
            } else {
                // Single diagram lesson
                currentDiagrams = [];
                diagramModalTabs.classList.add('hidden');
                renderDiagram(diagramData);
            }
            
            diagramModal.classList.remove('hidden');
            diagramModal.classList.add('flex');
        }
        
        function closeDiagramModal() {
            diagramModal.classList.add('hidden');
            diagramModal.classList.remove('flex');
            diagramModalContent.innerHTML = ''; // Clear content
        }
        
        function renderDiagramTab(index) {
            // Update tab styles
            diagramModalTabs.querySelectorAll('.diagram-tab').forEach((tab, i) => {
                tab.classList.toggle('btn-primary', i === index);
                tab.classList.toggle('btn-secondary', i !== index);
            });
            // Render the selected diagram
            renderDiagram(currentDiagrams[index]);
        }
        
        function renderDiagram(data) {
            if (!data) return;
            
            diagramModalTitle.textContent = data.title || 'Lesson Diagram';
            
            const diagramContainer = document.createElement('div');
            diagramContainer.id = 'diagram-render-area';
            diagramContainer.className = 'relative w-full min-h-[300px]';
            
            // 1. Create SVG layer (will be in the back)
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.id = 'diagram-svg-layer';
            svg.setAttribute('class', 'absolute top-0 left-0 w-full h-full');
            svg.style.zIndex = '0';
            diagramContainer.appendChild(svg);
            
            // 2. Create HTML nodes
            const nodesContainer = document.createElement('div');
            nodesContainer.className = 'relative z-10 flex space-x-4 p-4';
            
            data.columns.forEach(column => {
                const colDiv = document.createElement('div');
                colDiv.className = 'flex flex-col items-center space-y-4 flex-1';
                
                // Add column title
                const colTitle = document.createElement('h4');
                colTitle.className = 'diagram-column-title';
                colTitle.textContent = column.title;
                colDiv.appendChild(colTitle);
                
                // Add nodes
                column.items.forEach(item => {
                    const node = document.createElement('div');
                    node.id = `diag-node-${item.id}`; // Unique ID for drawing lines
                    node.className = 'diagram-node';
                    node.textContent = item.text;
                    colDiv.appendChild(node);
                });
                nodesContainer.appendChild(colDiv);
            });
            
            diagramContainer.appendChild(nodesContainer);
            diagramModalContent.innerHTML = ''; // Clear
            diagramModalContent.appendChild(diagramContainer);
            
            // 3. Draw connection lines
            // We need to wait for the DOM to render to get node positions
            requestAnimationFrame(() => {
                drawConnections(data.connections, diagramContainer, svg);
            });
        }
        
        function drawConnections(connections, container, svg) {
            if (!connections) return;
            
            const containerRect = container.getBoundingClientRect();
            
            connections.forEach(conn => {
                const fromNode = document.getElementById(`diag-node-${conn.from}`);
                const toNode = document.getElementById(`diag-node-${conn.to}`);
                
                if (!fromNode || !toNode) {
                    console.warn(`Could not find nodes for connection: ${conn.from} -> ${conn.to}`);
                    return;
                }
                
                const fromRect = fromNode.getBoundingClientRect();
                const toRect = toNode.getBoundingClientRect();
                
                // Calculate coordinates relative to the container
                // From: middle-right edge
                const x1 = fromRect.right - containerRect.left;
                const y1 = fromRect.top - containerRect.top + fromRect.height / 2;
                
                // To: middle-left edge
                const x2 = toRect.left - containerRect.left;
                const y2 = toRect.top - containerRect.top + toRect.height / 2;
                
                // Create an SVG path (simple Bezier curve)
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midX = (x1 + x2) / 2;
                const d = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                
                path.setAttribute('d', d);
                path.setAttribute('class', 'diagram-svg-line');
                svg.appendChild(path);
            });
        }

        // --- Theming & Styles ---

        function loadInitialSettings() {
            // Theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                applyTheme(true);
            } else if (savedTheme === 'light') {
                applyTheme(false);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme(true);
            } else {
                applyTheme(false);
            }
            
            // Font
            const savedBodyFont = localStorage.getItem('bodyFont');
            if (savedBodyFont) applyFont('body', savedBodyFont);
            
            const savedTitleFont = localStorage.getItem('titleFont');
            if (savedTitleFont) applyFont('title', savedTitleFont);
            
            // Color
            const savedColor = localStorage.getItem('themeColor');
            if (savedColor) applyColor(savedColor);
            
            // Quiz settings
            const savedClass = localStorage.getItem('currentClass');
            if (savedClass) currentClass = parseInt(savedClass);
            
            const savedLength = localStorage.getItem('quizLength');
            if (savedLength) quizLength = savedLength === 'All' ? 'All' : parseInt(savedLength);
        }

        function applyTheme(isDarkTheme) {
            isDark = isDarkTheme;
            if (isDark) {
                document.documentElement.classList.add('dark');
                themeIconLight.classList.add('hidden');
                themeIconDark.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconLight.classList.remove('hidden');
                themeIconDark.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
        }
        
        function applyFont(type, fontValue) {
            const prop = type === 'body' ? '--font-body' : '--font-title';
            document.documentElement.style.setProperty(prop, fontValue);
            localStorage.setItem(type === 'body' ? 'bodyFont' : 'titleFont', fontValue);
            
            // Update settings modal text
            const font = fonts[type === 'body' ? 'bodyFont' : 'titleFont'].find(f => f.value === fontValue);
            if (font) {
                (type === 'body' ? bodyFontName : titleFontName).textContent = font.name;
            }
        }
        
        function applyColor(colorValue) {
            const color = colors.find(c => c.value === colorValue);
            if (!color) return;
            
            const root = document.documentElement;
            root.style.setProperty('--color-primary', color.value);
            root.style.setProperty('--color-primary-hover', color.hover);
            root.style.setProperty('--color-primary-text', isDark ? '#1F2937' : '#FFFFFF');
            
            // Set dark theme variations
            const darkRoot = document.querySelector(':root .dark, .dark');
            if (darkRoot) {
                 root.style.setProperty('--color-primary', isDark ? color.dark : color.value);
                 root.style.setProperty('--color-primary-hover', isDark ? color.darkHover : color.hover);
            } else {
                 // Fallback if dark class is not on root
                 root.style.setProperty('--color-primary', color.value);
                 root.style.setProperty('--color-primary-hover', color.hover);
            }
            
            localStorage.setItem('themeColor', color.value);
            colorName.textContent = color.name;
        }

        // --- Audio ---
        function setupAudio() {
            // Warm up Tone.js on any user interaction
            const warmUp = () => {
                Tone.start();
                document.body.removeEventListener('click', warmUp);
                document.body.removeEventListener('keydown', warmUp);
            };
            document.body.addEventListener('click', warmUp);
            document.body.addEventListener('keydown', warmUp);
        }

        function speak(text, lang) {
            if (!synth || !text) return;
            
            // Stop any previous speech
            synth.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang || 'en-US';
            
            // Try to find a matching voice
            const voices = synth.getVoices();
            let selectedVoice = voices.find(v => v.lang === lang);
            
            // Fallbacks
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith(lang.split('-')[0]));
            }
            if (!selectedVoice && lang === 'te-IN') {
                 selectedVoice = voices.find(v => v.lang.startsWith('en-IN')); // Indian English as fallback for Telugu
            }
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith('en-')); // Any English
            }
            
            utterance.voice = selectedVoice || voices[0];
            
            synth.speak(utterance);
        }
        
        // Ensure voices are loaded
        synth.getVoices();
        if (synth.onvoiceschanged !== undefined) {
          synth.onvoiceschanged = synth.getVoices;
        }

    </script>
</body>
</html>



